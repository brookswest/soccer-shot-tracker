<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intent Soccer - Shot Tracker</title>
    <link rel="icon" type="image/svg+xml" href="intent-soccer-crest-ball-only-final.svg">
    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0fdf4',
                            100: '#dcfce7',
                            200: '#bbf7d0',
                            300: '#86efac',
                            400: '#4ade80',
                            500: '#22c55e',
                            600: '#16a34a',
                            700: '#15803d',
                            800: '#166534',
                            900: '#14532d',
                        }
                    },
                    fontFamily: {
                        mono: ['SF Mono', 'Monaco', 'Consolas', 'monospace'],
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom styles that Tailwind can't handle */
        @keyframes pulse-dot {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-pulse-dot {
            animation: pulse-dot 1.5s infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin-slow {
            animation: spin 1s linear infinite;
        }
        /* Color picker styling */
        .color-picker::-webkit-color-swatch-wrapper { padding: 0; }
        .color-picker::-webkit-color-swatch { border: none; border-radius: 6px; }
        .color-picker::-moz-color-swatch { border: none; border-radius: 6px; }
        /* Scrollbar styling */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        /* Dark mode scrollbar */
        .dark .custom-scrollbar::-webkit-scrollbar-track { background: #1e293b; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #64748b; }
        /* Dark mode body background */
        html.dark { background-color: #0f172a; }
    </style>
</head>
<body class="bg-slate-100 dark:bg-slate-900 min-h-screen font-sans text-slate-800 dark:text-slate-200 antialiased">
    <!-- ===== Authentication Screen ===== -->
    <div id="auth-container" class="min-h-screen flex flex-col items-center justify-center p-5 bg-gradient-to-br from-slate-100 to-slate-200 dark:from-slate-900 dark:to-slate-800">
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl p-8 sm:p-10 w-full max-w-md">
            <div class="text-center mb-8">
                <img src="intent-soccer-crest-ball-only-final.svg" alt="Intent Soccer" class="w-20 h-auto mx-auto mb-4">
                <img src="intent-soccer-text-only-final.svg" alt="Intent Soccer" class="h-12 mx-auto mb-3">
                <p class="text-slate-500 dark:text-slate-400 mt-2">Track shots and save game statistics</p>
            </div>

            <!-- Loading state while checking auth -->
            <div id="auth-loading" class="show text-center py-10">
                <div class="w-10 h-10 border-3 border-slate-200 dark:border-slate-600 border-t-emerald-500 rounded-full animate-spin-slow mx-auto mb-4" style="border-width: 3px;"></div>
                <p class="text-slate-500 dark:text-slate-400">Loading...</p>
            </div>

            <!-- Auth form (hidden while loading) -->
            <div id="auth-form-container" style="display: none;">
                <!-- Login/Signup tabs -->
                <div class="flex bg-slate-100 dark:bg-slate-700 rounded-xl p-1 mb-6">
                    <button class="auth-tab active flex-1 py-3 px-4 rounded-lg text-sm font-semibold transition-all duration-200 bg-white dark:bg-slate-600 text-emerald-600 dark:text-emerald-400 shadow-sm" id="login-tab" onclick="switchAuthTab('login')">Log In</button>
                    <button class="auth-tab flex-1 py-3 px-4 rounded-lg text-sm font-semibold transition-all duration-200 text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200" id="signup-tab" onclick="switchAuthTab('signup')">Sign Up</button>
                </div>

                <!-- Error/Success messages -->
                <div id="auth-error" class="hidden bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800 text-red-600 dark:text-red-400 px-4 py-3 rounded-xl text-sm mb-4"></div>
                <div id="auth-success" class="hidden bg-emerald-50 dark:bg-emerald-900/30 border border-emerald-200 dark:border-emerald-800 text-emerald-600 dark:text-emerald-400 px-4 py-3 rounded-xl text-sm mb-4"></div>

                <!-- Login Form -->
                <form id="login-form" class="flex flex-col gap-4" onsubmit="handleLogin(event)">
                    <input type="email" id="login-email" class="w-full px-4 py-3.5 border-2 border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-xl text-base transition-all duration-200 focus:outline-none focus:border-emerald-500 focus:ring-4 focus:ring-emerald-500/10" placeholder="Email address" required>
                    <input type="password" id="login-password" class="w-full px-4 py-3.5 border-2 border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-xl text-base transition-all duration-200 focus:outline-none focus:border-emerald-500 focus:ring-4 focus:ring-emerald-500/10" placeholder="Password" required>
                    <button type="submit" class="w-full py-3.5 bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-600 hover:to-emerald-700 text-white font-semibold rounded-xl transition-all duration-200 shadow-lg shadow-emerald-500/25 hover:shadow-emerald-500/40 active:scale-[0.98]" id="login-btn">Log In</button>
                </form>

                <!-- Signup Form (hidden by default) -->
                <form id="signup-form" class="flex flex-col gap-4" style="display: none;" onsubmit="handleSignup(event)">
                    <input type="email" id="signup-email" class="w-full px-4 py-3.5 border-2 border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-xl text-base transition-all duration-200 focus:outline-none focus:border-emerald-500 focus:ring-4 focus:ring-emerald-500/10" placeholder="Email address" required>
                    <input type="password" id="signup-password" class="w-full px-4 py-3.5 border-2 border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-xl text-base transition-all duration-200 focus:outline-none focus:border-emerald-500 focus:ring-4 focus:ring-emerald-500/10" placeholder="Password (min 6 characters)" minlength="6" required>
                    <input type="password" id="signup-confirm" class="w-full px-4 py-3.5 border-2 border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-xl text-base transition-all duration-200 focus:outline-none focus:border-emerald-500 focus:ring-4 focus:ring-emerald-500/10" placeholder="Confirm password" minlength="6" required>
                    <button type="submit" class="w-full py-3.5 bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-600 hover:to-emerald-700 text-white font-semibold rounded-xl transition-all duration-200 shadow-lg shadow-emerald-500/25 hover:shadow-emerald-500/40 active:scale-[0.98]" id="signup-btn">Create Account</button>
                </form>
            </div>

            <div class="text-center mt-8 pt-6 border-t border-slate-200 dark:border-slate-700 text-slate-500 dark:text-slate-400">
                <p class="text-lg italic font-medium">This app inspired by Coach Adolpho</p>
                <p class="text-xs mt-1" id="version-auth"></p>
            </div>
        </div>
    </div>

    <!-- ===== Main App (hidden until authenticated) ===== -->
    <div id="app-wrapper" class="hidden">
        <header class="bg-gradient-to-br from-emerald-500 to-emerald-600 pb-20">
            <!-- User bar with profile button -->
            <div class="flex items-center justify-end px-5 py-2 bg-black/10">
                <button onclick="openProfileModal()" class="flex items-center gap-2 bg-white/10 hover:bg-white/20 text-white px-3 py-1.5 rounded-lg transition-colors">
                    <div id="user-avatar" class="w-7 h-7 bg-white/30 rounded-full flex items-center justify-center text-sm font-semibold">
                        U
                    </div>
                    <span class="text-sm" id="user-email"></span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 opacity-70" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                    </svg>
                </button>
            </div>
            <div class="text-center pt-4 px-5">
                <div class="flex items-center justify-center gap-3 mb-2">
                    <img src="intent-soccer-crest-ball-only-final.svg" alt="Intent Soccer Crest" class="h-14 w-auto">
                    <img src="intent-soccer-text-only-final.svg" alt="Intent Soccer" class="h-14 brightness-0 invert">
                </div>
                <p class="text-white/80 text-sm">Track shots and save game statistics</p>
            </div>
        </header>

        <div class="max-w-4xl mx-auto px-4 -mt-14 pb-10">
            <nav id="main-nav" class="flex bg-white dark:bg-slate-800 rounded-2xl p-1.5 mb-6 shadow-lg" style="display: none;">
                <button class="nav-tab active flex-1 py-3 px-5 rounded-xl text-sm font-semibold transition-all duration-200 bg-emerald-500 text-white shadow-sm" onclick="switchView('game')">Current Game</button>
                <button class="nav-tab flex-1 py-3 px-5 rounded-xl text-sm font-semibold transition-all duration-200 text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200 hover:bg-slate-50 dark:hover:bg-slate-700" onclick="switchView('history')">Game History</button>
            </nav>

            <!-- Current Game View -->
            <div id="game-view" class="view hidden">
                <!-- Hidden inputs (keep for existing JS references) -->
                <input type="hidden" id="game-date">
                <input type="hidden" id="home-team-input">
                <input type="hidden" id="home-color" value="#10b981">
                <input type="hidden" id="away-team-input">
                <input type="hidden" id="away-color" value="#3b82f6">

                <!-- Hidden roster state (keep for existing JS references) -->
                <div style="display: none;">
                    <div id="selected-roster-display"><span class="text-slate-400">No roster selected</span></div>
                    <div id="player-tracking-section">
                        <button type="button" id="player-tracking-toggle" class="relative w-12 h-7 bg-slate-300 rounded-full">
                            <span id="player-tracking-toggle-dot" class="absolute left-1 top-1 w-5 h-5 bg-white rounded-full shadow"></span>
                        </button>
                    </div>
                    <div id="roster-team-assignment">
                        <button type="button" id="roster-team-home-btn" onclick="setRosterTeam('home')">Home</button>
                        <button type="button" id="roster-team-away-btn" onclick="setRosterTeam('away')">Away</button>
                    </div>
                    <button type="button" id="shot-map-toggle">
                        <span id="shot-map-toggle-dot"></span>
                    </button>
                    <button type="button" id="wake-lock-toggle">
                        <span id="wake-lock-toggle-dot"></span>
                    </button>
                </div>

                <!-- Game Summary Bar -->
                <div class="bg-white dark:bg-slate-800 rounded-2xl p-4 mb-5 shadow-lg">
                    <div class="flex items-center justify-between flex-wrap gap-3">
                        <div class="flex items-center gap-3">
                            <button onclick="currentTeamId ? navigateToTeamDashboard(currentTeamId) : navigateToHome()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                                </svg>
                            </button>
                            <div>
                                <div class="text-sm text-slate-400" id="game-date-display"></div>
                                <div class="font-semibold text-slate-800 dark:text-white text-sm" id="game-teams-display"></div>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button type="button" class="half-btn active py-2 px-4 border-2 border-emerald-500 bg-emerald-500 text-white rounded-xl text-sm font-semibold transition-all duration-200" id="half-1-btn" onclick="setHalf(1)">1st Half</button>
                            <button type="button" class="half-btn py-2 px-4 border-2 border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-500 dark:text-slate-300 rounded-xl text-sm font-semibold transition-all duration-200 hover:border-emerald-500 hover:text-emerald-500" id="half-2-btn" onclick="setHalf(2)">2nd Half</button>
                        </div>
                    </div>
                </div>

                <!-- Game Clock -->
                <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-5 mb-5 shadow-lg flex flex-col sm:flex-row items-center justify-between gap-5">
                    <div class="flex items-center gap-4">
                        <div class="text-center">
                            <div class="text-5xl sm:text-6xl font-bold font-mono text-white tracking-tight" id="clock-display">00:00</div>
                            <div class="flex items-center justify-center gap-2 mt-2 text-slate-400 text-sm">
                                <span class="w-2 h-2 rounded-full bg-slate-500" id="clock-status-dot"></span>
                                <span id="clock-status-text">Stopped</span>
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-3">
                        <button class="btn-clock start px-6 py-3 bg-emerald-500 hover:bg-emerald-600 text-white font-semibold rounded-xl transition-all duration-200 shadow-lg" id="clock-start-btn">Start</button>
                        <button class="btn-clock reset px-6 py-3 bg-slate-600 hover:bg-slate-500 text-white font-semibold rounded-xl transition-all duration-200" id="clock-reset-btn">Reset</button>
                    </div>
                </div>

                <!-- Scoreboard -->
                <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-6 sm:p-8 mb-5 shadow-xl">
                    <div class="flex justify-around items-center">
                        <div class="team-score home-team text-center flex-1">
                            <span class="team-badge inline-block px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide bg-emerald-500/20 text-emerald-400 mb-2">Home</span>
                            <div class="team-name text-lg sm:text-xl font-semibold text-white mb-3" id="home-name-display">Home Team</div>
                            <div class="score text-5xl sm:text-6xl font-extrabold text-emerald-400" id="home-score">0</div>
                        </div>
                        <div class="px-4 sm:px-6">
                            <span class="text-slate-500 font-semibold">VS</span>
                        </div>
                        <div class="team-score away-team text-center flex-1">
                            <span class="team-badge inline-block px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide bg-blue-500/20 text-blue-400 mb-2">Away</span>
                            <div class="team-name text-lg sm:text-xl font-semibold text-white mb-3" id="away-name-display">Away Team</div>
                            <div class="score text-5xl sm:text-6xl font-extrabold text-blue-400" id="away-score">0</div>
                        </div>
                    </div>
                </div>

                <!-- Team Panels -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5 mb-5">
                    <!-- Home Team Panel -->
                    <div class="team-panel home bg-white dark:bg-slate-800 rounded-2xl p-6 shadow-lg border-t-4 border-emerald-500">
                        <h2 id="home-panel-title" class="text-lg font-semibold text-emerald-600 dark:text-emerald-400 mb-5 flex items-center gap-2">
                            <span class="w-3 h-3 rounded-full bg-emerald-500"></span>
                            Home Team
                        </h2>
                        <div class="flex flex-col gap-3">
                            <button class="btn btn-goal w-full py-3.5 bg-gradient-to-r from-amber-500 to-amber-600 hover:from-amber-600 hover:to-amber-700 text-white font-semibold rounded-xl transition-all duration-200 shadow-md hover:shadow-lg hover:-translate-y-0.5 active:translate-y-0" onclick="recordShot('home', 'goal')">Goal</button>
                            <button class="btn btn-on-target w-full py-3.5 bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-600 hover:to-emerald-700 text-white font-semibold rounded-xl transition-all duration-200 shadow-md hover:shadow-lg hover:-translate-y-0.5 active:translate-y-0" onclick="recordShot('home', 'on-target')">Shot On Target</button>
                            <button class="btn btn-off-target w-full py-3.5 bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white font-semibold rounded-xl transition-all duration-200 shadow-md hover:shadow-lg hover:-translate-y-0.5 active:translate-y-0" onclick="recordShot('home', 'off-target')">Shot Off Target</button>
                        </div>
                        <div class="mt-5 pt-5 border-t border-slate-200 dark:border-slate-700">
                            <div class="flex justify-between py-2.5 border-b border-slate-100 dark:border-slate-700">
                                <span class="text-slate-500 dark:text-slate-400 text-sm">Goals</span>
                                <span class="font-semibold text-slate-800 dark:text-white" id="home-goals">0</span>
                            </div>
                            <div class="flex justify-between py-2.5 border-b border-slate-100 dark:border-slate-700">
                                <span class="text-slate-500 dark:text-slate-400 text-sm">Shots On Target</span>
                                <span class="font-semibold text-slate-800 dark:text-white" id="home-on-target">0</span>
                            </div>
                            <div class="flex justify-between py-2.5 border-b border-slate-100 dark:border-slate-700">
                                <span class="text-slate-500 dark:text-slate-400 text-sm">Shots Off Target</span>
                                <span class="font-semibold text-slate-800 dark:text-white" id="home-off-target">0</span>
                            </div>
                            <div class="flex justify-between py-2.5 border-b border-slate-100 dark:border-slate-700">
                                <span class="text-slate-500 dark:text-slate-400 text-sm">Total Shots</span>
                                <span class="font-semibold text-slate-800 dark:text-white" id="home-total">0</span>
                            </div>
                            <div class="flex justify-between py-2.5">
                                <span class="text-slate-500 dark:text-slate-400 text-sm">Shot Accuracy</span>
                                <span class="font-semibold text-emerald-600 dark:text-emerald-400" id="home-accuracy">0%</span>
                            </div>
                        </div>
                        <div class="half-breakdown mt-4 pt-4 border-t border-slate-200 dark:border-slate-700">
                            <div class="text-xs font-semibold text-slate-400 uppercase tracking-wide mb-3">By Half</div>
                            <div class="grid grid-cols-2 gap-3">
                                <div class="bg-slate-50 dark:bg-slate-700 rounded-xl p-3">
                                    <h4 class="text-xs font-semibold text-slate-400 uppercase mb-2">1st Half</h4>
                                    <div class="flex justify-between text-xs py-1"><span class="text-slate-400">Goals</span><span class="font-semibold text-slate-700 dark:text-slate-200" id="home-h1-goals">0</span></div>
                                    <div class="flex justify-between text-xs py-1"><span class="text-slate-400">On Target</span><span class="font-semibold text-slate-700 dark:text-slate-200" id="home-h1-on-target">0</span></div>
                                    <div class="flex justify-between text-xs py-1"><span class="text-slate-400">Off Target</span><span class="font-semibold text-slate-700 dark:text-slate-200" id="home-h1-off-target">0</span></div>
                                </div>
                                <div class="bg-slate-50 dark:bg-slate-700 rounded-xl p-3">
                                    <h4 class="text-xs font-semibold text-slate-400 uppercase mb-2">2nd Half</h4>
                                    <div class="flex justify-between text-xs py-1"><span class="text-slate-400">Goals</span><span class="font-semibold text-slate-700 dark:text-slate-200" id="home-h2-goals">0</span></div>
                                    <div class="flex justify-between text-xs py-1"><span class="text-slate-400">On Target</span><span class="font-semibold text-slate-700 dark:text-slate-200" id="home-h2-on-target">0</span></div>
                                    <div class="flex justify-between text-xs py-1"><span class="text-slate-400">Off Target</span><span class="font-semibold text-slate-700 dark:text-slate-200" id="home-h2-off-target">0</span></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Away Team Panel -->
                    <div class="team-panel away bg-white dark:bg-slate-800 rounded-2xl p-6 shadow-lg border-t-4 border-blue-500">
                        <h2 id="away-panel-title" class="text-lg font-semibold text-blue-600 dark:text-blue-400 mb-5 flex items-center gap-2">
                            <span class="w-3 h-3 rounded-full bg-blue-500"></span>
                            Away Team
                        </h2>
                        <div class="flex flex-col gap-3">
                            <button class="btn btn-goal w-full py-3.5 bg-gradient-to-r from-amber-500 to-amber-600 hover:from-amber-600 hover:to-amber-700 text-white font-semibold rounded-xl transition-all duration-200 shadow-md hover:shadow-lg hover:-translate-y-0.5 active:translate-y-0" onclick="recordShot('away', 'goal')">Goal</button>
                            <button class="btn btn-on-target w-full py-3.5 bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-600 hover:to-emerald-700 text-white font-semibold rounded-xl transition-all duration-200 shadow-md hover:shadow-lg hover:-translate-y-0.5 active:translate-y-0" onclick="recordShot('away', 'on-target')">Shot On Target</button>
                            <button class="btn btn-off-target w-full py-3.5 bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white font-semibold rounded-xl transition-all duration-200 shadow-md hover:shadow-lg hover:-translate-y-0.5 active:translate-y-0" onclick="recordShot('away', 'off-target')">Shot Off Target</button>
                        </div>
                        <div class="mt-5 pt-5 border-t border-slate-200 dark:border-slate-700">
                            <div class="flex justify-between py-2.5 border-b border-slate-100 dark:border-slate-700">
                                <span class="text-slate-500 dark:text-slate-400 text-sm">Goals</span>
                                <span class="font-semibold text-slate-800 dark:text-white" id="away-goals">0</span>
                            </div>
                            <div class="flex justify-between py-2.5 border-b border-slate-100 dark:border-slate-700">
                                <span class="text-slate-500 dark:text-slate-400 text-sm">Shots On Target</span>
                                <span class="font-semibold text-slate-800 dark:text-white" id="away-on-target">0</span>
                            </div>
                            <div class="flex justify-between py-2.5 border-b border-slate-100 dark:border-slate-700">
                                <span class="text-slate-500 dark:text-slate-400 text-sm">Shots Off Target</span>
                                <span class="font-semibold text-slate-800 dark:text-white" id="away-off-target">0</span>
                            </div>
                            <div class="flex justify-between py-2.5 border-b border-slate-100 dark:border-slate-700">
                                <span class="text-slate-500 dark:text-slate-400 text-sm">Total Shots</span>
                                <span class="font-semibold text-slate-800 dark:text-white" id="away-total">0</span>
                            </div>
                            <div class="flex justify-between py-2.5">
                                <span class="text-slate-500 dark:text-slate-400 text-sm">Shot Accuracy</span>
                                <span class="font-semibold text-blue-600 dark:text-blue-400" id="away-accuracy">0%</span>
                            </div>
                        </div>
                        <div class="half-breakdown mt-4 pt-4 border-t border-slate-200 dark:border-slate-700">
                            <div class="text-xs font-semibold text-slate-400 uppercase tracking-wide mb-3">By Half</div>
                            <div class="grid grid-cols-2 gap-3">
                                <div class="bg-slate-50 dark:bg-slate-700 rounded-xl p-3">
                                    <h4 class="text-xs font-semibold text-slate-400 uppercase mb-2">1st Half</h4>
                                    <div class="flex justify-between text-xs py-1"><span class="text-slate-400">Goals</span><span class="font-semibold text-slate-700 dark:text-slate-200" id="away-h1-goals">0</span></div>
                                    <div class="flex justify-between text-xs py-1"><span class="text-slate-400">On Target</span><span class="font-semibold text-slate-700 dark:text-slate-200" id="away-h1-on-target">0</span></div>
                                    <div class="flex justify-between text-xs py-1"><span class="text-slate-400">Off Target</span><span class="font-semibold text-slate-700 dark:text-slate-200" id="away-h1-off-target">0</span></div>
                                </div>
                                <div class="bg-slate-50 dark:bg-slate-700 rounded-xl p-3">
                                    <h4 class="text-xs font-semibold text-slate-400 uppercase mb-2">2nd Half</h4>
                                    <div class="flex justify-between text-xs py-1"><span class="text-slate-400">Goals</span><span class="font-semibold text-slate-700 dark:text-slate-200" id="away-h2-goals">0</span></div>
                                    <div class="flex justify-between text-xs py-1"><span class="text-slate-400">On Target</span><span class="font-semibold text-slate-700 dark:text-slate-200" id="away-h2-on-target">0</span></div>
                                    <div class="flex justify-between text-xs py-1"><span class="text-slate-400">Off Target</span><span class="font-semibold text-slate-700 dark:text-slate-200" id="away-h2-off-target">0</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Shot Log -->
                <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 mb-5 shadow-lg">
                    <div class="flex justify-between items-center mb-5">
                        <h2 class="text-lg font-semibold text-slate-800 dark:text-white">Shot Log</h2>
                        <div class="flex gap-2">
                            <button class="btn btn-outline px-4 py-2 border-2 border-slate-200 dark:border-slate-600 text-slate-500 dark:text-slate-400 rounded-xl text-sm font-semibold transition-all duration-200 hover:border-emerald-500 hover:text-emerald-500 hover:bg-emerald-50 dark:hover:bg-emerald-900/20 disabled:opacity-50 disabled:cursor-not-allowed" id="view-shot-map-btn" onclick="viewShotMap()" disabled>View Shot Map</button>
                            <button class="btn btn-outline px-4 py-2 border-2 border-slate-200 dark:border-slate-600 text-slate-500 dark:text-slate-400 rounded-xl text-sm font-semibold transition-all duration-200 hover:border-emerald-500 hover:text-emerald-500 hover:bg-emerald-50 dark:hover:bg-emerald-900/20 disabled:opacity-50 disabled:cursor-not-allowed" id="undo-btn" onclick="undoLastShot()" disabled>Undo</button>
                        </div>
                    </div>
                    <div class="log-entries max-h-60 overflow-y-auto custom-scrollbar" id="log-entries">
                        <div class="empty-state text-center py-10 text-slate-400">
                            <div class="text-5xl mb-3">&#9917;</div>
                            <p>No shots recorded yet</p>
                        </div>
                    </div>
                </div>

                <!-- Notes Section -->
                <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 mb-5 shadow-lg">
                    <h2 class="text-lg font-semibold text-slate-800 dark:text-white mb-5">Game Notes</h2>
                    <div class="flex flex-col sm:flex-row gap-3 mb-4">
                        <input type="text" id="note-input" class="flex-1 px-4 py-3 border-2 border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-xl text-sm transition-all duration-200 focus:outline-none focus:border-emerald-500 focus:ring-4 focus:ring-emerald-500/10" placeholder="Add a note..." onkeypress="if(event.key === 'Enter') addNote()">
                        <button class="px-6 py-3 bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-600 hover:to-emerald-700 text-white font-semibold rounded-xl transition-all duration-200 shadow-md hover:shadow-lg" onclick="addNote()">Add Note</button>
                    </div>
                    <div class="log-entries max-h-60 overflow-y-auto custom-scrollbar" id="notes-entries">
                        <div class="empty-state text-center py-10 text-slate-400">
                            <div class="text-5xl mb-3">&#128221;</div>
                            <p>No notes yet</p>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex flex-col sm:flex-row gap-3">
                    <button class="flex-1 py-4 bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-600 hover:to-emerald-700 text-white font-semibold rounded-xl transition-all duration-200 shadow-lg hover:shadow-xl" onclick="saveGame()">Save Game</button>
                    <button class="flex-1 py-4 bg-slate-200 hover:bg-slate-300 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200 font-semibold rounded-xl transition-all duration-200" onclick="confirmReset()">Reset Game</button>
                </div>
            </div>

            <!-- History View -->
            <div id="history-view" class="view hidden">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6" id="stats-dashboard">
                    <div class="bg-white dark:bg-slate-800 rounded-2xl p-5 text-center shadow-lg border border-slate-100 dark:border-slate-700">
                        <div class="text-3xl font-bold text-emerald-500" id="total-games">0</div>
                        <div class="text-xs font-medium text-slate-500 dark:text-slate-400 mt-2">Games Played</div>
                    </div>
                    <div class="bg-white dark:bg-slate-800 rounded-2xl p-5 text-center shadow-lg border border-slate-100 dark:border-slate-700">
                        <div class="text-3xl font-bold text-emerald-500" id="avg-goals">0</div>
                        <div class="text-xs font-medium text-slate-500 dark:text-slate-400 mt-2">Avg Goals/Game</div>
                    </div>
                    <div class="bg-white dark:bg-slate-800 rounded-2xl p-5 text-center shadow-lg border border-slate-100 dark:border-slate-700">
                        <div class="text-3xl font-bold text-emerald-500" id="total-shots">0</div>
                        <div class="text-xs font-medium text-slate-500 dark:text-slate-400 mt-2">Total Shots</div>
                    </div>
                    <div class="bg-white dark:bg-slate-800 rounded-2xl p-5 text-center shadow-lg border border-slate-100 dark:border-slate-700">
                        <div class="text-3xl font-bold text-emerald-500" id="avg-accuracy">0%</div>
                        <div class="text-xs font-medium text-slate-500 dark:text-slate-400 mt-2">Avg Accuracy</div>
                    </div>
                </div>

                <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 shadow-lg">
                    <h2 class="text-lg font-semibold text-slate-800 dark:text-white mb-5">Saved Games</h2>
                    <div class="game-list flex flex-col gap-3" id="game-list">
                        <div class="empty-state text-center py-10 text-slate-400">
                            <div class="text-5xl mb-3">&#128202;</div>
                            <p>No saved games yet</p>
                            <p class="text-sm mt-2">Save your first game to see it here!</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Home View (Team Selection) -->
            <div id="home-view" class="view hidden">
                <div id="teams-grid" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div class="text-center py-16 text-slate-400 col-span-full">
                        <div class="text-5xl mb-3">&#9917;</div>
                        <p class="font-medium">No teams available</p>
                        <p class="text-sm mt-2">Contact your admin to be added to a team.</p>
                    </div>
                </div>
            </div>

            <!-- Team Dashboard View -->
            <div id="team-view" class="view hidden">
                <!-- Team Header -->
                <div class="bg-white dark:bg-slate-800 rounded-2xl p-5 mb-5 shadow-lg">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <button onclick="navigateToHome()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                                </svg>
                            </button>
                            <div class="flex items-center gap-2">
                                <span id="team-color-dot" class="w-4 h-4 rounded-full bg-emerald-500"></span>
                                <h2 id="team-name-display" class="text-lg font-semibold text-slate-800 dark:text-white">Team Name</h2>
                                <button onclick="openEditTeamModal()" class="text-slate-400 hover:text-emerald-500 transition-colors p-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <button onclick="navigateToGameSetup()" class="px-5 py-2.5 bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-600 hover:to-emerald-700 text-white font-semibold rounded-xl transition-all duration-200 shadow-md hover:shadow-lg text-sm">
                            Start Game
                        </button>
                    </div>
                </div>

                <!-- Team Tabs -->
                <div class="flex bg-white dark:bg-slate-800 rounded-2xl p-1.5 mb-6 shadow-lg">
                    <button class="team-tab active flex-1 py-3 px-5 rounded-xl text-sm font-semibold transition-all duration-200 bg-emerald-500 text-white shadow-sm" onclick="switchTeamTab('history')">Game History</button>
                    <button class="team-tab flex-1 py-3 px-5 rounded-xl text-sm font-semibold transition-all duration-200 text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200 hover:bg-slate-50 dark:hover:bg-slate-700" onclick="switchTeamTab('roster')">Roster</button>
                </div>

                <!-- Team History Tab -->
                <div id="team-history-tab">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6" id="team-stats-dashboard">
                        <div class="bg-white dark:bg-slate-800 rounded-2xl p-5 text-center shadow-lg border border-slate-100 dark:border-slate-700">
                            <div class="text-3xl font-bold text-emerald-500" id="team-total-games">0</div>
                            <div class="text-xs font-medium text-slate-500 dark:text-slate-400 mt-2">Games Played</div>
                        </div>
                        <div class="bg-white dark:bg-slate-800 rounded-2xl p-5 text-center shadow-lg border border-slate-100 dark:border-slate-700">
                            <div class="text-3xl font-bold text-emerald-500" id="team-avg-goals">0</div>
                            <div class="text-xs font-medium text-slate-500 dark:text-slate-400 mt-2">Avg Goals/Game</div>
                        </div>
                        <div class="bg-white dark:bg-slate-800 rounded-2xl p-5 text-center shadow-lg border border-slate-100 dark:border-slate-700">
                            <div class="text-3xl font-bold text-emerald-500" id="team-total-shots">0</div>
                            <div class="text-xs font-medium text-slate-500 dark:text-slate-400 mt-2">Total Shots</div>
                        </div>
                        <div class="bg-white dark:bg-slate-800 rounded-2xl p-5 text-center shadow-lg border border-slate-100 dark:border-slate-700">
                            <div class="text-3xl font-bold text-emerald-500" id="team-avg-accuracy">0%</div>
                            <div class="text-xs font-medium text-slate-500 dark:text-slate-400 mt-2">Avg Accuracy</div>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 shadow-lg">
                        <h2 class="text-lg font-semibold text-slate-800 dark:text-white mb-5">Game History</h2>
                        <div class="game-list flex flex-col gap-3" id="team-game-list">
                            <div class="empty-state text-center py-10 text-slate-400">
                                <div class="text-5xl mb-3">&#128202;</div>
                                <p>No games yet</p>
                                <p class="text-sm mt-2">Start a game to see it here!</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Team Roster Tab -->
                <div id="team-roster-tab" class="hidden">
                    <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 shadow-lg">
                        <div class="flex justify-between items-center mb-5">
                            <h2 class="text-lg font-semibold text-slate-800 dark:text-white">Players</h2>
                            <button onclick="openTeamPlayersModal()" class="px-4 py-2 bg-emerald-500 hover:bg-emerald-600 text-white font-medium rounded-xl transition-colors text-sm flex items-center gap-1.5">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                                </svg>
                                Add Player
                            </button>
                        </div>
                        <div id="team-roster-list">
                            <div class="text-center py-10 text-slate-400">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-12 h-12 mx-auto mb-3 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                                </svg>
                                <p>No players added yet</p>
                                <p class="text-sm mt-1">Add players to your roster</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Game Setup View -->
            <div id="game-setup-view" class="view hidden">
                <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 shadow-lg">
                    <div class="flex items-center gap-3 mb-6">
                        <button onclick="navigateToTeamDashboard(currentTeamId)" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                            </svg>
                        </button>
                        <h2 class="text-lg font-semibold text-slate-800 dark:text-white">Game Setup</h2>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <!-- Game Date -->
                        <div class="space-y-1.5">
                            <label for="setup-game-date" class="text-sm font-medium text-slate-500 dark:text-slate-400">Game Date</label>
                            <input type="date" id="setup-game-date" class="w-full px-4 py-2.5 border-2 border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-xl text-sm transition-all duration-200 focus:outline-none focus:border-emerald-500 focus:ring-4 focus:ring-emerald-500/10">
                        </div>

                        <!-- Spacer for grid alignment -->
                        <div class="hidden sm:block"></div>

                        <!-- Home Team -->
                        <div class="space-y-1.5">
                            <label class="text-sm font-medium text-slate-500 dark:text-slate-400">Home Team</label>
                            <div class="flex gap-2">
                                <input type="text" id="setup-home-team" class="flex-1 px-4 py-2.5 border-2 border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-xl text-sm bg-slate-50 dark:bg-slate-600 cursor-not-allowed" readonly>
                                <input type="color" id="setup-home-color" class="color-picker w-11 h-11 border-2 border-slate-200 dark:border-slate-600 rounded-xl cursor-pointer p-1 bg-white dark:bg-slate-700" value="#10b981" title="Home team color">
                            </div>
                        </div>

                        <!-- Away Team -->
                        <div class="space-y-1.5">
                            <label class="text-sm font-medium text-slate-500 dark:text-slate-400">Away Team</label>
                            <div class="flex gap-2">
                                <input type="text" id="setup-away-team" class="flex-1 px-4 py-2.5 border-2 border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-xl text-sm transition-all duration-200 focus:outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10" placeholder="Away Team">
                                <input type="color" id="setup-away-color" class="color-picker w-11 h-11 border-2 border-slate-200 dark:border-slate-600 rounded-xl cursor-pointer p-1 bg-white dark:bg-slate-700" value="#3b82f6" title="Away team color">
                            </div>
                        </div>

                        <!-- Shot Map Toggle -->
                        <div class="sm:col-span-2 mt-2 pt-4 border-t border-slate-200 dark:border-slate-700">
                            <div class="flex items-center justify-between">
                                <div>
                                    <label class="text-sm font-medium text-slate-700 dark:text-slate-200">Shot Map</label>
                                    <p class="text-xs text-slate-400 mt-0.5">Record shot locations on the field</p>
                                </div>
                                <button type="button" id="setup-shot-map-toggle" onclick="toggleSetupShotMap()" class="relative w-12 h-7 bg-slate-300 dark:bg-slate-600 rounded-full transition-colors duration-200 focus:outline-none focus:ring-4 focus:ring-emerald-500/20">
                                    <span id="setup-shot-map-toggle-dot" class="absolute left-1 top-1 w-5 h-5 bg-white rounded-full shadow transition-transform duration-200"></span>
                                </button>
                            </div>
                        </div>

                        <!-- Wake Lock Toggle -->
                        <div class="sm:col-span-2 mt-3 pt-3 border-t border-slate-100 dark:border-slate-700">
                            <div class="flex items-center justify-between">
                                <div>
                                    <label class="text-sm font-medium text-slate-700 dark:text-slate-200">Keep Screen On</label>
                                    <p class="text-xs text-slate-400 mt-0.5">Prevent screen from dimming</p>
                                </div>
                                <button type="button" id="setup-wake-lock-toggle" onclick="toggleSetupWakeLock()" class="relative w-12 h-7 bg-slate-300 dark:bg-slate-600 rounded-full transition-colors duration-200 focus:outline-none focus:ring-4 focus:ring-emerald-500/20">
                                    <span id="setup-wake-lock-toggle-dot" class="absolute left-1 top-1 w-5 h-5 bg-white rounded-full shadow transition-transform duration-200"></span>
                                </button>
                            </div>
                        </div>

                        <!-- Player Tracking Toggle -->
                        <div class="sm:col-span-2 mt-3 pt-3 border-t border-slate-100 dark:border-slate-700">
                            <div class="flex items-center justify-between">
                                <div>
                                    <label class="text-sm font-medium text-slate-700 dark:text-slate-200">Track Goal Scorers</label>
                                    <p class="text-xs text-slate-400 mt-0.5">Select player when recording goals</p>
                                </div>
                                <button type="button" id="setup-player-tracking-toggle" onclick="toggleSetupPlayerTracking()" class="relative w-12 h-7 bg-slate-300 dark:bg-slate-600 rounded-full transition-colors duration-200 focus:outline-none focus:ring-4 focus:ring-emerald-500/20">
                                    <span id="setup-player-tracking-toggle-dot" class="absolute left-1 top-1 w-5 h-5 bg-white rounded-full shadow transition-transform duration-200"></span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="setup-error" class="hidden mt-4 bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800 text-red-600 dark:text-red-400 px-4 py-3 rounded-xl text-sm"></div>

                    <button onclick="startGameFromSetup()" class="w-full mt-6 py-4 bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-600 hover:to-emerald-700 text-white font-semibold rounded-xl transition-all duration-200 shadow-lg hover:shadow-xl text-lg">
                        Start Game
                    </button>
                </div>
            </div>
        </div>

        <footer class="text-center py-6 text-slate-500 dark:text-slate-400">
            <p class="text-lg italic font-medium">This app inspired by Coach Adolpho</p>
            <p class="text-xs mt-1" id="version-app"></p>
        </footer>

        <!-- Team Edit/Create Modal -->
        <div class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4" id="team-modal-overlay" onclick="if(event.target === this) closeTeamModal()">
            <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 max-w-sm w-full shadow-2xl">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-slate-800 dark:text-white" id="team-modal-title">Create Team</h3>
                    <button onclick="closeTeamModal()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <input type="hidden" id="team-modal-id">
                <div class="space-y-4">
                    <div>
                        <label class="text-sm font-medium text-slate-600 dark:text-slate-400 block mb-1.5">Team Name</label>
                        <input type="text" id="team-modal-name" class="w-full px-4 py-2.5 border-2 border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-xl text-sm transition-all duration-200 focus:outline-none focus:border-emerald-500 focus:ring-4 focus:ring-emerald-500/10" placeholder="e.g., U12 Eagles">
                    </div>
                    <div>
                        <label class="text-sm font-medium text-slate-600 dark:text-slate-400 block mb-1.5">Team Color</label>
                        <div class="flex items-center gap-3">
                            <input type="color" id="team-modal-color" class="color-picker w-11 h-11 border-2 border-slate-200 dark:border-slate-600 rounded-xl cursor-pointer p-1 bg-white dark:bg-slate-700" value="#10b981">
                            <div id="team-modal-color-preview" class="flex-1 h-11 rounded-xl" style="background-color: #10b981;"></div>
                        </div>
                    </div>
                    <div id="team-modal-error" class="hidden bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800 text-red-600 dark:text-red-400 px-4 py-2 rounded-xl text-sm"></div>
                </div>
                <div class="flex gap-3 mt-6">
                    <button onclick="closeTeamModal()" class="flex-1 py-2.5 bg-slate-100 hover:bg-slate-200 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200 font-medium rounded-xl transition-colors">Cancel</button>
                    <button onclick="saveTeamModal()" id="team-modal-save-btn" class="flex-1 py-2.5 bg-emerald-500 hover:bg-emerald-600 text-white font-semibold rounded-xl transition-colors">Create</button>
                </div>
                <!-- Delete button (only shown when editing) -->
                <button onclick="confirmDeleteTeam()" id="team-modal-delete-btn" class="hidden w-full mt-3 py-2.5 border-2 border-red-200 dark:border-red-800 text-red-500 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 font-medium rounded-xl transition-colors">
                    Delete Team
                </button>
            </div>
        </div>

        <!-- Confirmation Modal -->
        <div class="modal-overlay fixed inset-0 bg-black/50 z-50 hidden items-center justify-center" id="modal-overlay">
            <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 max-w-sm w-11/12 shadow-2xl">
                <h3 class="text-lg font-semibold text-slate-800 dark:text-white mb-3" id="modal-title">Confirm Action</h3>
                <p class="text-slate-500 dark:text-slate-400 mb-6" id="modal-message">Are you sure you want to proceed?</p>
                <div class="flex gap-3 justify-end">
                    <button class="px-5 py-2.5 bg-slate-200 hover:bg-slate-300 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200 font-semibold rounded-xl transition-all duration-200" onclick="closeModal()">Cancel</button>
                    <button class="px-5 py-2.5 bg-red-500 hover:bg-red-600 text-white font-semibold rounded-xl transition-all duration-200" id="modal-confirm">Confirm</button>
                </div>
            </div>
        </div>

        <!-- Profile Modal -->
        <div class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center" id="profile-modal-overlay" onclick="if(event.target === this) closeProfileModal()">
            <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 max-w-sm w-11/12 shadow-2xl">
                <!-- Header -->
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-semibold text-slate-800 dark:text-white">Profile</h3>
                    <button onclick="closeProfileModal()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <!-- User Info -->
                <div class="flex items-center gap-4 mb-6 pb-6 border-b border-slate-200 dark:border-slate-700">
                    <div id="profile-avatar" class="w-14 h-14 bg-emerald-500 rounded-full flex items-center justify-center text-2xl font-bold text-white">
                        U
                    </div>
                    <div>
                        <p class="text-slate-800 dark:text-white font-medium" id="profile-email">user@example.com</p>
                        <p class="text-sm text-slate-500 dark:text-slate-400">Logged in</p>
                    </div>
                </div>

                <!-- Theme Toggle -->
                <div class="flex items-center justify-between mb-6 pb-6 border-b border-slate-200 dark:border-slate-700">
                    <div class="flex items-center gap-3">
                        <!-- Sun icon (light mode) -->
                        <svg id="theme-icon-sun" xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-amber-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                        </svg>
                        <!-- Moon icon (dark mode) -->
                        <svg id="theme-icon-moon" xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-indigo-400 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                        </svg>
                        <span class="text-slate-700 dark:text-slate-200 font-medium">Dark Mode</span>
                    </div>
                    <button type="button" id="theme-toggle" onclick="toggleTheme()" class="relative w-12 h-7 bg-slate-300 dark:bg-emerald-500 rounded-full transition-colors duration-200 focus:outline-none focus:ring-4 focus:ring-emerald-500/20">
                        <span id="theme-toggle-dot" class="absolute left-1 top-1 w-5 h-5 bg-white rounded-full shadow transition-transform duration-200"></span>
                    </button>
                </div>

                <!-- Password Reset -->
                <div class="mb-6 pb-6 border-b border-slate-200 dark:border-slate-700">
                    <div class="flex items-center gap-3 mb-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-slate-500 dark:text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
                        </svg>
                        <span class="text-slate-700 dark:text-slate-200 font-medium">Password</span>
                    </div>
                    <button onclick="handlePasswordReset()" id="password-reset-btn" class="w-full py-2.5 bg-slate-100 hover:bg-slate-200 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200 font-medium rounded-xl transition-all duration-200">
                        Send Password Reset Email
                    </button>
                    <div id="password-reset-error" class="hidden mt-3 bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800 text-red-600 dark:text-red-400 px-4 py-2 rounded-xl text-sm"></div>
                    <div id="password-reset-success" class="hidden mt-3 bg-emerald-50 dark:bg-emerald-900/30 border border-emerald-200 dark:border-emerald-800 text-emerald-600 dark:text-emerald-400 px-4 py-2 rounded-xl text-sm"></div>
                </div>

                <!-- Logout Button -->
                <button onclick="handleLogout(); closeProfileModal();" class="w-full py-2.5 bg-red-500 hover:bg-red-600 text-white font-semibold rounded-xl transition-all duration-200">
                    Log Out
                </button>
            </div>
        </div>

        <!-- Rosters List Modal -->
        <div class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4" id="rosters-modal-overlay" onclick="if(event.target === this) closeRostersModal()">
            <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 max-w-md w-full shadow-2xl max-h-[90vh] overflow-hidden flex flex-col">
                <!-- Header -->
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center gap-2">
                        <h3 class="text-lg font-semibold text-slate-800 dark:text-white">My Rosters</h3>
                        <span class="px-1.5 py-0.5 bg-amber-100 dark:bg-amber-900/50 text-amber-700 dark:text-amber-400 text-[10px] font-bold uppercase rounded">BETA</span>
                    </div>
                    <button onclick="closeRostersModal()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <!-- Create Roster Form -->
                <div class="mb-4 pb-4 border-b border-slate-200 dark:border-slate-700">
                    <div class="flex gap-2">
                        <input type="text" id="roster-name-input" class="flex-1 px-3 py-2 border-2 border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg text-sm transition-all duration-200 focus:outline-none focus:border-emerald-500 focus:ring-2 focus:ring-emerald-500/20" placeholder="New roster name (e.g., U12 Eagles)">
                        <button onclick="createRoster()" class="px-4 py-2 bg-emerald-500 hover:bg-emerald-600 text-white font-medium rounded-lg transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                            </svg>
                        </button>
                    </div>
                    <div id="rosters-error" class="hidden mt-2 text-red-500 dark:text-red-400 text-sm"></div>
                </div>

                <!-- Rosters List -->
                <div class="flex-1 overflow-y-auto custom-scrollbar" id="rosters-list">
                    <div class="text-center py-8 text-slate-400">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-12 h-12 mx-auto mb-3 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                        </svg>
                        <p>No rosters created yet</p>
                        <p class="text-sm mt-1">Create a roster to track your team</p>
                    </div>
                </div>

                <!-- Roster Count -->
                <div class="mt-4 pt-4 border-t border-slate-200 dark:border-slate-700 text-center">
                    <span class="text-sm text-slate-500 dark:text-slate-400" id="rosters-count">0 rosters</span>
                </div>
            </div>
        </div>

        <!-- Roster Players Modal -->
        <div class="fixed inset-0 bg-black/50 z-[55] hidden items-center justify-center p-4" id="roster-players-modal-overlay" onclick="if(event.target === this) closeRosterPlayersModal()">
            <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 max-w-md w-full shadow-2xl max-h-[90vh] overflow-hidden flex flex-col">
                <!-- Header -->
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center gap-2">
                        <button onclick="closeRosterPlayersModal()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 transition-colors mr-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                            </svg>
                        </button>
                        <h3 class="text-lg font-semibold text-slate-800 dark:text-white" id="roster-players-title">Roster Players</h3>
                    </div>
                    <button onclick="closeRosterPlayersModal(); closeRostersModal();" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <!-- Add Player Form -->
                <div class="mb-4 pb-4 border-b border-slate-200 dark:border-slate-700">
                    <div class="flex gap-2">
                        <input type="text" id="player-name-input" class="flex-1 px-3 py-2 border-2 border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg text-sm transition-all duration-200 focus:outline-none focus:border-emerald-500 focus:ring-2 focus:ring-emerald-500/20" placeholder="Player name">
                        <input type="number" id="player-number-input" class="w-20 px-3 py-2 border-2 border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg text-sm text-center transition-all duration-200 focus:outline-none focus:border-emerald-500 focus:ring-2 focus:ring-emerald-500/20" placeholder="#" min="1" max="99">
                        <button onclick="addPlayer()" class="px-4 py-2 bg-emerald-500 hover:bg-emerald-600 text-white font-medium rounded-lg transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                            </svg>
                        </button>
                    </div>
                    <div id="roster-error" class="hidden mt-2 text-red-500 dark:text-red-400 text-sm"></div>
                </div>

                <!-- Player List -->
                <div class="flex-1 overflow-y-auto custom-scrollbar" id="roster-list">
                    <div class="text-center py-8 text-slate-400">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-12 h-12 mx-auto mb-3 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                        </svg>
                        <p>No players added yet</p>
                        <p class="text-sm mt-1">Add players to this roster above</p>
                    </div>
                </div>

                <!-- Player Count -->
                <div class="mt-4 pt-4 border-t border-slate-200 dark:border-slate-700 text-center">
                    <span class="text-sm text-slate-500 dark:text-slate-400" id="roster-count">0 players</span>
                </div>
            </div>
        </div>

        <!-- Select Roster Modal -->
        <div class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4" id="select-roster-modal-overlay" onclick="if(event.target === this) closeSelectRosterModal()">
            <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 max-w-sm w-full shadow-2xl max-h-[80vh] overflow-hidden flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h3 class="text-lg font-semibold text-slate-800 dark:text-white">Select Roster</h3>
                        <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">Choose a roster for this game</p>
                    </div>
                    <button onclick="closeSelectRosterModal()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <!-- Roster List for Selection -->
                <div class="flex-1 overflow-y-auto custom-scrollbar -mx-2 px-2" id="select-roster-list">
                    <div class="text-center py-8 text-slate-400">
                        <p>No rosters available</p>
                        <p class="text-sm mt-1">Create a roster first</p>
                    </div>
                </div>

                <!-- Clear Selection Button -->
                <div class="mt-4 pt-4 border-t border-slate-200 dark:border-slate-700">
                    <button onclick="clearSelectedRoster()" class="w-full py-2.5 bg-slate-100 hover:bg-slate-200 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-600 dark:text-slate-300 font-medium rounded-lg transition-colors">
                        Clear Selection (No Roster)
                    </button>
                </div>
            </div>
        </div>

        <!-- Edit Roster Modal -->
        <div class="fixed inset-0 bg-black/50 z-[60] hidden items-center justify-center p-4" id="edit-roster-modal-overlay" onclick="if(event.target === this) closeEditRosterModal()">
            <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 max-w-sm w-full shadow-2xl">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-slate-800 dark:text-white">Edit Roster</h3>
                    <button onclick="closeEditRosterModal()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <input type="hidden" id="edit-roster-id">
                <div class="space-y-4">
                    <div>
                        <label class="text-sm font-medium text-slate-600 dark:text-slate-400 block mb-1.5">Roster Name</label>
                        <input type="text" id="edit-roster-name" class="w-full px-3 py-2.5 border-2 border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg text-sm transition-all duration-200 focus:outline-none focus:border-emerald-500 focus:ring-2 focus:ring-emerald-500/20">
                    </div>
                    <div id="edit-roster-error" class="hidden text-red-500 dark:text-red-400 text-sm"></div>
                </div>
                <div class="flex gap-3 mt-6">
                    <button onclick="closeEditRosterModal()" class="flex-1 py-2.5 bg-slate-100 hover:bg-slate-200 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200 font-medium rounded-lg transition-colors">Cancel</button>
                    <button onclick="saveRosterEdit()" class="flex-1 py-2.5 bg-emerald-500 hover:bg-emerald-600 text-white font-medium rounded-lg transition-colors">Save</button>
                </div>
            </div>
        </div>

        <!-- Edit Player Modal -->
        <div class="fixed inset-0 bg-black/50 z-[60] hidden items-center justify-center p-4" id="edit-player-modal-overlay" onclick="if(event.target === this) closeEditPlayerModal()">
            <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 max-w-sm w-full shadow-2xl">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-slate-800 dark:text-white">Edit Player</h3>
                    <button onclick="closeEditPlayerModal()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <input type="hidden" id="edit-player-id">
                <div class="space-y-4">
                    <div>
                        <label class="text-sm font-medium text-slate-600 dark:text-slate-400 block mb-1.5">Name</label>
                        <input type="text" id="edit-player-name" class="w-full px-3 py-2.5 border-2 border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg text-sm transition-all duration-200 focus:outline-none focus:border-emerald-500 focus:ring-2 focus:ring-emerald-500/20">
                    </div>
                    <div>
                        <label class="text-sm font-medium text-slate-600 dark:text-slate-400 block mb-1.5">Number (optional)</label>
                        <input type="number" id="edit-player-number" class="w-full px-3 py-2.5 border-2 border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg text-sm transition-all duration-200 focus:outline-none focus:border-emerald-500 focus:ring-2 focus:ring-emerald-500/20" min="1" max="99">
                    </div>
                    <div id="edit-player-error" class="hidden text-red-500 dark:text-red-400 text-sm"></div>
                </div>
                <div class="flex gap-3 mt-6">
                    <button onclick="closeEditPlayerModal()" class="flex-1 py-2.5 bg-slate-100 hover:bg-slate-200 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200 font-medium rounded-lg transition-colors">Cancel</button>
                    <button onclick="savePlayerEdit()" class="flex-1 py-2.5 bg-emerald-500 hover:bg-emerald-600 text-white font-medium rounded-lg transition-colors">Save</button>
                </div>
            </div>
        </div>

        <!-- Player Selection Modal (for goals) -->
        <div class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4" id="player-select-modal-overlay" onclick="if(event.target === this) skipPlayerSelection()">
            <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 max-w-sm w-full shadow-2xl max-h-[80vh] overflow-hidden flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h3 class="text-lg font-semibold text-slate-800 dark:text-white">Who Scored?</h3>
                        <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">Select the player who scored</p>
                    </div>
                    <button onclick="skipPlayerSelection()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <!-- Player List for Selection -->
                <div class="flex-1 overflow-y-auto custom-scrollbar -mx-2 px-2" id="player-select-list">
                    <div class="text-center py-8 text-slate-400">
                        <p>No players in roster</p>
                    </div>
                </div>

                <!-- Skip Button -->
                <div class="mt-4 pt-4 border-t border-slate-200 dark:border-slate-700">
                    <button onclick="skipPlayerSelection()" class="w-full py-2.5 bg-slate-100 hover:bg-slate-200 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-600 dark:text-slate-300 font-medium rounded-lg transition-colors">
                        Skip (Unknown Player)
                    </button>
                </div>
            </div>
        </div>

        <!-- Edit Goal Player Modal (for shot log) -->
        <div class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4" id="edit-goal-player-modal-overlay" onclick="if(event.target === this) closeEditGoalPlayerModal()">
            <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 max-w-sm w-full shadow-2xl max-h-[80vh] overflow-hidden flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h3 class="text-lg font-semibold text-slate-800 dark:text-white">Edit Goal Scorer</h3>
                        <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">Change the player who scored</p>
                    </div>
                    <button onclick="closeEditGoalPlayerModal()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <input type="hidden" id="edit-goal-index">

                <!-- Player List for Editing -->
                <div class="flex-1 overflow-y-auto custom-scrollbar -mx-2 px-2" id="edit-goal-player-list">
                    <div class="text-center py-8 text-slate-400">
                        <p>No players in roster</p>
                    </div>
                </div>

                <!-- Clear/Cancel Buttons -->
                <div class="mt-4 pt-4 border-t border-slate-200 dark:border-slate-700 flex gap-3">
                    <button onclick="clearGoalPlayer()" class="flex-1 py-2.5 bg-slate-100 hover:bg-slate-200 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-600 dark:text-slate-300 font-medium rounded-lg transition-colors">
                        Clear Player
                    </button>
                    <button onclick="closeEditGoalPlayerModal()" class="flex-1 py-2.5 bg-emerald-500 hover:bg-emerald-600 text-white font-medium rounded-lg transition-colors">
                        Done
                    </button>
                </div>
            </div>
        </div>

        <!-- History Edit Goal Player Modal -->
        <div class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4" id="history-edit-goal-player-modal-overlay" onclick="if(event.target === this) closeHistoryEditGoalPlayerModal()">
            <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 max-w-sm w-full shadow-2xl max-h-[80vh] overflow-hidden flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h3 class="text-lg font-semibold text-slate-800 dark:text-white">Edit Goal Scorer</h3>
                        <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">Change the player who scored</p>
                    </div>
                    <button onclick="closeHistoryEditGoalPlayerModal()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <!-- Player List for History Editing -->
                <div class="flex-1 overflow-y-auto custom-scrollbar -mx-2 px-2" id="history-edit-goal-player-list">
                    <div class="text-center py-8 text-slate-400">
                        <p>No players in roster</p>
                    </div>
                </div>

                <!-- Clear/Cancel Buttons -->
                <div class="mt-4 pt-4 border-t border-slate-200 dark:border-slate-700 flex gap-3">
                    <button onclick="clearHistoryGoalPlayer()" class="flex-1 py-2.5 bg-slate-100 hover:bg-slate-200 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-600 dark:text-slate-300 font-medium rounded-lg transition-colors">
                        Clear Player
                    </button>
                    <button onclick="closeHistoryEditGoalPlayerModal()" class="flex-1 py-2.5 bg-emerald-500 hover:bg-emerald-600 text-white font-medium rounded-lg transition-colors">
                        Done
                    </button>
                </div>
            </div>
        </div>

        <!-- Shot Map Modal -->
        <div class="shot-map-modal fixed inset-0 bg-black/60 z-50 hidden items-center justify-center p-4" id="shot-map-modal">
            <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 max-w-2xl w-full shadow-2xl max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h3 class="text-lg font-semibold text-slate-800 dark:text-white">Mark Shot Location</h3>
                        <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">Tap on the field where the shot was taken</p>
                    </div>
                    <div id="shot-map-shot-info" class="text-right">
                        <span id="shot-map-team" class="text-sm font-semibold"></span>
                        <span id="shot-map-type" class="text-xs text-slate-500 dark:text-slate-400 block"></span>
                    </div>
                </div>

                <!-- Flip Sides Button -->
                <div class="flex items-center justify-between mb-3 px-1">
                    <span class="text-xs text-slate-400" id="field-sides-label">Home: Left  Away: Right</span>
                    <button type="button" onclick="flipFieldSides()" class="px-3 py-1.5 border border-slate-300 dark:border-slate-600 text-slate-600 dark:text-slate-300 rounded-lg text-xs font-medium transition-all duration-200 hover:border-emerald-500 hover:text-emerald-500 hover:bg-emerald-50 dark:hover:bg-emerald-900/20 flex items-center gap-1.5">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                        </svg>
                        <span>Flip Sides</span>
                    </button>
                </div>

                <!-- Heat Map Toggle -->
                <div class="mb-3 px-1 py-2 bg-slate-50 dark:bg-slate-700 rounded-lg" id="heat-map-controls">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-orange-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.656 7.343A7.975 7.975 0 0120 13a7.975 7.975 0 01-2.343 5.657z" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9.879 16.121A3 3 0 1012.015 11L11 14H9c0 .768.293 1.536.879 2.121z" />
                            </svg>
                            <span class="text-xs font-medium text-slate-600 dark:text-slate-300">Heat Map</span>
                            <span class="text-xs text-slate-400" id="heat-map-status">(10 shots required)</span>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="heat-map-toggle" class="sr-only peer" onchange="toggleHeatMap()" disabled>
                            <div class="w-9 h-5 bg-slate-300 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-emerald-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-orange-500 peer-disabled:opacity-50 peer-disabled:cursor-not-allowed"></div>
                        </label>
                    </div>
                    <!-- Team Filter Buttons -->
                    <div class="flex items-center justify-center gap-1 mt-2" id="heat-map-team-filter" style="display: none;">
                        <button type="button" id="heat-map-filter-home" onclick="setHeatMapTeamFilter('home')" class="px-3 py-1 text-xs font-medium rounded-lg transition-all duration-200 bg-orange-500 text-white">Home</button>
                        <button type="button" id="heat-map-filter-away" onclick="setHeatMapTeamFilter('away')" class="px-3 py-1 text-xs font-medium rounded-lg transition-all duration-200 bg-slate-200 text-slate-600 hover:bg-slate-300">Away</button>
                    </div>
                </div>

                <!-- Soccer Field SVG -->
                <div class="relative bg-emerald-600 rounded-xl overflow-hidden cursor-crosshair" id="shot-map-field" style="aspect-ratio: 105/68;">
                    <svg viewBox="0 0 105 68" class="w-full h-full" id="shot-map-svg">
                        <!-- Field background -->
                        <rect x="0" y="0" width="105" height="68" fill="#2d8a4e"/>

                        <!-- Field stripes (decorative) -->
                        <g fill="#3d9a5e" opacity="0.5">
                            <rect x="0" y="0" width="10.5" height="68"/>
                            <rect x="21" y="0" width="10.5" height="68"/>
                            <rect x="42" y="0" width="10.5" height="68"/>
                            <rect x="63" y="0" width="10.5" height="68"/>
                            <rect x="84" y="0" width="10.5" height="68"/>
                        </g>

                        <!-- Field lines -->
                        <g fill="none" stroke="white" stroke-width="0.3">
                            <!-- Outline -->
                            <rect x="0.5" y="0.5" width="104" height="67" rx="0"/>

                            <!-- Center line -->
                            <line x1="52.5" y1="0.5" x2="52.5" y2="67.5"/>

                            <!-- Center circle -->
                            <circle cx="52.5" cy="34" r="9.15"/>
                            <circle cx="52.5" cy="34" r="0.5" fill="white"/>

                            <!-- Left penalty area -->
                            <rect x="0.5" y="13.84" width="16.5" height="40.32"/>
                            <!-- Left goal area -->
                            <rect x="0.5" y="24.84" width="5.5" height="18.32"/>
                            <!-- Left penalty spot -->
                            <circle cx="11" cy="34" r="0.5" fill="white"/>
                            <!-- Left penalty arc -->
                            <path d="M 17 27.1 A 9.15 9.15 0 0 1 17 40.9" stroke="white" fill="none"/>
                            <!-- Left goal -->
                            <rect x="-2" y="30.34" width="2.5" height="7.32" fill="none" stroke="white" stroke-width="0.3"/>

                            <!-- Right penalty area -->
                            <rect x="88" y="13.84" width="16.5" height="40.32"/>
                            <!-- Right goal area -->
                            <rect x="99" y="24.84" width="5.5" height="18.32"/>
                            <!-- Right penalty spot -->
                            <circle cx="94" cy="34" r="0.5" fill="white"/>
                            <!-- Right penalty arc -->
                            <path d="M 88 27.1 A 9.15 9.15 0 0 0 88 40.9" stroke="white" fill="none"/>
                            <!-- Right goal -->
                            <rect x="104.5" y="30.34" width="2.5" height="7.32" fill="none" stroke="white" stroke-width="0.3"/>

                            <!-- Corner arcs -->
                            <path d="M 0.5 1.5 A 1 1 0 0 0 1.5 0.5"/>
                            <path d="M 103.5 0.5 A 1 1 0 0 0 104.5 1.5"/>
                            <path d="M 104.5 66.5 A 1 1 0 0 0 103.5 67.5"/>
                            <path d="M 1.5 67.5 A 1 1 0 0 0 0.5 66.5"/>
                        </g>

                        <!-- Team labels -->
                        <text x="2" y="5" fill="white" font-size="3" font-weight="bold" opacity="0.7" text-anchor="start" id="field-home-label">HOME</text>
                        <text x="103" y="5" fill="white" font-size="3" font-weight="bold" opacity="0.7" text-anchor="end" id="field-away-label">AWAY</text>

                        <!-- Shot marker (hidden initially) -->
                        <g id="shot-marker" style="display: none;">
                            <circle id="shot-marker-circle" cx="0" cy="0" r="2.5" fill="currentColor" stroke="white" stroke-width="0.4"/>
                            <circle cx="0" cy="0" r="0.8" fill="white"/>
                        </g>

                        <!-- Previous shots for this game -->
                        <g id="shot-map-previous-shots"></g>
                    </svg>

                    <!-- Heat map canvas overlay -->
                    <canvas id="heat-map-canvas" class="absolute inset-0 w-full h-full pointer-events-none" style="display: none;"></canvas>

                    <!-- Click overlay for positioning -->
                    <div class="absolute inset-0" id="shot-map-click-area"></div>
                </div>

                <!-- Shot Map Legend -->
                <div class="mt-3 flex flex-wrap items-center justify-center gap-4 text-xs text-slate-600 dark:text-slate-400">
                    <div class="flex items-center gap-1.5">
                        <svg width="14" height="14" viewBox="0 0 14 14">
                            <circle cx="7" cy="7" r="5" fill="#6b7280" stroke="white" stroke-width="1"/>
                            <text x="7" y="9" fill="white" font-size="6" text-anchor="middle"></text>
                        </svg>
                        <span>Goal</span>
                    </div>
                    <div class="flex items-center gap-1.5">
                        <svg width="14" height="14" viewBox="0 0 14 14">
                            <rect x="3" y="3" width="8" height="8" fill="#6b7280" stroke="white" stroke-width="1"/>
                        </svg>
                        <span>On Target</span>
                    </div>
                    <div class="flex items-center gap-1.5">
                        <svg width="14" height="14" viewBox="0 0 14 14">
                            <polygon points="7,2 2,12 12,12" fill="#6b7280" stroke="white" stroke-width="1"/>
                        </svg>
                        <span>Off Target</span>
                    </div>
                </div>

                <!-- Shot position indicator -->
                <div class="mt-4 flex items-center justify-between">
                    <div id="shot-position-display" class="text-sm text-slate-500 dark:text-slate-400">
                        Click on the field to mark shot location
                    </div>
                    <div class="flex gap-2">
                        <button class="px-4 py-2 text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200 font-medium rounded-xl transition-all duration-200" onclick="skipShotLocation()">Skip</button>
                        <button class="px-5 py-2.5 bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-600 hover:to-emerald-700 text-white font-semibold rounded-xl transition-all duration-200 shadow-md disabled:opacity-50 disabled:cursor-not-allowed" id="confirm-shot-location-btn" onclick="confirmShotLocation()" disabled>Confirm Location</button>
                    </div>
                </div>
            </div>
        </div>
    </div><!-- End app-wrapper -->

    <script>
        // =====================================================
        // SUPABASE CONFIGURATION
        // =====================================================

        // Your Supabase project credentials
        const SUPABASE_URL = 'https://dwjwtmvzhxuzhdihmwqp.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_k1YD9txQsrT-XsoqW3g1Zw_Wy0frWpq';

        // Initialize Supabase client
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Current authenticated user
        let currentUser = null;

        // =====================================================
        // AUTHENTICATION FUNCTIONS
        // =====================================================

        // Switch between login and signup tabs
        window.switchAuthTab = function(tab) {
            const loginTab = document.getElementById('login-tab');
            const signupTab = document.getElementById('signup-tab');
            const loginForm = document.getElementById('login-form');
            const signupForm = document.getElementById('signup-form');

            // Clear any error/success messages
            hideAuthMessages();

            if (tab === 'login') {
                loginTab.classList.add('bg-white', 'text-emerald-600', 'shadow-sm');
                loginTab.classList.remove('text-slate-500');
                signupTab.classList.remove('bg-white', 'text-emerald-600', 'shadow-sm');
                signupTab.classList.add('text-slate-500');
                loginForm.style.display = 'flex';
                signupForm.style.display = 'none';
            } else {
                loginTab.classList.remove('bg-white', 'text-emerald-600', 'shadow-sm');
                loginTab.classList.add('text-slate-500');
                signupTab.classList.add('bg-white', 'text-emerald-600', 'shadow-sm');
                signupTab.classList.remove('text-slate-500');
                loginForm.style.display = 'none';
                signupForm.style.display = 'flex';
            }
        }

        // Show error message on auth form
        function showAuthError(message) {
            const errorEl = document.getElementById('auth-error');
            const successEl = document.getElementById('auth-success');
            errorEl.textContent = message;
            errorEl.classList.remove('hidden');
            successEl.classList.add('hidden');
        }

        // Show success message on auth form
        function showAuthSuccess(message) {
            const errorEl = document.getElementById('auth-error');
            const successEl = document.getElementById('auth-success');
            successEl.textContent = message;
            successEl.classList.remove('hidden');
            errorEl.classList.add('hidden');
        }

        // Hide all auth messages
        function hideAuthMessages() {
            document.getElementById('auth-error').classList.add('hidden');
            document.getElementById('auth-success').classList.add('hidden');
        }

        // Handle login form submission
        window.handleLogin = async function(event) {
            event.preventDefault();

            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const loginBtn = document.getElementById('login-btn');

            // Disable button while processing
            loginBtn.disabled = true;
            loginBtn.textContent = 'Logging in...';
            hideAuthMessages();

            try {
                // Attempt to sign in with Supabase
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                if (error) {
                    showAuthError(error.message);
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'Log In';
                    return;
                }

                // Success - the auth state change listener will handle the UI update
                console.log('Login successful:', data.user.email);

            } catch (err) {
                showAuthError('An unexpected error occurred. Please try again.');
                console.error('Login error:', err);
                loginBtn.disabled = false;
                loginBtn.textContent = 'Log In';
            }
        }

        // Handle signup form submission
        window.handleSignup = async function(event) {
            event.preventDefault();

            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const confirm = document.getElementById('signup-confirm').value;
            const signupBtn = document.getElementById('signup-btn');

            // Validate passwords match
            if (password !== confirm) {
                showAuthError('Passwords do not match.');
                return;
            }

            // Disable button while processing
            signupBtn.disabled = true;
            signupBtn.textContent = 'Creating account...';
            hideAuthMessages();

            try {
                // Attempt to sign up with Supabase
                const { data, error } = await supabaseClient.auth.signUp({
                    email: email,
                    password: password
                });

                if (error) {
                    showAuthError(error.message);
                    signupBtn.disabled = false;
                    signupBtn.textContent = 'Create Account';
                    return;
                }

                // Check if email confirmation is required
                if (data.user && data.user.identities && data.user.identities.length === 0) {
                    showAuthError('This email is already registered. Please log in instead.');
                    signupBtn.disabled = false;
                    signupBtn.textContent = 'Create Account';
                    return;
                }

                // Success - show message about email confirmation (if enabled) or auto-login
                if (data.session) {
                    // Auto-confirmed - the auth state change listener will handle the UI update
                    console.log('Signup successful, auto-logged in:', data.user.email);
                } else {
                    // Email confirmation required
                    showAuthSuccess('Account created! Please check your email to confirm your account, then log in.');
                    signupBtn.disabled = false;
                    signupBtn.textContent = 'Create Account';
                    // Switch to login tab
                    setTimeout(() => switchAuthTab('login'), 2000);
                }

            } catch (err) {
                showAuthError('An unexpected error occurred. Please try again.');
                console.error('Signup error:', err);
                signupBtn.disabled = false;
                signupBtn.textContent = 'Create Account';
            }
        }

        // Handle logout
        window.handleLogout = async function() {
            try {
                const { error } = await supabaseClient.auth.signOut();
                if (error) {
                    console.error('Logout error:', error);
                    showModal('Error', 'Failed to log out. Please try again.', null);
                }
                // Auth state change listener will handle the UI update
            } catch (err) {
                console.error('Logout error:', err);
            }
        }

        // =====================================================
        // PROFILE MODAL FUNCTIONS
        // =====================================================

        window.openProfileModal = function() {
            const modal = document.getElementById('profile-modal-overlay');
            modal.classList.remove('hidden');
            modal.classList.add('flex');

            // Update profile data
            if (currentUser) {
                const email = currentUser.email;
                const initial = email.charAt(0).toUpperCase();
                document.getElementById('profile-email').textContent = email;
                document.getElementById('profile-avatar').textContent = initial;
            }

            // Update theme toggle state
            updateThemeToggleUI();
            hidePasswordResetMessages();
        }

        window.closeProfileModal = function() {
            const modal = document.getElementById('profile-modal-overlay');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        // =====================================================
        // PASSWORD RESET FUNCTIONS
        // =====================================================

        window.handlePasswordReset = async function() {
            if (!currentUser || !currentUser.email) {
                showPasswordResetError('No user email found');
                return;
            }

            const btn = document.getElementById('password-reset-btn');
            const originalText = btn.textContent;
            btn.textContent = 'Sending...';
            btn.disabled = true;

            try {
                const { error } = await supabaseClient.auth.resetPasswordForEmail(currentUser.email, {
                    redirectTo: window.location.origin + window.location.pathname
                });

                if (error) {
                    showPasswordResetError(error.message);
                } else {
                    showPasswordResetSuccess('Password reset email sent! Check your inbox.');
                }
            } catch (err) {
                showPasswordResetError('Failed to send reset email. Please try again.');
                console.error('Password reset error:', err);
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        function showPasswordResetError(message) {
            hidePasswordResetMessages();
            const errorEl = document.getElementById('password-reset-error');
            errorEl.textContent = message;
            errorEl.classList.remove('hidden');
        }

        function showPasswordResetSuccess(message) {
            hidePasswordResetMessages();
            const successEl = document.getElementById('password-reset-success');
            successEl.textContent = message;
            successEl.classList.remove('hidden');
        }

        function hidePasswordResetMessages() {
            document.getElementById('password-reset-error').classList.add('hidden');
            document.getElementById('password-reset-success').classList.add('hidden');
        }

        // =====================================================
        // THEME FUNCTIONS
        // =====================================================

        const THEME_STORAGE_KEY = 'soccer-shot-tracker-theme';

        function initializeTheme() {
            const savedTheme = localStorage.getItem(THEME_STORAGE_KEY);
            let isDark = false;

            if (savedTheme) {
                isDark = savedTheme === 'dark';
            } else {
                // Check system preference
                isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            }

            applyTheme(isDark);
        }

        function applyTheme(isDark) {
            const html = document.documentElement;
            if (isDark) {
                html.classList.add('dark');
            } else {
                html.classList.remove('dark');
            }
            updateThemeIcons(isDark);
            updateThemeToggleUI();
        }

        window.toggleTheme = function() {
            const html = document.documentElement;
            const isDark = !html.classList.contains('dark');
            applyTheme(isDark);
            localStorage.setItem(THEME_STORAGE_KEY, isDark ? 'dark' : 'light');
        }

        function updateThemeToggleUI() {
            const toggle = document.getElementById('theme-toggle');
            const dot = document.getElementById('theme-toggle-dot');
            const isDark = document.documentElement.classList.contains('dark');

            if (toggle && dot) {
                if (isDark) {
                    dot.style.transform = 'translateX(20px)';
                    toggle.classList.remove('bg-slate-300');
                    toggle.classList.add('bg-emerald-500');
                } else {
                    dot.style.transform = 'translateX(0)';
                    toggle.classList.remove('bg-emerald-500');
                    toggle.classList.add('bg-slate-300');
                }
            }
        }

        function updateThemeIcons(isDark) {
            const sunIcon = document.getElementById('theme-icon-sun');
            const moonIcon = document.getElementById('theme-icon-moon');

            if (sunIcon && moonIcon) {
                if (isDark) {
                    sunIcon.classList.add('hidden');
                    moonIcon.classList.remove('hidden');
                } else {
                    sunIcon.classList.remove('hidden');
                    moonIcon.classList.add('hidden');
                }
            }
        }

        // Listen for system theme changes
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
            const savedTheme = localStorage.getItem(THEME_STORAGE_KEY);
            // Only apply system preference if user hasn't set a preference
            if (!savedTheme) {
                applyTheme(e.matches);
            }
        });

        // Initialize theme on page load
        initializeTheme();

        // Show the main app (after successful login)
        function showApp(user) {
            currentUser = user;

            // Hide auth container, show app
            document.getElementById('auth-container').style.display = 'none';
            document.getElementById('app-wrapper').classList.remove('hidden');

            // Display user email and avatar initial
            document.getElementById('user-email').textContent = user.email;
            const userInitial = user.email.charAt(0).toUpperCase();
            document.getElementById('user-avatar').textContent = userInitial;

            // Initialize app UI (set date, clock display)
            initializeApp();

            // Initialize player tracking UI
            initializePlayerTracking();

            // Load rosters from Supabase
            loadRosters();

            // Navigate to team home page
            navigateToHome();
        }

        // Show the auth screen (after logout or initial load)
        function showAuth() {
            currentUser = null;

            // Show auth container, hide app
            document.getElementById('auth-container').style.display = 'flex';
            document.getElementById('app-wrapper').classList.add('hidden');

            // Hide loading, show form
            document.getElementById('auth-loading').classList.add('hidden');
            document.getElementById('auth-form-container').style.display = 'block';

            // Clear form fields
            document.getElementById('login-email').value = '';
            document.getElementById('login-password').value = '';
            document.getElementById('signup-email').value = '';
            document.getElementById('signup-password').value = '';
            document.getElementById('signup-confirm').value = '';
            hideAuthMessages();
        }

        // Check authentication state on page load
        async function checkAuthState() {
            try {
                // Get current session
                const { data: { session }, error } = await supabaseClient.auth.getSession();

                if (error) {
                    console.error('Auth check error:', error);
                    showAuth();
                    return;
                }

                if (session && session.user) {
                    // User is logged in
                    showApp(session.user);
                } else {
                    // No session, show login
                    showAuth();
                }
            } catch (err) {
                console.error('Auth check error:', err);
                showAuth();
            }
        }

        // Listen for auth state changes (login/logout)
        supabaseClient.auth.onAuthStateChange((event, session) => {
            console.log('Auth state changed:', event);

            if (event === 'SIGNED_IN' && session) {
                showApp(session.user);
            } else if (event === 'SIGNED_OUT') {
                showAuth();
            }
        });

        // =====================================================
        // GAME STATE
        // =====================================================

        // Game state
        let gameState = {
            home: {
                goals: 0, onTarget: 0, offTarget: 0,
                firstHalf: { goals: 0, onTarget: 0, offTarget: 0 },
                secondHalf: { goals: 0, onTarget: 0, offTarget: 0 }
            },
            away: {
                goals: 0, onTarget: 0, offTarget: 0,
                firstHalf: { goals: 0, onTarget: 0, offTarget: 0 },
                secondHalf: { goals: 0, onTarget: 0, offTarget: 0 }
            },
            log: [],
            notes: [],
            currentHalf: 1
        };

        // Clock state
        let clockState = {
            seconds: 0,
            isRunning: false,
            intervalId: null
        };

        // Shot Map state
        let shotMapEnabled = false;
        let pendingShot = null;
        let selectedShotPosition = null;
        let fieldSidesFlipped = false; // false = Home on Left, true = Home on Right

        // Heat Map state
        let heatMapEnabled = localStorage.getItem('heatMapEnabled') === 'true';
        let heatMapTeamFilter = localStorage.getItem('heatMapTeamFilter') || 'home'; // 'home' or 'away'
        const HEAT_MAP_MIN_SHOTS = 10;

        // Wake Lock state
        let wakeLock = null;
        let wakeLockEnabled = localStorage.getItem('wakeLockEnabled') === 'true';

        // Roster state
        let rosters = []; // Array of { id, name, color }
        let currentRosterId = localStorage.getItem('currentRosterId') || null; // Selected roster for current game
        let currentRoster = null; // The currently selected roster object
        let roster = []; // Array of players in current roster { id, name, number, roster_id }
        let editingRosterId = null; // Roster being edited in the players modal
        let playerTrackingEnabled = localStorage.getItem('playerTrackingEnabled') === 'true';
        let rosterTeam = localStorage.getItem('rosterTeam') || 'home'; // Which team the roster belongs to
        let pendingGoalForPlayer = null; // Stores pending goal data when player selection is needed

        // History goal editing state
        let historyEditGameId = null;
        let historyEditLogIndex = null;
        let historyEditRosterId = null;
        let historyEditPlayers = [];
        let historyGamesCache = null; // Cache of games for re-rendering after edits

        // Saved games storage key
        const STORAGE_KEY = 'soccer-shot-tracker-games';

        // Team state
        let teams = [];
        let currentTeamId = null;
        let currentTeam = null;
        let teamRoster = [];      // players for selected team
        let teamRosterId = null;  // the single roster ID for selected team
        let teamGamesCache = null;
        let gameSetupConfig = {
            shotMapEnabled: localStorage.getItem('setupShotMapEnabled') === 'true',
            wakeLockEnabled: localStorage.getItem('setupWakeLockEnabled') === 'true',
            playerTrackingEnabled: localStorage.getItem('setupPlayerTrackingEnabled') === 'true'
        };

        // =====================================================
        // ROSTER MANAGEMENT (Multiple Rosters)
        // =====================================================

        // Load all rosters from Supabase
        async function loadRosters() {
            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) return;

                const { data, error } = await supabaseClient
                    .from('rosters')
                    .select('*')
                    .eq('user_id', user.id)
                    .order('name', { ascending: true });

                if (error) {
                    console.error('Error loading rosters:', error);
                    return;
                }

                rosters = data || [];
                updateRostersDisplay();
                updateRostersCount();

                // Load current roster if one is selected
                if (currentRosterId) {
                    currentRoster = rosters.find(r => r.id === currentRosterId);
                    if (currentRoster) {
                        await loadRosterPlayers(currentRosterId);
                    } else {
                        // Selected roster no longer exists
                        currentRosterId = null;
                        localStorage.removeItem('currentRosterId');
                    }
                }
                updateSelectedRosterDisplay();
            } catch (err) {
                console.error('Error loading rosters:', err);
            }
        }

        // Create a new roster
        window.createRoster = async function() {
            const nameInput = document.getElementById('roster-name-input');
            const errorEl = document.getElementById('rosters-error');
            const name = nameInput.value.trim();

            if (!name) {
                errorEl.textContent = 'Please enter a roster name';
                errorEl.classList.remove('hidden');
                return;
            }

            errorEl.classList.add('hidden');

            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) return;

                const { data, error } = await supabaseClient
                    .from('rosters')
                    .insert([{ user_id: user.id, name }])
                    .select()
                    .single();

                if (error) {
                    errorEl.textContent = error.message;
                    errorEl.classList.remove('hidden');
                    return;
                }

                rosters.push(data);
                rosters.sort((a, b) => a.name.localeCompare(b.name));
                nameInput.value = '';
                updateRostersDisplay();
                updateRostersCount();
            } catch (err) {
                errorEl.textContent = 'Failed to create roster';
                errorEl.classList.remove('hidden');
                console.error('Error creating roster:', err);
            }
        }

        // Delete a roster
        window.deleteRoster = async function(rosterId) {
            if (!confirm('Delete this roster and all its players? This cannot be undone.')) return;

            try {
                const { error } = await supabaseClient
                    .from('rosters')
                    .delete()
                    .eq('id', rosterId);

                if (error) {
                    console.error('Error deleting roster:', error);
                    return;
                }

                rosters = rosters.filter(r => r.id !== rosterId);
                updateRostersDisplay();
                updateRostersCount();

                // Clear current roster if it was deleted
                if (currentRosterId === rosterId) {
                    currentRosterId = null;
                    currentRoster = null;
                    roster = [];
                    localStorage.removeItem('currentRosterId');
                    updateSelectedRosterDisplay();
                }
            } catch (err) {
                console.error('Error deleting roster:', err);
            }
        }

        // Open edit roster modal
        window.openEditRosterModal = function(rosterId) {
            const rosterObj = rosters.find(r => r.id === rosterId);
            if (!rosterObj) return;

            document.getElementById('edit-roster-id').value = rosterId;
            document.getElementById('edit-roster-name').value = rosterObj.name;
            document.getElementById('edit-roster-error').classList.add('hidden');

            const modal = document.getElementById('edit-roster-modal-overlay');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        // Close edit roster modal
        window.closeEditRosterModal = function() {
            const modal = document.getElementById('edit-roster-modal-overlay');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        // Save roster edit
        window.saveRosterEdit = async function() {
            const rosterId = document.getElementById('edit-roster-id').value;
            const name = document.getElementById('edit-roster-name').value.trim();
            const errorEl = document.getElementById('edit-roster-error');

            if (!name) {
                errorEl.textContent = 'Please enter a roster name';
                errorEl.classList.remove('hidden');
                return;
            }

            errorEl.classList.add('hidden');

            try {
                const { error } = await supabaseClient
                    .from('rosters')
                    .update({ name })
                    .eq('id', rosterId);

                if (error) {
                    errorEl.textContent = error.message;
                    errorEl.classList.remove('hidden');
                    return;
                }

                const rosterIndex = rosters.findIndex(r => r.id === rosterId);
                if (rosterIndex !== -1) {
                    rosters[rosterIndex].name = name;
                }
                rosters.sort((a, b) => a.name.localeCompare(b.name));

                // Update current roster if it was edited
                if (currentRosterId === rosterId) {
                    currentRoster = rosters.find(r => r.id === rosterId);
                    updateSelectedRosterDisplay();
                }

                closeEditRosterModal();
                updateRostersDisplay();
            } catch (err) {
                errorEl.textContent = 'Failed to update roster';
                errorEl.classList.remove('hidden');
                console.error('Error updating roster:', err);
            }
        }

        // Update rosters display in modal
        function updateRostersDisplay() {
            const container = document.getElementById('rosters-list');

            if (rosters.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-slate-400">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-12 h-12 mx-auto mb-3 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                        </svg>
                        <p>No rosters created yet</p>
                        <p class="text-sm mt-1">Create a roster to track your team</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = rosters.map(rosterObj => `
                <div class="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-700/50 rounded-xl mb-2 group cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-700" onclick="openRosterPlayersModal('${rosterObj.id}')">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-emerald-100 dark:bg-emerald-900/50 rounded-full flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-emerald-600 dark:text-emerald-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                            </svg>
                        </div>
                        <div>
                            <span class="font-medium text-slate-800 dark:text-white">${escapeHtml(rosterObj.name)}</span>
                            <span class="text-xs text-slate-400 block">Click to manage players</span>
                        </div>
                    </div>
                    <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity" onclick="event.stopPropagation()">
                        <button onclick="openEditRosterModal('${rosterObj.id}')" class="p-2 text-slate-400 hover:text-emerald-500 hover:bg-emerald-50 dark:hover:bg-emerald-900/30 rounded-lg transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                            </svg>
                        </button>
                        <button onclick="deleteRoster('${rosterObj.id}')" class="p-2 text-slate-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 rounded-lg transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Update rosters count
        function updateRostersCount() {
            const countEl = document.getElementById('rosters-count');
            countEl.textContent = `${rosters.length} roster${rosters.length !== 1 ? 's' : ''}`;
        }

        // Open rosters modal
        window.openRostersModal = function() {
            const modal = document.getElementById('rosters-modal-overlay');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            loadRosters();
        }

        // Close rosters modal
        window.closeRostersModal = function() {
            const modal = document.getElementById('rosters-modal-overlay');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        // =====================================================
        // PLAYER MANAGEMENT (Within a Roster)
        // =====================================================

        // Load players for a specific roster
        async function loadRosterPlayers(rosterId) {
            try {
                const { data, error } = await supabaseClient
                    .from('players')
                    .select('*')
                    .eq('roster_id', rosterId)
                    .order('number', { ascending: true, nullsFirst: false });

                if (error) {
                    console.error('Error loading players:', error);
                    return;
                }

                roster = data || [];

                // Update display if we're in the players modal
                if (editingRosterId === rosterId) {
                    updateRosterDisplay();
                    updateRosterCount();
                }
            } catch (err) {
                console.error('Error loading players:', err);
            }
        }

        // Open roster players modal
        window.openRosterPlayersModal = async function(rosterId) {
            editingRosterId = rosterId;
            const rosterObj = rosters.find(r => r.id === rosterId);
            document.getElementById('roster-players-title').textContent = rosterObj ? rosterObj.name : 'Players';

            // Clear inputs
            document.getElementById('player-name-input').value = '';
            document.getElementById('player-number-input').value = '';
            document.getElementById('roster-error').classList.add('hidden');

            // Load players
            await loadRosterPlayers(rosterId);

            const modal = document.getElementById('roster-players-modal-overlay');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        // Close roster players modal
        window.closeRosterPlayersModal = function() {
            const modal = document.getElementById('roster-players-modal-overlay');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            editingRosterId = null;

            // If in team context, refresh the team roster display
            if (currentTeamId) {
                loadTeamRoster();
            }
        }

        // Add a new player to current roster
        window.addPlayer = async function() {
            if (!editingRosterId) return;

            const nameInput = document.getElementById('player-name-input');
            const numberInput = document.getElementById('player-number-input');
            const errorEl = document.getElementById('roster-error');

            const name = nameInput.value.trim();
            const number = numberInput.value ? parseInt(numberInput.value) : null;

            if (!name) {
                errorEl.textContent = 'Please enter a player name';
                errorEl.classList.remove('hidden');
                return;
            }

            if (number !== null && (number < 1 || number > 99)) {
                errorEl.textContent = 'Number must be between 1 and 99';
                errorEl.classList.remove('hidden');
                return;
            }

            if (number !== null && roster.some(p => p.number === number)) {
                errorEl.textContent = `Number ${number} is already assigned`;
                errorEl.classList.remove('hidden');
                return;
            }

            errorEl.classList.add('hidden');

            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) return;

                const { data, error } = await supabaseClient
                    .from('players')
                    .insert([{ user_id: user.id, roster_id: editingRosterId, name, number }])
                    .select()
                    .single();

                if (error) {
                    errorEl.textContent = error.message;
                    errorEl.classList.remove('hidden');
                    return;
                }

                roster.push(data);
                roster.sort((a, b) => {
                    if (a.number === null && b.number === null) return 0;
                    if (a.number === null) return 1;
                    if (b.number === null) return -1;
                    return a.number - b.number;
                });

                nameInput.value = '';
                numberInput.value = '';
                updateRosterDisplay();
                updateRosterCount();
            } catch (err) {
                errorEl.textContent = 'Failed to add player';
                errorEl.classList.remove('hidden');
                console.error('Error adding player:', err);
            }
        }

        // Delete a player
        window.deletePlayer = async function(playerId) {
            if (!confirm('Remove this player from the roster?')) return;

            try {
                const { error } = await supabaseClient
                    .from('players')
                    .delete()
                    .eq('id', playerId);

                if (error) {
                    console.error('Error deleting player:', error);
                    return;
                }

                roster = roster.filter(p => p.id !== playerId);
                updateRosterDisplay();
                updateRosterCount();
            } catch (err) {
                console.error('Error deleting player:', err);
            }
        }

        // Open edit player modal
        window.openEditPlayerModal = function(playerId) {
            const player = roster.find(p => p.id === playerId);
            if (!player) return;

            document.getElementById('edit-player-id').value = playerId;
            document.getElementById('edit-player-name').value = player.name;
            document.getElementById('edit-player-number').value = player.number || '';
            document.getElementById('edit-player-error').classList.add('hidden');

            const modal = document.getElementById('edit-player-modal-overlay');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        // Close edit player modal
        window.closeEditPlayerModal = function() {
            const modal = document.getElementById('edit-player-modal-overlay');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        // Save player edit
        window.savePlayerEdit = async function() {
            const playerId = document.getElementById('edit-player-id').value;
            const name = document.getElementById('edit-player-name').value.trim();
            const numberInput = document.getElementById('edit-player-number').value;
            const number = numberInput ? parseInt(numberInput) : null;
            const errorEl = document.getElementById('edit-player-error');

            if (!name) {
                errorEl.textContent = 'Please enter a player name';
                errorEl.classList.remove('hidden');
                return;
            }

            if (number !== null && (number < 1 || number > 99)) {
                errorEl.textContent = 'Number must be between 1 and 99';
                errorEl.classList.remove('hidden');
                return;
            }

            if (number !== null && roster.some(p => p.id !== playerId && p.number === number)) {
                errorEl.textContent = `Number ${number} is already assigned`;
                errorEl.classList.remove('hidden');
                return;
            }

            errorEl.classList.add('hidden');

            try {
                const { error } = await supabaseClient
                    .from('players')
                    .update({ name, number })
                    .eq('id', playerId);

                if (error) {
                    errorEl.textContent = error.message;
                    errorEl.classList.remove('hidden');
                    return;
                }

                const playerIndex = roster.findIndex(p => p.id === playerId);
                if (playerIndex !== -1) {
                    roster[playerIndex].name = name;
                    roster[playerIndex].number = number;
                }

                roster.sort((a, b) => {
                    if (a.number === null && b.number === null) return 0;
                    if (a.number === null) return 1;
                    if (b.number === null) return -1;
                    return a.number - b.number;
                });

                closeEditPlayerModal();
                updateRosterDisplay();
            } catch (err) {
                errorEl.textContent = 'Failed to update player';
                errorEl.classList.remove('hidden');
                console.error('Error updating player:', err);
            }
        }

        // Update roster display in modal
        function updateRosterDisplay() {
            const container = document.getElementById('roster-list');

            if (roster.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-slate-400">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-12 h-12 mx-auto mb-3 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                        </svg>
                        <p>No players added yet</p>
                        <p class="text-sm mt-1">Add players to this roster above</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = roster.map(player => `
                <div class="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-700/50 rounded-xl mb-2 group">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-emerald-100 dark:bg-emerald-900/50 rounded-full flex items-center justify-center">
                            <span class="text-emerald-700 dark:text-emerald-400 font-bold text-sm">${player.number || '-'}</span>
                        </div>
                        <span class="font-medium text-slate-800 dark:text-white">${escapeHtml(player.name)}</span>
                    </div>
                    <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button onclick="openEditPlayerModal('${player.id}')" class="p-2 text-slate-400 hover:text-emerald-500 hover:bg-emerald-50 dark:hover:bg-emerald-900/30 rounded-lg transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                            </svg>
                        </button>
                        <button onclick="deletePlayer('${player.id}')" class="p-2 text-slate-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 rounded-lg transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Update roster count
        function updateRosterCount() {
            const countEl = document.getElementById('roster-count');
            countEl.textContent = `${roster.length} player${roster.length !== 1 ? 's' : ''}`;
        }

        // =====================================================
        // ROSTER SELECTION (For Current Game)
        // =====================================================

        // Open select roster modal
        window.openSelectRosterModal = async function() {
            await loadRosters();
            updateSelectRosterList();

            const modal = document.getElementById('select-roster-modal-overlay');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        // Close select roster modal
        window.closeSelectRosterModal = function() {
            const modal = document.getElementById('select-roster-modal-overlay');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        // Update select roster list
        function updateSelectRosterList() {
            const container = document.getElementById('select-roster-list');

            if (rosters.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-slate-400">
                        <p>No rosters available</p>
                        <p class="text-sm mt-1">Create a roster first</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = rosters.map(rosterObj => `
                <button onclick="selectRosterForGame('${rosterObj.id}')" class="w-full flex items-center gap-3 p-3 ${currentRosterId === rosterObj.id ? 'bg-emerald-100 dark:bg-emerald-900/50' : 'bg-slate-50 dark:bg-slate-700/50'} hover:bg-emerald-50 dark:hover:bg-emerald-900/30 rounded-xl mb-2 transition-colors text-left">
                    <div class="w-10 h-10 ${currentRosterId === rosterObj.id ? 'bg-emerald-500' : 'bg-emerald-100 dark:bg-emerald-900/50'} rounded-full flex items-center justify-center flex-shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" class="${currentRosterId === rosterObj.id ? 'w-5 h-5 text-white' : 'w-5 h-5 text-emerald-600 dark:text-emerald-400'}" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                        </svg>
                    </div>
                    <span class="font-medium text-slate-800 dark:text-white">${escapeHtml(rosterObj.name)}</span>
                    ${currentRosterId === rosterObj.id ? '<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-emerald-500 ml-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>' : ''}
                </button>
            `).join('');
        }

        // Select roster for current game
        window.selectRosterForGame = async function(rosterId) {
            currentRosterId = rosterId;
            currentRoster = rosters.find(r => r.id === rosterId);
            localStorage.setItem('currentRosterId', rosterId);

            // Load players for selected roster
            await loadRosterPlayers(rosterId);

            updateSelectedRosterDisplay();
            closeSelectRosterModal();
        }

        // Clear selected roster
        window.clearSelectedRoster = function() {
            currentRosterId = null;
            currentRoster = null;
            roster = [];
            localStorage.removeItem('currentRosterId');
            updateSelectedRosterDisplay();
            closeSelectRosterModal();
        }

        // Update selected roster display in game setup
        function updateSelectedRosterDisplay() {
            const display = document.getElementById('selected-roster-display');
            const trackingSection = document.getElementById('player-tracking-section');
            const teamAssignment = document.getElementById('roster-team-assignment');

            if (currentRoster) {
                display.innerHTML = `<span class="text-emerald-600 dark:text-emerald-400 font-medium">${escapeHtml(currentRoster.name)}</span> <span class="text-slate-400">(${roster.length} players)</span>`;
                trackingSection.style.display = 'flex';
                if (playerTrackingEnabled) {
                    teamAssignment.style.display = 'block';
                }
            } else {
                display.innerHTML = `<span class="text-slate-400">No roster selected</span>`;
                trackingSection.style.display = 'none';
                teamAssignment.style.display = 'none';
            }
        }

        // =====================================================
        // PLAYER TRACKING TOGGLE
        // =====================================================

        // Toggle player tracking
        window.togglePlayerTracking = function() {
            playerTrackingEnabled = !playerTrackingEnabled;
            localStorage.setItem('playerTrackingEnabled', playerTrackingEnabled);

            const toggle = document.getElementById('player-tracking-toggle');
            const dot = document.getElementById('player-tracking-toggle-dot');
            const teamAssignment = document.getElementById('roster-team-assignment');

            if (playerTrackingEnabled) {
                toggle.classList.remove('bg-slate-300', 'dark:bg-slate-600');
                toggle.classList.add('bg-emerald-500');
                dot.style.transform = 'translateX(20px)';
                if (currentRoster) {
                    teamAssignment.style.display = 'block';
                }
            } else {
                toggle.classList.add('bg-slate-300', 'dark:bg-slate-600');
                toggle.classList.remove('bg-emerald-500');
                dot.style.transform = 'translateX(0)';
                teamAssignment.style.display = 'none';
            }
        }

        // Set roster team assignment
        window.setRosterTeam = function(team) {
            rosterTeam = team;
            localStorage.setItem('rosterTeam', team);

            const homeBtn = document.getElementById('roster-team-home-btn');
            const awayBtn = document.getElementById('roster-team-away-btn');

            if (team === 'home') {
                homeBtn.classList.add('border-emerald-500', 'bg-emerald-500', 'text-white');
                homeBtn.classList.remove('border-slate-200', 'dark:border-slate-600', 'bg-white', 'dark:bg-slate-700', 'text-slate-500', 'dark:text-slate-300');
                awayBtn.classList.remove('border-blue-500', 'bg-blue-500', 'text-white');
                awayBtn.classList.add('border-slate-200', 'dark:border-slate-600', 'bg-white', 'dark:bg-slate-700', 'text-slate-500', 'dark:text-slate-300');
            } else {
                awayBtn.classList.add('border-blue-500', 'bg-blue-500', 'text-white');
                awayBtn.classList.remove('border-slate-200', 'dark:border-slate-600', 'bg-white', 'dark:bg-slate-700', 'text-slate-500', 'dark:text-slate-300');
                homeBtn.classList.remove('border-emerald-500', 'bg-emerald-500', 'text-white');
                homeBtn.classList.add('border-slate-200', 'dark:border-slate-600', 'bg-white', 'dark:bg-slate-700', 'text-slate-500', 'dark:text-slate-300');
            }
        }

        // Initialize player tracking toggle on page load
        function initializePlayerTracking() {
            const toggle = document.getElementById('player-tracking-toggle');
            const dot = document.getElementById('player-tracking-toggle-dot');

            if (playerTrackingEnabled) {
                toggle.classList.remove('bg-slate-300', 'dark:bg-slate-600');
                toggle.classList.add('bg-emerald-500');
                dot.style.transform = 'translateX(20px)';
            }

            // Set initial team button state
            setRosterTeam(rosterTeam);
        }

        // =====================================================
        // GOAL PLAYER SELECTION
        // =====================================================

        // Show player selection modal for goals
        function showPlayerSelectionModal() {
            const container = document.getElementById('player-select-list');

            if (roster.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-slate-400">
                        <p>No players in roster</p>
                        <p class="text-sm mt-1">Add players in Manage Rosters</p>
                    </div>
                `;
            } else {
                container.innerHTML = roster.map(player => `
                    <button onclick="selectPlayerForGoal('${player.id}')" class="w-full flex items-center gap-3 p-3 bg-slate-50 dark:bg-slate-700/50 hover:bg-emerald-50 dark:hover:bg-emerald-900/30 rounded-xl mb-2 transition-colors text-left">
                        <div class="w-10 h-10 bg-emerald-100 dark:bg-emerald-900/50 rounded-full flex items-center justify-center flex-shrink-0">
                            <span class="text-emerald-700 dark:text-emerald-400 font-bold text-sm">${player.number || '-'}</span>
                        </div>
                        <span class="font-medium text-slate-800 dark:text-white">${escapeHtml(player.name)}</span>
                    </button>
                `).join('');
            }

            const modal = document.getElementById('player-select-modal-overlay');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        // Select player for goal
        window.selectPlayerForGoal = function(playerId) {
            if (pendingGoalForPlayer) {
                pendingGoalForPlayer.playerId = playerId;
                pendingGoalForPlayer.playerName = roster.find(p => p.id === playerId)?.name || null;
                finishGoalRecording();
            }
            closePlayerSelectionModal();
        }

        // Skip player selection
        window.skipPlayerSelection = function() {
            if (pendingGoalForPlayer) {
                pendingGoalForPlayer.playerId = null;
                pendingGoalForPlayer.playerName = null;
                finishGoalRecording();
            }
            closePlayerSelectionModal();
        }

        // Close player selection modal
        function closePlayerSelectionModal() {
            const modal = document.getElementById('player-select-modal-overlay');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        // Finish goal recording after player selection
        function finishGoalRecording() {
            if (!pendingGoalForPlayer) return;

            // Add player info to pending shot
            pendingShot.playerId = pendingGoalForPlayer.playerId;
            pendingShot.playerName = pendingGoalForPlayer.playerName;
            pendingGoalForPlayer = null;

            if (shotMapEnabled) {
                showShotMapModal(pendingShot.team, pendingShot.teamName, pendingShot.type);
            } else {
                completeShotRecording();
            }
        }

        // Open edit goal player modal
        window.openEditGoalPlayerModal = function(logIndex) {
            document.getElementById('edit-goal-index').value = logIndex;

            const container = document.getElementById('edit-goal-player-list');
            const currentPlayerId = gameState.log[logIndex]?.playerId;

            if (roster.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-slate-400">
                        <p>No players in roster</p>
                        <p class="text-sm mt-1">Add players in Manage Rosters</p>
                    </div>
                `;
            } else {
                container.innerHTML = roster.map(player => `
                    <button onclick="updateGoalPlayer('${player.id}')" class="w-full flex items-center gap-3 p-3 ${currentPlayerId === player.id ? 'bg-emerald-100 dark:bg-emerald-900/50' : 'bg-slate-50 dark:bg-slate-700/50'} hover:bg-emerald-50 dark:hover:bg-emerald-900/30 rounded-xl mb-2 transition-colors text-left">
                        <div class="w-10 h-10 ${currentPlayerId === player.id ? 'bg-emerald-500' : 'bg-emerald-100 dark:bg-emerald-900/50'} rounded-full flex items-center justify-center flex-shrink-0">
                            <span class="${currentPlayerId === player.id ? 'text-white' : 'text-emerald-700 dark:text-emerald-400'} font-bold text-sm">${player.number || '-'}</span>
                        </div>
                        <span class="font-medium text-slate-800 dark:text-white">${escapeHtml(player.name)}</span>
                        ${currentPlayerId === player.id ? '<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-emerald-500 ml-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>' : ''}
                    </button>
                `).join('');
            }

            const modal = document.getElementById('edit-goal-player-modal-overlay');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        // Update goal player
        window.updateGoalPlayer = function(playerId) {
            const logIndex = parseInt(document.getElementById('edit-goal-index').value);
            const player = roster.find(p => p.id === playerId);

            if (gameState.log[logIndex]) {
                gameState.log[logIndex].playerId = playerId;
                gameState.log[logIndex].playerName = player?.name || null;
                updateDisplay();
            }

            closeEditGoalPlayerModal();
        }

        // Clear goal player
        window.clearGoalPlayer = function() {
            const logIndex = parseInt(document.getElementById('edit-goal-index').value);

            if (gameState.log[logIndex]) {
                gameState.log[logIndex].playerId = null;
                gameState.log[logIndex].playerName = null;
                updateDisplay();
            }

            closeEditGoalPlayerModal();
        }

        // Close edit goal player modal
        window.closeEditGoalPlayerModal = function() {
            const modal = document.getElementById('edit-goal-player-modal-overlay');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        // =====================================================
        // HISTORY GOAL EDITING
        // =====================================================

        // Load players for a roster in history context (doesn't affect global roster state)
        async function loadHistoryRosterPlayers(rosterId) {
            try {
                const { data, error } = await supabaseClient
                    .from('players')
                    .select('*')
                    .eq('roster_id', rosterId)
                    .order('number', { ascending: true, nullsFirst: false });

                if (error) {
                    console.error('Error loading history roster players:', error);
                    return [];
                }

                return data || [];
            } catch (err) {
                console.error('Error loading history roster players:', err);
                return [];
            }
        }

        // Select a roster for history goal editing
        window.selectHistoryRoster = async function(rosterId, gameId) {
            historyEditRosterId = rosterId;
            historyEditPlayers = await loadHistoryRosterPlayers(rosterId);

            // Update the roster selector buttons
            const selectorContainer = document.getElementById(`history-roster-selector-${gameId}`);
            if (selectorContainer) {
                const buttons = selectorContainer.querySelectorAll('button');
                buttons.forEach(btn => {
                    if (btn.dataset.rosterId === rosterId) {
                        btn.classList.remove('bg-slate-100', 'dark:bg-slate-700', 'text-slate-600', 'dark:text-slate-300');
                        btn.classList.add('bg-emerald-100', 'dark:bg-emerald-900/50', 'text-emerald-700', 'dark:text-emerald-400', 'ring-1', 'ring-emerald-300', 'dark:ring-emerald-700');
                    } else {
                        btn.classList.remove('bg-emerald-100', 'dark:bg-emerald-900/50', 'text-emerald-700', 'dark:text-emerald-400', 'ring-1', 'ring-emerald-300', 'dark:ring-emerald-700');
                        btn.classList.add('bg-slate-100', 'dark:bg-slate-700', 'text-slate-600', 'dark:text-slate-300');
                    }
                });
            }

            // Update goal rows to show clickable state
            const goalRows = document.querySelectorAll(`.history-goal-row-${gameId}`);
            goalRows.forEach(row => {
                row.classList.add('cursor-pointer', 'hover:ring-2', 'hover:ring-emerald-300', 'dark:hover:ring-emerald-700');
            });
        }

        // Open history edit goal player modal
        window.openHistoryEditGoalPlayerModal = function(gameId, logIndex, currentPlayerId) {
            if (!historyEditRosterId || historyEditPlayers.length === 0) return;

            historyEditGameId = gameId;
            historyEditLogIndex = logIndex;

            const container = document.getElementById('history-edit-goal-player-list');

            container.innerHTML = historyEditPlayers.map(player => `
                <button onclick="updateHistoryGoalPlayer('${player.id}')" class="w-full flex items-center gap-3 p-3 ${currentPlayerId === player.id ? 'bg-emerald-100 dark:bg-emerald-900/50' : 'bg-slate-50 dark:bg-slate-700/50'} hover:bg-emerald-50 dark:hover:bg-emerald-900/30 rounded-xl mb-2 transition-colors text-left">
                    <div class="w-10 h-10 ${currentPlayerId === player.id ? 'bg-emerald-500' : 'bg-emerald-100 dark:bg-emerald-900/50'} rounded-full flex items-center justify-center flex-shrink-0">
                        <span class="${currentPlayerId === player.id ? 'text-white' : 'text-emerald-700 dark:text-emerald-400'} font-bold text-sm">${player.number || '-'}</span>
                    </div>
                    <span class="font-medium text-slate-800 dark:text-white">${escapeHtml(player.name)}</span>
                    ${currentPlayerId === player.id ? '<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-emerald-500 ml-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>' : ''}
                </button>
            `).join('');

            const modal = document.getElementById('history-edit-goal-player-modal-overlay');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        // Update goal player in history
        window.updateHistoryGoalPlayer = async function(playerId) {
            if (!historyEditGameId || historyEditLogIndex === null) return;

            const player = historyEditPlayers.find(p => p.id === playerId);
            if (!player) return;

            // Find the game in cache
            const game = historyGamesCache?.find(g => g.id === historyEditGameId);
            if (!game || !game.log[historyEditLogIndex]) return;

            // Update in memory
            game.log[historyEditLogIndex].playerId = playerId;
            game.log[historyEditLogIndex].playerName = player.name;

            // Persist to Supabase
            try {
                const { error } = await supabaseClient
                    .from('games')
                    .update({ shot_log: game.log })
                    .eq('id', historyEditGameId);

                if (error) {
                    console.error('Error updating goal scorer:', error);
                }
            } catch (err) {
                console.error('Error updating goal scorer:', err);
            }

            // Re-render and close
            updateGameList(historyGamesCache);
            closeHistoryEditGoalPlayerModal();

            // Re-expand the game details and re-select roster
            setTimeout(async () => {
                const gameItem = document.getElementById(`game-${historyEditGameId}`);
                if (gameItem) {
                    const expandedStats = gameItem.querySelector('.expanded-stats');
                    if (expandedStats && expandedStats.classList.contains('hidden')) {
                        toggleGameDetails(historyEditGameId);
                    }
                }
                if (historyEditRosterId) {
                    await selectHistoryRoster(historyEditRosterId, historyEditGameId);
                }
            }, 50);
        }

        // Clear goal player in history
        window.clearHistoryGoalPlayer = async function() {
            if (!historyEditGameId || historyEditLogIndex === null) return;

            const game = historyGamesCache?.find(g => g.id === historyEditGameId);
            if (!game || !game.log[historyEditLogIndex]) return;

            // Update in memory
            game.log[historyEditLogIndex].playerId = null;
            game.log[historyEditLogIndex].playerName = null;

            // Persist to Supabase
            try {
                const { error } = await supabaseClient
                    .from('games')
                    .update({ shot_log: game.log })
                    .eq('id', historyEditGameId);

                if (error) {
                    console.error('Error clearing goal scorer:', error);
                }
            } catch (err) {
                console.error('Error clearing goal scorer:', err);
            }

            // Re-render and close
            updateGameList(historyGamesCache);
            closeHistoryEditGoalPlayerModal();

            // Re-expand the game details and re-select roster
            setTimeout(async () => {
                const gameItem = document.getElementById(`game-${historyEditGameId}`);
                if (gameItem) {
                    const expandedStats = gameItem.querySelector('.expanded-stats');
                    if (expandedStats && expandedStats.classList.contains('hidden')) {
                        toggleGameDetails(historyEditGameId);
                    }
                }
                if (historyEditRosterId) {
                    await selectHistoryRoster(historyEditRosterId, historyEditGameId);
                }
            }, 50);
        }

        // Close history edit goal player modal
        window.closeHistoryEditGoalPlayerModal = function() {
            const modal = document.getElementById('history-edit-goal-player-modal-overlay');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        // Helper function to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Toggle shot map setting
        window.toggleShotMap = function() {
            shotMapEnabled = !shotMapEnabled;
            const toggle = document.getElementById('shot-map-toggle');
            const dot = document.getElementById('shot-map-toggle-dot');

            if (shotMapEnabled) {
                toggle.classList.remove('bg-slate-300');
                toggle.classList.add('bg-emerald-500');
                dot.style.transform = 'translateX(20px)';
            } else {
                toggle.classList.add('bg-slate-300');
                toggle.classList.remove('bg-emerald-500');
                dot.style.transform = 'translateX(0)';
            }
        }

        // =====================================================
        // WAKE LOCK FUNCTIONS
        // =====================================================

        // Toggle wake lock setting
        window.toggleWakeLock = async function() {
            wakeLockEnabled = !wakeLockEnabled;
            localStorage.setItem('wakeLockEnabled', wakeLockEnabled);
            updateWakeLockToggleUI();

            if (wakeLockEnabled) {
                await requestWakeLock();
            } else {
                await releaseWakeLock();
            }
        }

        // Update wake lock toggle UI
        function updateWakeLockToggleUI() {
            const toggle = document.getElementById('wake-lock-toggle');
            const dot = document.getElementById('wake-lock-toggle-dot');

            if (!toggle || !dot) return;

            if (wakeLockEnabled) {
                toggle.classList.remove('bg-slate-300');
                toggle.classList.add('bg-emerald-500');
                dot.style.transform = 'translateX(20px)';
            } else {
                toggle.classList.add('bg-slate-300');
                toggle.classList.remove('bg-emerald-500');
                dot.style.transform = 'translateX(0)';
            }
        }

        // Request wake lock
        async function requestWakeLock() {
            if (!('wakeLock' in navigator)) {
                console.log('Wake Lock API not supported');
                return;
            }

            try {
                wakeLock = await navigator.wakeLock.request('screen');
                console.log('Wake lock acquired');

                // Re-acquire wake lock if released (e.g., when tab becomes visible again)
                wakeLock.addEventListener('release', () => {
                    console.log('Wake lock released');
                    wakeLock = null;
                });
            } catch (err) {
                console.log('Wake lock request failed:', err.message);
            }
        }

        // Release wake lock
        async function releaseWakeLock() {
            if (wakeLock) {
                try {
                    await wakeLock.release();
                    wakeLock = null;
                    console.log('Wake lock released');
                } catch (err) {
                    console.log('Wake lock release failed:', err.message);
                }
            }
        }

        // Re-acquire wake lock when page becomes visible again
        document.addEventListener('visibilitychange', async () => {
            if (document.visibilityState === 'visible' && wakeLockEnabled && !wakeLock) {
                await requestWakeLock();
            }
        });

        // Flip field sides (swap Home and Away positions on the field)
        window.flipFieldSides = function() {
            fieldSidesFlipped = !fieldSidesFlipped;
            updateFieldSidesLabel();
            updateFieldTeamLabels();

            // Redraw previous shots with transposed positions
            drawPreviousShots();

            // Re-render heat map if enabled
            const toggle = document.getElementById('heat-map-toggle');
            if (toggle && toggle.checked) {
                renderHeatMap();
            }

            // Transpose current marker position if one is selected
            if (selectedShotPosition) {
                selectedShotPosition.x = 105 - selectedShotPosition.x;
                selectedShotPosition.y = 68 - selectedShotPosition.y;
                const marker = document.getElementById('shot-marker');
                marker.setAttribute('transform', `translate(${selectedShotPosition.x}, ${selectedShotPosition.y})`);

                // Update zone display
                const zone = getFieldZone(selectedShotPosition.x, selectedShotPosition.y);
                document.getElementById('shot-position-display').textContent = `Position: ${zone}`;
            }
        }

        // Update the field sides label text
        function updateFieldSidesLabel() {
            const label = document.getElementById('field-sides-label');
            if (label) {
                if (fieldSidesFlipped) {
                    label.textContent = 'Home: Right  Away: Left';
                } else {
                    label.textContent = 'Home: Left  Away: Right';
                }
            }
        }

        // Update the team labels on the field SVG
        function updateFieldTeamLabels() {
            const homeLabel = document.getElementById('field-home-label');
            const awayLabel = document.getElementById('field-away-label');
            if (!homeLabel || !awayLabel) return;

            const homeName = document.getElementById('home-team-input').value || 'HOME';
            const awayName = document.getElementById('away-team-input').value || 'AWAY';

            // homeLabel is on the left, awayLabel is on the right
            if (fieldSidesFlipped) {
                homeLabel.textContent = awayName.toUpperCase();
                awayLabel.textContent = homeName.toUpperCase();
            } else {
                homeLabel.textContent = homeName.toUpperCase();
                awayLabel.textContent = awayName.toUpperCase();
            }
        }

        // =====================================================
        // HEAT MAP FUNCTIONS (custom canvas implementation)
        // =====================================================

        // Toggle heat map display
        window.toggleHeatMap = function() {
            const toggle = document.getElementById('heat-map-toggle');
            heatMapEnabled = toggle.checked;
            localStorage.setItem('heatMapEnabled', heatMapEnabled);

            const canvas = document.getElementById('heat-map-canvas');
            const teamFilterDiv = document.getElementById('heat-map-team-filter');

            if (heatMapEnabled) {
                if (canvas) canvas.style.display = 'block';
                if (teamFilterDiv) teamFilterDiv.style.display = 'flex';
                updateHeatMapFilterButtons();
                renderHeatMap();
            } else {
                if (canvas) canvas.style.display = 'none';
                if (teamFilterDiv) teamFilterDiv.style.display = 'none';
            }
        }

        // Update heat map controls based on shot counts
        function updateHeatMapControls() {
            const toggle = document.getElementById('heat-map-toggle');
            const status = document.getElementById('heat-map-status');
            const canvas = document.getElementById('heat-map-canvas');
            const teamFilterDiv = document.getElementById('heat-map-team-filter');
            const filterHomeBtn = document.getElementById('heat-map-filter-home');
            const filterAwayBtn = document.getElementById('heat-map-filter-away');

            if (!toggle || !status) return;

            // Count shots with positions per team
            const shotsWithPositions = gameState.log.filter(s => s.position);
            const homeShots = shotsWithPositions.filter(s => s.team === 'home').length;
            const awayShots = shotsWithPositions.filter(s => s.team === 'away').length;
            const totalShots = shotsWithPositions.length;

            const homeHasEnough = homeShots >= HEAT_MAP_MIN_SHOTS;
            const awayHasEnough = awayShots >= HEAT_MAP_MIN_SHOTS;
            const anyTeamHasEnough = homeHasEnough || awayHasEnough;

            if (anyTeamHasEnough) {
                toggle.disabled = false;
                status.textContent = `(${totalShots} shots)`;
                status.classList.remove('text-slate-400');
                status.classList.add('text-emerald-500');

                // Update team filter buttons
                if (filterHomeBtn) {
                    filterHomeBtn.disabled = !homeHasEnough;
                    filterHomeBtn.title = homeHasEnough ? '' : `${homeShots}/${HEAT_MAP_MIN_SHOTS} shots`;
                }
                if (filterAwayBtn) {
                    filterAwayBtn.disabled = !awayHasEnough;
                    filterAwayBtn.title = awayHasEnough ? '' : `${awayShots}/${HEAT_MAP_MIN_SHOTS} shots`;
                }

                // If current filter is invalid, switch to a valid one
                if (heatMapTeamFilter === 'all' || (heatMapTeamFilter === 'home' && !homeHasEnough)) {
                    heatMapTeamFilter = homeHasEnough ? 'home' : 'away';
                    localStorage.setItem('heatMapTeamFilter', heatMapTeamFilter);
                } else if (heatMapTeamFilter === 'away' && !awayHasEnough) {
                    heatMapTeamFilter = homeHasEnough ? 'home' : 'away';
                    localStorage.setItem('heatMapTeamFilter', heatMapTeamFilter);
                }

                updateHeatMapFilterButtons();

                // Restore user preference if heat map should be enabled
                if (heatMapEnabled) {
                    toggle.checked = true;
                    if (teamFilterDiv) teamFilterDiv.style.display = 'flex';
                    if (canvas) {
                        canvas.style.display = 'block';
                        renderHeatMap();
                    }
                }
            } else {
                toggle.disabled = true;
                toggle.checked = false;
                status.textContent = `(${totalShots}/${HEAT_MAP_MIN_SHOTS} shots)`;
                status.classList.add('text-slate-400');
                status.classList.remove('text-emerald-500');

                // Hide heat map and team filter
                if (canvas) {
                    canvas.style.display = 'none';
                }
                if (teamFilterDiv) {
                    teamFilterDiv.style.display = 'none';
                }
            }
        }

        // Update the visual state of team filter buttons
        function updateHeatMapFilterButtons() {
            const filterHomeBtn = document.getElementById('heat-map-filter-home');
            const filterAwayBtn = document.getElementById('heat-map-filter-away');

            const buttons = [
                { btn: filterHomeBtn, filter: 'home' },
                { btn: filterAwayBtn, filter: 'away' }
            ];

            buttons.forEach(({ btn, filter }) => {
                if (!btn) return;
                if (heatMapTeamFilter === filter && !btn.disabled) {
                    btn.classList.remove('bg-slate-200', 'text-slate-600', 'hover:bg-slate-300');
                    btn.classList.add('bg-orange-500', 'text-white');
                } else {
                    btn.classList.remove('bg-orange-500', 'text-white');
                    btn.classList.add('bg-slate-200', 'text-slate-600', 'hover:bg-slate-300');
                }
            });
        }

        // Set the heat map team filter
        window.setHeatMapTeamFilter = function(filter) {
            heatMapTeamFilter = filter;
            localStorage.setItem('heatMapTeamFilter', filter);
            updateHeatMapFilterButtons();
            if (heatMapEnabled) {
                renderHeatMap();
            }
        }

        // Render heat map on canvas
        // Helper function to check if a position is inside either penalty box (18-yard box)
        // Left penalty box: x <= 17, y between 13.84 and 54.16
        // Right penalty box: x >= 88, y between 13.84 and 54.16
        function isInPenaltyBox(x, y) {
            const inYRange = y >= 13.84 && y <= 54.16;
            const inLeftBox = x <= 17 && inYRange;
            const inRightBox = x >= 88 && inYRange;
            return inLeftBox || inRightBox;
        }

        // Helper function to check if a shot is clustered (has nearby shots)
        // Returns true if at least 1 other shot is within clusterRadius
        function isClusteredShot(shotIndex, allShotPositions, clusterRadius = 9) {
            const shot = allShotPositions[shotIndex];
            for (let i = 0; i < allShotPositions.length; i++) {
                if (i === shotIndex) continue;
                const other = allShotPositions[i];
                const distance = Math.sqrt(Math.pow(other.x - shot.x, 2) + Math.pow(other.y - shot.y, 2));
                if (distance <= clusterRadius) {
                    return true;
                }
            }
            return false;
        }

        function renderHeatMap(shots = null) {
            const canvas = document.getElementById('heat-map-canvas');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const container = canvas.parentElement;
            if (!container) return;

            // Set canvas size to match container
            const rect = container.getBoundingClientRect();

            // Skip if container has no dimensions (not visible yet)
            if (rect.width === 0 || rect.height === 0) return;

            canvas.width = rect.width * window.devicePixelRatio;
            canvas.height = rect.height * window.devicePixelRatio;
            ctx.scale(window.devicePixelRatio, window.devicePixelRatio);

            // Clear canvas
            ctx.clearRect(0, 0, rect.width, rect.height);

            // Get shots with valid positions (must have numeric x and y)
            let shotData = (shots || gameState.log).filter(s =>
                s.position &&
                typeof s.position.x === 'number' &&
                typeof s.position.y === 'number' &&
                !isNaN(s.position.x) &&
                !isNaN(s.position.y)
            );

            // Apply team filter
            if (heatMapTeamFilter === 'home') {
                shotData = shotData.filter(s => s.team === 'home');
            } else if (heatMapTeamFilter === 'away') {
                shotData = shotData.filter(s => s.team === 'away');
            }

            if (shotData.length < HEAT_MAP_MIN_SHOTS) return;

            // Field dimensions (SVG viewBox: 105 x 68)
            const fieldWidth = 105;
            const fieldHeight = 68;
            const scaleX = rect.width / fieldWidth;
            const scaleY = rect.height / fieldHeight;

            // Heat map parameters
            const gridSize = 3; // Size of each grid cell in field units
            const radius = 12; // Influence radius for each shot
            const maxIntensity = 8; // Cap for color scaling
            const clusterRadius = 9; // Distance to consider shots as clustered (~9 yards)
            const isolatedShotMultiplier = 0.35; // Reduce isolated shots to 35% intensity
            const penaltyBoxMultiplier = 1.5; // Boost for shots in penalty box

            // Create density grid
            const cols = Math.ceil(fieldWidth / gridSize);
            const rows = Math.ceil(fieldHeight / gridSize);
            const grid = Array(rows).fill(null).map(() => Array(cols).fill(0));

            // Preprocess shot positions (apply flips, filter invalid)
            const processedShots = [];
            shotData.forEach(shot => {
                let x = shot.position.x;
                let y = shot.position.y;

                // Apply transposition if sides are flipped
                if (fieldSidesFlipped) {
                    x = 105 - x;
                    y = 68 - y;
                }

                const isOffTarget = shot.type === 'Shot Off Target';
                // Skip off-target shots not in the attacking half (x > 52.5)
                if (isOffTarget && x <= 52.5) return;

                processedShots.push({ x, y, type: shot.type });
            });

            // Calculate density for each grid cell
            processedShots.forEach((shot, index) => {
                // Determine base weight based on shot type
                // Goals and shots on target have full weight, off-target shots at 0.6
                let weight = 1.0;
                const isOffTarget = shot.type === 'Shot Off Target';
                if (isOffTarget) {
                    weight = 0.6; // Increased weight for off-target shots (was 0.4)
                }

                // Apply cluster multiplier (isolated shots reduced to 35%)
                const isClustered = isClusteredShot(index, processedShots, clusterRadius);
                if (!isClustered) {
                    weight *= isolatedShotMultiplier;
                }

                // Apply penalty box multiplier (1.5x for shots in the box)
                if (isInPenaltyBox(shot.x, shot.y)) {
                    weight *= penaltyBoxMultiplier;
                }

                // Add influence to nearby grid cells
                for (let row = 0; row < rows; row++) {
                    for (let col = 0; col < cols; col++) {
                        const cellX = (col + 0.5) * gridSize;
                        const cellY = (row + 0.5) * gridSize;
                        const distance = Math.sqrt(Math.pow(cellX - shot.x, 2) + Math.pow(cellY - shot.y, 2));

                        if (distance < radius) {
                            // Gaussian-like falloff, weighted by shot type
                            const influence = Math.exp(-Math.pow(distance / (radius / 2), 2)) * weight;
                            grid[row][col] += influence;
                        }
                    }
                }
            });

            // Find max density for normalization
            let maxDensity = 0;
            grid.forEach(row => row.forEach(val => { if (val > maxDensity) maxDensity = val; }));
            if (maxDensity === 0) return;

            // Draw heat map with blur using CSS filter on canvas element
            // Reset transform for drawing
            ctx.setTransform(1, 0, 0, 1, 0, 0);

            // Use a finer resolution for smoother appearance
            const dpr = window.devicePixelRatio;

            for (let row = 0; row < rows; row++) {
                for (let col = 0; col < cols; col++) {
                    const density = grid[row][col];
                    if (density > 0.01) { // Lower threshold for smoother gradients
                        // Normalize based on actual max density for full color range
                        const normalizedDensity = Math.min(density / maxDensity, 1);
                        const color = getHeatMapColor(normalizedDensity);

                        ctx.fillStyle = color;

                        // Draw with device pixel ratio scaling
                        const x = col * gridSize * scaleX * dpr;
                        const y = row * gridSize * scaleY * dpr;
                        const w = (gridSize * scaleX + 1) * dpr;
                        const h = (gridSize * scaleY + 1) * dpr;

                        ctx.fillRect(x, y, w, h);
                    }
                }
            }

            // Apply CSS blur filter to canvas element for smooth appearance
            canvas.style.filter = 'blur(6px)';
        }

        // Get color for heat map based on intensity (0-1)
        function getHeatMapColor(intensity) {
            // Color gradient shifted toward warmer colors
            const colors = [
                { pos: 0, r: 0, g: 150, b: 255 },    // Light blue
                { pos: 0.15, r: 0, g: 255, b: 200 }, // Cyan-green
                { pos: 0.3, r: 100, g: 255, b: 0 },  // Yellow-green
                { pos: 0.45, r: 255, g: 255, b: 0 }, // Yellow
                { pos: 0.6, r: 255, g: 180, b: 0 },  // Yellow-orange
                { pos: 0.75, r: 255, g: 100, b: 0 }, // Orange
                { pos: 1, r: 255, g: 0, b: 0 }       // Red
            ];

            // Find the two colors to interpolate between
            let lower = colors[0];
            let upper = colors[colors.length - 1];

            for (let i = 0; i < colors.length - 1; i++) {
                if (intensity >= colors[i].pos && intensity <= colors[i + 1].pos) {
                    lower = colors[i];
                    upper = colors[i + 1];
                    break;
                }
            }

            // Interpolate
            const range = upper.pos - lower.pos;
            const t = range > 0 ? (intensity - lower.pos) / range : 0;

            const r = Math.round(lower.r + (upper.r - lower.r) * t);
            const g = Math.round(lower.g + (upper.g - lower.g) * t);
            const b = Math.round(lower.b + (upper.b - lower.b) * t);

            // Alpha based on intensity (more intense = more opaque)
            const alpha = 0.3 + intensity * 0.5;

            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }

        // Track history heat map team filters per game
        const historyHeatMapFilters = {};

        // Toggle heat map for history view
        window.toggleHistoryHeatMap = function(gameId, enabled) {
            const canvas = document.getElementById(`history-heat-map-${gameId}`);
            const teamFilterDiv = document.getElementById(`history-heat-map-filter-${gameId}`);
            if (!canvas) return;

            if (enabled) {
                canvas.style.display = 'block';
                if (teamFilterDiv) teamFilterDiv.style.display = 'flex';

                // Initialize filter if not set
                if (!historyHeatMapFilters[gameId]) {
                    historyHeatMapFilters[gameId] = 'home';
                }

                // Find the game data and render (check team cache first, then fetch)
                const cachedGame = (teamGamesCache || []).concat(historyGamesCache || []).find(g => g.id === gameId);
                if (cachedGame && cachedGame.log) {
                    const shotsWithPositions = cachedGame.log.filter(s => s.position);
                    updateHistoryHeatMapFilterButtons(gameId, shotsWithPositions);
                    renderHistoryHeatMap(gameId, shotsWithPositions);
                } else {
                    getSavedGames(currentTeamId).then(games => {
                        const game = games.find(g => g.id === gameId);
                        if (game && game.log) {
                            const shotsWithPositions = game.log.filter(s => s.position);
                            updateHistoryHeatMapFilterButtons(gameId, shotsWithPositions);
                            renderHistoryHeatMap(gameId, shotsWithPositions);
                        }
                    });
                }
            } else {
                canvas.style.display = 'none';
                if (teamFilterDiv) teamFilterDiv.style.display = 'none';
            }
        }

        // Set team filter for history heat map
        window.setHistoryHeatMapFilter = function(gameId, filter) {
            historyHeatMapFilters[gameId] = filter;

            // Update button styles
            const homeBtn = document.getElementById(`history-filter-home-${gameId}`);
            const awayBtn = document.getElementById(`history-filter-away-${gameId}`);

            [homeBtn, awayBtn].forEach(btn => {
                if (!btn) return;
                btn.classList.remove('bg-orange-500', 'text-white');
                btn.classList.add('bg-slate-200', 'dark:bg-slate-600', 'text-slate-600', 'dark:text-slate-300');
            });

            const activeBtn = filter === 'home' ? homeBtn : awayBtn;
            if (activeBtn && !activeBtn.disabled) {
                activeBtn.classList.remove('bg-slate-200', 'dark:bg-slate-600', 'text-slate-600', 'dark:text-slate-300');
                activeBtn.classList.add('bg-orange-500', 'text-white');
            }

            // Re-render heat map (check caches first, then fetch)
            const cachedGame = (teamGamesCache || []).concat(historyGamesCache || []).find(g => g.id === gameId);
            if (cachedGame && cachedGame.log) {
                const shotsWithPositions = cachedGame.log.filter(s => s.position);
                renderHistoryHeatMap(gameId, shotsWithPositions);
            } else {
                getSavedGames(currentTeamId).then(games => {
                    const game = games.find(g => g.id === gameId);
                    if (game && game.log) {
                        const shotsWithPositions = game.log.filter(s => s.position);
                        renderHistoryHeatMap(gameId, shotsWithPositions);
                    }
                });
            }
        }

        // Update history heat map filter buttons based on shot counts
        function updateHistoryHeatMapFilterButtons(gameId, shots) {
            const homeShots = shots.filter(s => s.team === 'home').length;
            const awayShots = shots.filter(s => s.team === 'away').length;

            const homeBtn = document.getElementById(`history-filter-home-${gameId}`);
            const awayBtn = document.getElementById(`history-filter-away-${gameId}`);

            const homeHasEnough = homeShots >= HEAT_MAP_MIN_SHOTS;
            const awayHasEnough = awayShots >= HEAT_MAP_MIN_SHOTS;

            if (homeBtn) {
                homeBtn.disabled = !homeHasEnough;
                homeBtn.title = homeHasEnough ? '' : `${homeShots}/10 shots`;
            }
            if (awayBtn) {
                awayBtn.disabled = !awayHasEnough;
                awayBtn.title = awayHasEnough ? '' : `${awayShots}/10 shots`;
            }

            // If current filter is invalid, switch to a valid one
            let currentFilter = historyHeatMapFilters[gameId] || 'home';
            if (currentFilter === 'all' || (currentFilter === 'home' && !homeHasEnough)) {
                currentFilter = homeHasEnough ? 'home' : 'away';
                historyHeatMapFilters[gameId] = currentFilter;
            } else if (currentFilter === 'away' && !awayHasEnough) {
                currentFilter = homeHasEnough ? 'home' : 'away';
                historyHeatMapFilters[gameId] = currentFilter;
            }

            // Update button styles
            [homeBtn, awayBtn].forEach(btn => {
                if (!btn) return;
                btn.classList.remove('bg-orange-500', 'text-white');
                btn.classList.add('bg-slate-200', 'dark:bg-slate-600', 'text-slate-600', 'dark:text-slate-300');
            });

            const activeBtn = currentFilter === 'home' ? homeBtn : awayBtn;
            if (activeBtn && !activeBtn.disabled) {
                activeBtn.classList.remove('bg-slate-200', 'dark:bg-slate-600', 'text-slate-600', 'dark:text-slate-300');
                activeBtn.classList.add('bg-orange-500', 'text-white');
            }
        }

        // Render heat map for history view
        function renderHistoryHeatMap(gameId, shots) {
            const canvas = document.getElementById(`history-heat-map-${gameId}`);
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const container = document.getElementById(`history-field-${gameId}`);
            if (!container) return;

            // Set canvas size to match container
            const rect = container.getBoundingClientRect();

            // Skip if container has no dimensions (not visible yet)
            if (rect.width === 0 || rect.height === 0) return;

            canvas.width = rect.width * window.devicePixelRatio;
            canvas.height = rect.height * window.devicePixelRatio;
            ctx.scale(window.devicePixelRatio, window.devicePixelRatio);

            // Clear canvas
            ctx.clearRect(0, 0, rect.width, rect.height);

            // Filter shots to only include valid positions
            let validShots = shots.filter(s =>
                s.position &&
                typeof s.position.x === 'number' &&
                typeof s.position.y === 'number' &&
                !isNaN(s.position.x) &&
                !isNaN(s.position.y)
            );

            // Apply team filter
            const teamFilter = historyHeatMapFilters[gameId] || 'home';
            if (teamFilter === 'home') {
                validShots = validShots.filter(s => s.team === 'home');
            } else if (teamFilter === 'away') {
                validShots = validShots.filter(s => s.team === 'away');
            }

            if (validShots.length < HEAT_MAP_MIN_SHOTS) return;

            // Field dimensions (SVG viewBox: 105 x 68)
            const fieldWidth = 105;
            const fieldHeight = 68;
            const scaleX = rect.width / fieldWidth;
            const scaleY = rect.height / fieldHeight;

            // Heat map parameters
            const gridSize = 3;
            const radius = 12;
            const maxIntensity = 8;
            const clusterRadius = 9; // Distance to consider shots as clustered (~9 yards)
            const isolatedShotMultiplier = 0.35; // Reduce isolated shots to 35% intensity
            const penaltyBoxMultiplier = 1.5; // Boost for shots in penalty box

            // Create density grid
            const cols = Math.ceil(fieldWidth / gridSize);
            const rows = Math.ceil(fieldHeight / gridSize);
            const grid = Array(rows).fill(null).map(() => Array(cols).fill(0));

            // Preprocess shot positions (normalize half, filter invalid)
            const processedShots = [];
            validShots.forEach(shot => {
                // Normalize second-half shots to face the same goal as first-half shots
                const x = shot.half === 2 ? (105 - shot.position.x) : shot.position.x;
                const y = shot.half === 2 ? (68 - shot.position.y) : shot.position.y;

                const isOffTarget = shot.type === 'Shot Off Target';
                // Skip off-target shots not in the attacking half (x > 52.5)
                if (isOffTarget && x <= 52.5) return;

                processedShots.push({ x, y, type: shot.type });
            });

            // Calculate density for each grid cell
            processedShots.forEach((shot, index) => {
                // Determine base weight based on shot type
                // Goals and shots on target have full weight, off-target shots at 0.6
                let weight = 1.0;
                const isOffTarget = shot.type === 'Shot Off Target';
                if (isOffTarget) {
                    weight = 0.6; // Increased weight for off-target shots (was 0.4)
                }

                // Apply cluster multiplier (isolated shots reduced to 35%)
                const isClustered = isClusteredShot(index, processedShots, clusterRadius);
                if (!isClustered) {
                    weight *= isolatedShotMultiplier;
                }

                // Apply penalty box multiplier (1.5x for shots in the box)
                if (isInPenaltyBox(shot.x, shot.y)) {
                    weight *= penaltyBoxMultiplier;
                }

                for (let row = 0; row < rows; row++) {
                    for (let col = 0; col < cols; col++) {
                        const cellX = (col + 0.5) * gridSize;
                        const cellY = (row + 0.5) * gridSize;
                        const distance = Math.sqrt(Math.pow(cellX - shot.x, 2) + Math.pow(cellY - shot.y, 2));

                        if (distance < radius) {
                            const influence = Math.exp(-Math.pow(distance / (radius / 2), 2)) * weight;
                            grid[row][col] += influence;
                        }
                    }
                }
            });

            // Find max density
            let maxDensity = 0;
            grid.forEach(row => row.forEach(val => { if (val > maxDensity) maxDensity = val; }));
            if (maxDensity === 0) return;

            // Reset transform for drawing
            ctx.setTransform(1, 0, 0, 1, 0, 0);
            const dpr = window.devicePixelRatio;

            // Draw heat map
            for (let row = 0; row < rows; row++) {
                for (let col = 0; col < cols; col++) {
                    const density = grid[row][col];
                    if (density > 0.01) {
                        // Normalize based on actual max density for full color range
                        const normalizedDensity = Math.min(density / maxDensity, 1);
                        const color = getHeatMapColor(normalizedDensity);

                        ctx.fillStyle = color;
                        const x = col * gridSize * scaleX * dpr;
                        const y = row * gridSize * scaleY * dpr;
                        const w = (gridSize * scaleX + 1) * dpr;
                        const h = (gridSize * scaleY + 1) * dpr;

                        ctx.fillRect(x, y, w, h);
                    }
                }
            }

            // Apply CSS blur filter to canvas element for smooth appearance
            canvas.style.filter = 'blur(6px)';
        }

        // Format seconds to MM:SS
        function formatTime(totalSeconds) {
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // Toggle clock start/pause
        function toggleClock() {
            if (clockState.isRunning) {
                pauseClock();
            } else {
                startClock();
            }
        }

        // Start the clock
        function startClock() {
            clockState.isRunning = true;
            clockState.intervalId = setInterval(() => {
                clockState.seconds++;
                updateClockDisplay();
            }, 1000);
            updateClockDisplay();
        }

        // Pause the clock
        function pauseClock() {
            clockState.isRunning = false;
            if (clockState.intervalId) {
                clearInterval(clockState.intervalId);
                clockState.intervalId = null;
            }
            updateClockDisplay();
        }

        // Reset the clock
        function resetClock() {
            pauseClock();
            clockState.seconds = 0;
            updateClockDisplay();
        }

        // Update clock display
        function updateClockDisplay() {
            document.getElementById('clock-display').textContent = formatTime(clockState.seconds);

            const startBtn = document.getElementById('clock-start-btn');
            const statusDot = document.getElementById('clock-status-dot');
            const statusText = document.getElementById('clock-status-text');

            if (clockState.isRunning) {
                startBtn.textContent = 'Pause';
                startBtn.classList.remove('bg-emerald-500', 'hover:bg-emerald-600');
                startBtn.classList.add('bg-amber-500', 'hover:bg-amber-600');
                statusDot.classList.add('bg-emerald-500', 'animate-pulse-dot');
                statusDot.classList.remove('bg-slate-500', 'bg-amber-500');
                statusText.textContent = 'Running';
            } else {
                startBtn.textContent = clockState.seconds > 0 ? 'Resume' : 'Start';
                startBtn.classList.add('bg-emerald-500', 'hover:bg-emerald-600');
                startBtn.classList.remove('bg-amber-500', 'hover:bg-amber-600');
                statusDot.classList.remove('bg-emerald-500', 'animate-pulse-dot');
                if (clockState.seconds > 0) {
                    statusDot.classList.add('bg-amber-500');
                    statusDot.classList.remove('bg-slate-500');
                    statusText.textContent = 'Paused';
                } else {
                    statusDot.classList.add('bg-slate-500');
                    statusDot.classList.remove('bg-amber-500');
                    statusText.textContent = 'Stopped';
                }
            }
        }

        // Get current game time string
        function getGameTime() {
            return formatTime(clockState.seconds);
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            // First, check if user is already logged in
            checkAuthState();

            // Set up event listeners (these work regardless of auth state)
            setupEventListeners();
        });

        // Initialize the main app UI (called after successful login)
        function initializeApp() {
            try {
                document.getElementById('game-date').value = new Date().toISOString().split('T')[0];
                updateClockDisplay();

                // Restore wake lock state from localStorage
                if (wakeLockEnabled) {
                    updateWakeLockToggleUI();
                    requestWakeLock();
                }
            } catch (e) {
                console.error('Initialization error:', e);
            }
        }

        function setupEventListeners() {
            console.log('Setting up event listeners...');

            // Team name input listeners
            const homeInput = document.getElementById('home-team-input');
            const awayInput = document.getElementById('away-team-input');
            const homeNameDisplay = document.getElementById('home-name-display');
            const awayNameDisplay = document.getElementById('away-name-display');
            const homePanelTitle = document.getElementById('home-panel-title');
            const awayPanelTitle = document.getElementById('away-panel-title');

            console.log('Elements found:', {
                homeInput: !!homeInput,
                awayInput: !!awayInput,
                homeNameDisplay: !!homeNameDisplay,
                awayNameDisplay: !!awayNameDisplay
            });

            if (homeInput && homeNameDisplay && homePanelTitle) {
                homeInput.addEventListener('input', function(e) {
                    const name = e.target.value || 'Home Team';
                    console.log('Home team input changed:', name);
                    homeNameDisplay.textContent = name;
                    homePanelTitle.innerHTML = `<span class="w-3 h-3 rounded-full bg-emerald-500 inline-block mr-2"></span>${name}`;
                });
            }

            if (awayInput && awayNameDisplay && awayPanelTitle) {
                awayInput.addEventListener('input', function(e) {
                    const name = e.target.value || 'Away Team';
                    console.log('Away team input changed:', name);
                    awayNameDisplay.textContent = name;
                    awayPanelTitle.innerHTML = `<span class="w-3 h-3 rounded-full bg-blue-500 inline-block mr-2"></span>${name}`;
                });
            }

            // Color picker event listeners
            const homeColor = document.getElementById('home-color');
            const awayColor = document.getElementById('away-color');

            if (homeColor) {
                homeColor.addEventListener('input', applyTeamColors);
            }
            if (awayColor) {
                awayColor.addEventListener('input', applyTeamColors);
            }

            // Clock button listeners
            const clockStartBtn = document.getElementById('clock-start-btn');
            const clockResetBtn = document.getElementById('clock-reset-btn');

            console.log('Clock buttons found:', {
                startBtn: !!clockStartBtn,
                resetBtn: !!clockResetBtn
            });

            if (clockStartBtn) {
                clockStartBtn.addEventListener('click', function() {
                    console.log('Start button clicked');
                    toggleClock();
                });
            }
            if (clockResetBtn) {
                clockResetBtn.addEventListener('click', function() {
                    console.log('Reset button clicked');
                    resetClock();
                });
            }

            // Apply initial colors
            applyTeamColors();
            console.log('Event listeners setup complete');
        }

        // Apply team colors to UI elements
        function applyTeamColors() {
            const homeColor = document.getElementById('home-color').value;
            const awayColor = document.getElementById('away-color').value;

            // Update home team elements
            const homePanel = document.querySelector('.team-panel.home');
            const homePanelTitle = document.getElementById('home-panel-title');
            const homeBadge = document.querySelector('.home-team .team-badge');
            const homeScore = document.querySelector('.home-team .score');

            if (homePanel) homePanel.style.borderTopColor = homeColor;
            if (homePanelTitle) {
                homePanelTitle.style.color = homeColor;
                // Update the bullet/dot color
                const homeBullet = homePanelTitle.querySelector('span');
                if (homeBullet) homeBullet.style.backgroundColor = homeColor;
            }
            if (homeBadge) {
                homeBadge.style.backgroundColor = hexToRgba(homeColor, 0.2);
                homeBadge.style.color = homeColor;
            }
            if (homeScore) homeScore.style.color = homeColor;

            // Update away team elements
            const awayPanel = document.querySelector('.team-panel.away');
            const awayPanelTitle = document.getElementById('away-panel-title');
            const awayBadge = document.querySelector('.away-team .team-badge');
            const awayScore = document.querySelector('.away-team .score');

            if (awayPanel) awayPanel.style.borderTopColor = awayColor;
            if (awayPanelTitle) {
                awayPanelTitle.style.color = awayColor;
                // Update the bullet/dot color
                const awayBullet = awayPanelTitle.querySelector('span');
                if (awayBullet) awayBullet.style.backgroundColor = awayColor;
            }
            if (awayBadge) {
                awayBadge.style.backgroundColor = hexToRgba(awayColor, 0.2);
                awayBadge.style.color = awayColor;
            }
            if (awayScore) awayScore.style.color = awayColor;

            // Update log entries
            updateLogColors();
        }

        // Update log entry colors
        function updateLogColors() {
            const homeColor = document.getElementById('home-color').value;
            const awayColor = document.getElementById('away-color').value;

            document.querySelectorAll('.log-entry.home').forEach(entry => {
                entry.style.background = hexToRgba(homeColor, 0.1);
                entry.style.borderLeftColor = homeColor;
            });

            document.querySelectorAll('.log-entry.away').forEach(entry => {
                entry.style.background = hexToRgba(awayColor, 0.1);
                entry.style.borderLeftColor = awayColor;
            });
        }

        // Convert hex color to rgba
        function hexToRgba(hex, alpha) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }

        // Set current half
        window.setHalf = function(half) {
            gameState.currentHalf = half;
            const half1Btn = document.getElementById('half-1-btn');
            const half2Btn = document.getElementById('half-2-btn');

            if (half === 1) {
                half1Btn.classList.add('border-emerald-500', 'bg-emerald-500', 'text-white');
                half1Btn.classList.remove('border-slate-200', 'bg-white', 'text-slate-500', 'dark:border-slate-600', 'dark:bg-slate-700', 'dark:text-slate-300');
                half2Btn.classList.remove('border-emerald-500', 'bg-emerald-500', 'text-white');
                half2Btn.classList.add('border-slate-200', 'bg-white', 'text-slate-500', 'dark:border-slate-600', 'dark:bg-slate-700', 'dark:text-slate-300');
            } else {
                half2Btn.classList.add('border-emerald-500', 'bg-emerald-500', 'text-white');
                half2Btn.classList.remove('border-slate-200', 'bg-white', 'text-slate-500', 'dark:border-slate-600', 'dark:bg-slate-700', 'dark:text-slate-300');
                half1Btn.classList.remove('border-emerald-500', 'bg-emerald-500', 'text-white');
                half1Btn.classList.add('border-slate-200', 'bg-white', 'text-slate-500', 'dark:border-slate-600', 'dark:bg-slate-700', 'dark:text-slate-300');
            }
        }

        // =====================================================
        // NAVIGATION FUNCTIONS
        // =====================================================

        function hideAllViews() {
            document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
        }

        function hideNavTabs() {
            document.getElementById('main-nav').style.display = 'none';
        }

        function showNavTabs() {
            document.getElementById('main-nav').style.display = 'flex';
        }

        window.navigateToHome = function() {
            hideAllViews();
            hideNavTabs();
            document.getElementById('home-view').classList.remove('hidden');
            currentTeamId = null;
            currentTeam = null;
            loadTeams();
        }

        window.navigateToTeamDashboard = async function(teamId) {
            if (!teamId) return;
            currentTeamId = teamId;
            currentTeam = teams.find(t => t.id === teamId) || null;

            hideAllViews();
            hideNavTabs();
            document.getElementById('team-view').classList.remove('hidden');

            // Populate header
            if (currentTeam) {
                document.getElementById('team-name-display').textContent = currentTeam.name;
                document.getElementById('team-color-dot').style.backgroundColor = currentTeam.color || '#10b981';
            }

            // Load data
            await Promise.all([loadTeamRoster(), loadTeamGames()]);

            // Default to history tab
            switchTeamTab('history');
        }

        window.navigateToGameSetup = function() {
            hideAllViews();
            hideNavTabs();
            document.getElementById('game-setup-view').classList.remove('hidden');

            // Pre-fill form
            document.getElementById('setup-game-date').valueAsDate = new Date();
            document.getElementById('setup-home-team').value = currentTeam ? currentTeam.name : '';
            document.getElementById('setup-home-color').value = currentTeam ? (currentTeam.color || '#10b981') : '#10b981';
            document.getElementById('setup-away-team').value = '';
            document.getElementById('setup-away-color').value = '#3b82f6';

            // Hide error
            document.getElementById('setup-error').classList.add('hidden');

            // Restore toggle states from stored preferences
            updateSetupToggles();
        }

        window.navigateToGame = function() {
            hideAllViews();
            showNavTabs();
            document.getElementById('game-view').classList.remove('hidden');

            // Activate the Current Game tab
            const navTabs = document.querySelectorAll('.nav-tab');
            navTabs.forEach(tab => {
                tab.classList.remove('bg-emerald-500', 'text-white', 'shadow-sm');
                tab.classList.add('text-slate-500');
            });
            navTabs[0].classList.add('bg-emerald-500', 'text-white', 'shadow-sm');
            navTabs[0].classList.remove('text-slate-500');
        }

        window.switchTeamTab = function(tab) {
            const tabs = document.querySelectorAll('.team-tab');
            tabs.forEach(t => {
                t.classList.remove('bg-emerald-500', 'text-white', 'shadow-sm');
                t.classList.add('text-slate-500', 'dark:text-slate-400');
            });

            if (tab === 'history') {
                tabs[0].classList.add('bg-emerald-500', 'text-white', 'shadow-sm');
                tabs[0].classList.remove('text-slate-500', 'dark:text-slate-400');
                document.getElementById('team-history-tab').classList.remove('hidden');
                document.getElementById('team-roster-tab').classList.add('hidden');
            } else {
                tabs[1].classList.add('bg-emerald-500', 'text-white', 'shadow-sm');
                tabs[1].classList.remove('text-slate-500', 'dark:text-slate-400');
                document.getElementById('team-history-tab').classList.add('hidden');
                document.getElementById('team-roster-tab').classList.remove('hidden');
            }
        }

        // =====================================================
        // TEAMS DATA FUNCTIONS
        // =====================================================

        async function loadTeams() {
            if (!currentUser) return;

            try {
                // Get team IDs for current user
                const { data: coachData, error: coachError } = await supabaseClient
                    .from('team_coaches')
                    .select('team_id')
                    .eq('user_id', currentUser.id);

                if (coachError) {
                    console.error('Error loading team coaches:', coachError);
                    teams = [];
                    updateTeamsDisplay();
                    return;
                }

                if (!coachData || coachData.length === 0) {
                    teams = [];
                    updateTeamsDisplay();
                    return;
                }

                const teamIds = coachData.map(tc => tc.team_id);

                const { data: teamsData, error: teamsError } = await supabaseClient
                    .from('teams')
                    .select('*')
                    .in('id', teamIds)
                    .order('name');

                if (teamsError) {
                    console.error('Error loading teams:', teamsError);
                    teams = [];
                } else {
                    teams = teamsData || [];
                }

                updateTeamsDisplay();
            } catch (err) {
                console.error('Error loading teams:', err);
                teams = [];
                updateTeamsDisplay();
            }
        }

        function updateTeamsDisplay() {
            const container = document.getElementById('teams-grid');

            const createBtn = `
                <button onclick="openCreateTeamModal()" class="bg-white dark:bg-slate-800 rounded-2xl p-6 shadow-lg border-2 border-dashed border-slate-300 dark:border-slate-600 hover:border-emerald-400 dark:hover:border-emerald-500 transition-all duration-200 hover:shadow-xl hover:-translate-y-0.5 text-left group">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-xl flex items-center justify-center bg-slate-100 dark:bg-slate-700 text-slate-400 dark:text-slate-500 group-hover:bg-emerald-100 dark:group-hover:bg-emerald-900/30 group-hover:text-emerald-500 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                            </svg>
                        </div>
                        <div class="flex-1">
                            <h3 class="text-lg font-semibold text-slate-400 dark:text-slate-500 group-hover:text-emerald-600 dark:group-hover:text-emerald-400 transition-colors">Create Team</h3>
                        </div>
                    </div>
                </button>
            `;

            if (teams.length === 0) {
                container.innerHTML = createBtn;
                return;
            }

            container.innerHTML = teams.map(team => {
                const color = team.color || '#10b981';
                return `
                    <button onclick="navigateToTeamDashboard('${team.id}')" class="bg-white dark:bg-slate-800 rounded-2xl p-6 shadow-lg border-2 border-slate-100 dark:border-slate-700 hover:border-emerald-400 dark:hover:border-emerald-500 transition-all duration-200 hover:shadow-xl hover:-translate-y-0.5 text-left group">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-xl flex items-center justify-center text-white text-xl font-bold shadow-md" style="background-color: ${color};">
                                ${team.name.charAt(0).toUpperCase()}
                            </div>
                            <div class="flex-1">
                                <h3 class="text-lg font-semibold text-slate-800 dark:text-white group-hover:text-emerald-600 dark:group-hover:text-emerald-400 transition-colors">${team.name}</h3>
                            </div>
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-slate-300 dark:text-slate-600 group-hover:text-emerald-500 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
                            </svg>
                        </div>
                    </button>
                `;
            }).join('') + createBtn;
        }

        // =====================================================
        // TEAM CREATE / EDIT / DELETE FUNCTIONS
        // =====================================================

        window.openCreateTeamModal = function() {
            document.getElementById('team-modal-title').textContent = 'Create Team';
            document.getElementById('team-modal-id').value = '';
            document.getElementById('team-modal-name').value = '';
            document.getElementById('team-modal-color').value = '#10b981';
            document.getElementById('team-modal-color-preview').style.backgroundColor = '#10b981';
            document.getElementById('team-modal-error').classList.add('hidden');
            document.getElementById('team-modal-save-btn').textContent = 'Create';
            document.getElementById('team-modal-delete-btn').classList.add('hidden');

            const modal = document.getElementById('team-modal-overlay');
            modal.classList.remove('hidden');
            modal.classList.add('flex');

            // Sync color preview on change
            document.getElementById('team-modal-color').oninput = function() {
                document.getElementById('team-modal-color-preview').style.backgroundColor = this.value;
            };

            document.getElementById('team-modal-name').focus();
        }

        window.openEditTeamModal = function() {
            if (!currentTeam) return;

            document.getElementById('team-modal-title').textContent = 'Edit Team';
            document.getElementById('team-modal-id').value = currentTeam.id;
            document.getElementById('team-modal-name').value = currentTeam.name;
            document.getElementById('team-modal-color').value = currentTeam.color || '#10b981';
            document.getElementById('team-modal-color-preview').style.backgroundColor = currentTeam.color || '#10b981';
            document.getElementById('team-modal-error').classList.add('hidden');
            document.getElementById('team-modal-save-btn').textContent = 'Save';
            document.getElementById('team-modal-delete-btn').classList.remove('hidden');

            const modal = document.getElementById('team-modal-overlay');
            modal.classList.remove('hidden');
            modal.classList.add('flex');

            // Sync color preview on change
            document.getElementById('team-modal-color').oninput = function() {
                document.getElementById('team-modal-color-preview').style.backgroundColor = this.value;
            };

            document.getElementById('team-modal-name').focus();
        }

        window.closeTeamModal = function() {
            const modal = document.getElementById('team-modal-overlay');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        window.saveTeamModal = async function() {
            const name = document.getElementById('team-modal-name').value.trim();
            const color = document.getElementById('team-modal-color').value;
            const teamId = document.getElementById('team-modal-id').value;
            const errorEl = document.getElementById('team-modal-error');

            if (!name) {
                errorEl.textContent = 'Please enter a team name.';
                errorEl.classList.remove('hidden');
                return;
            }

            errorEl.classList.add('hidden');

            try {
                if (teamId) {
                    // Update existing team
                    const { error } = await supabaseClient
                        .from('teams')
                        .update({ name, color })
                        .eq('id', teamId);

                    if (error) {
                        errorEl.textContent = 'Failed to update team: ' + error.message;
                        errorEl.classList.remove('hidden');
                        return;
                    }

                    // Update local state
                    if (currentTeam && currentTeam.id === teamId) {
                        currentTeam.name = name;
                        currentTeam.color = color;
                        document.getElementById('team-name-display').textContent = name;
                        document.getElementById('team-color-dot').style.backgroundColor = color;
                    }
                    const teamIdx = teams.findIndex(t => t.id === teamId);
                    if (teamIdx !== -1) {
                        teams[teamIdx].name = name;
                        teams[teamIdx].color = color;
                    }
                } else {
                    // Create new team
                    const { data: newTeam, error: teamError } = await supabaseClient
                        .from('teams')
                        .insert([{ name, color }])
                        .select()
                        .single();

                    if (teamError) {
                        errorEl.textContent = 'Failed to create team: ' + teamError.message;
                        errorEl.classList.remove('hidden');
                        return;
                    }

                    // Link current user as coach
                    const { error: coachError } = await supabaseClient
                        .from('team_coaches')
                        .insert([{ team_id: newTeam.id, user_id: currentUser.id }]);

                    if (coachError) {
                        errorEl.textContent = 'Team created but failed to add you as coach: ' + coachError.message;
                        errorEl.classList.remove('hidden');
                        return;
                    }

                    teams.push(newTeam);
                }

                closeTeamModal();
                updateTeamsDisplay();
            } catch (err) {
                console.error('Team save error:', err);
                errorEl.textContent = 'An unexpected error occurred.';
                errorEl.classList.remove('hidden');
            }
        }

        window.confirmDeleteTeam = function() {
            const teamId = document.getElementById('team-modal-id').value;
            if (!teamId) return;

            const teamName = document.getElementById('team-modal-name').value || 'this team';
            closeTeamModal();

            showModal('Delete Team', `Are you sure you want to delete "${teamName}"? All games and roster data linked to this team will be unlinked.`, async () => {
                try {
                    const { error } = await supabaseClient
                        .from('teams')
                        .delete()
                        .eq('id', teamId);

                    if (error) {
                        console.error('Delete team error:', error);
                        closeModal();
                        showModal('Error', 'Failed to delete team: ' + error.message, null);
                        return;
                    }

                    // Remove from local state
                    teams = teams.filter(t => t.id !== teamId);

                    // If we were viewing this team, go back to home
                    if (currentTeamId === teamId) {
                        currentTeamId = null;
                        currentTeam = null;
                    }

                    closeModal();
                    navigateToHome();
                } catch (err) {
                    console.error('Delete team error:', err);
                    closeModal();
                    showModal('Error', 'An unexpected error occurred while deleting.', null);
                }
            });
        }

        // =====================================================
        // TEAM ROSTER FUNCTIONS
        // =====================================================

        async function loadTeamRoster() {
            if (!currentTeamId || !currentUser) return;

            try {
                // Find or create roster for this team
                let { data: rosterData, error: rosterError } = await supabaseClient
                    .from('rosters')
                    .select('*')
                    .eq('team_id', currentTeamId)
                    .limit(1)
                    .maybeSingle();

                if (rosterError) {
                    console.error('Error loading team roster:', rosterError);
                    return;
                }

                // Auto-create roster if none exists
                if (!rosterData) {
                    const teamName = currentTeam ? currentTeam.name : 'Team';
                    const { data: newRoster, error: createError } = await supabaseClient
                        .from('rosters')
                        .insert([{ name: teamName + ' Roster', user_id: currentUser.id, team_id: currentTeamId }])
                        .select()
                        .single();

                    if (createError) {
                        console.error('Error creating team roster:', createError);
                        return;
                    }
                    rosterData = newRoster;
                }

                teamRosterId = rosterData.id;

                // Load players for this roster
                const { data: playersData, error: playersError } = await supabaseClient
                    .from('players')
                    .select('*')
                    .eq('roster_id', teamRosterId)
                    .order('number', { ascending: true, nullsFirst: false });

                if (playersError) {
                    console.error('Error loading team players:', playersError);
                    teamRoster = [];
                } else {
                    teamRoster = playersData || [];
                }

                updateTeamRosterDisplay();
            } catch (err) {
                console.error('Error loading team roster:', err);
            }
        }

        function updateTeamRosterDisplay() {
            const container = document.getElementById('team-roster-list');

            if (teamRoster.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-10 text-slate-400">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-12 h-12 mx-auto mb-3 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                        </svg>
                        <p>No players added yet</p>
                        <p class="text-sm mt-1">Add players to your roster</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = teamRoster.map(player => `
                <div class="flex items-center justify-between py-3 px-2 border-b border-slate-100 dark:border-slate-700 last:border-0">
                    <div class="flex items-center gap-3">
                        <span class="w-8 h-8 bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400 rounded-full flex items-center justify-center text-sm font-bold">
                            ${player.number || '-'}
                        </span>
                        <span class="font-medium text-slate-800 dark:text-white">${player.name}</span>
                    </div>
                    <button onclick="confirmDeleteTeamPlayer('${player.id}')" class="text-slate-400 hover:text-red-500 transition-colors p-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                </div>
            `).join('');
        }

        window.openTeamPlayersModal = async function() {
            // Reuse the existing players modal by setting editingRosterId
            editingRosterId = teamRosterId;

            // Clear inputs
            document.getElementById('player-name-input').value = '';
            document.getElementById('player-number-input').value = '';
            document.getElementById('roster-error').classList.add('hidden');

            // Load players
            await loadRosterPlayers(teamRosterId);

            // Open players modal
            const modal = document.getElementById('roster-players-modal-overlay');
            document.getElementById('roster-players-title').textContent = (currentTeam ? currentTeam.name : 'Team') + ' Players';
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        window.confirmDeleteTeamPlayer = function(playerId) {
            showModal('Delete Player', 'Are you sure you want to remove this player from the roster?', async () => {
                try {
                    const { error } = await supabaseClient
                        .from('players')
                        .delete()
                        .eq('id', playerId);

                    if (error) {
                        console.error('Error deleting player:', error);
                        return;
                    }

                    await loadTeamRoster();
                } catch (err) {
                    console.error('Error deleting player:', err);
                }
                closeModal();
            });
        }

        // =====================================================
        // TEAM GAMES FUNCTIONS
        // =====================================================

        async function loadTeamGames() {
            if (!currentTeamId) return;

            const games = await getSavedGames(currentTeamId);
            updateTeamStatsDisplay(games);
            updateTeamGameList(games);
        }

        function updateTeamStatsDisplay(games) {
            if (games.length === 0) {
                document.getElementById('team-total-games').textContent = '0';
                document.getElementById('team-avg-goals').textContent = '0';
                document.getElementById('team-total-shots').textContent = '0';
                document.getElementById('team-avg-accuracy').textContent = '0%';
                return;
            }

            let totalGoals = 0;
            let totalShots = 0;
            let totalOnTarget = 0;

            games.forEach(game => {
                totalGoals += game.home.goals + game.away.goals;
                totalShots += game.home.onTarget + game.home.offTarget + game.away.onTarget + game.away.offTarget;
                totalOnTarget += game.home.onTarget + game.away.onTarget;
            });

            const avgGoals = (totalGoals / games.length).toFixed(1);
            const avgAccuracy = totalShots > 0 ? Math.round((totalOnTarget / totalShots) * 100) : 0;

            document.getElementById('team-total-games').textContent = games.length;
            document.getElementById('team-avg-goals').textContent = avgGoals;
            document.getElementById('team-total-shots').textContent = totalShots;
            document.getElementById('team-avg-accuracy').textContent = avgAccuracy + '%';
        }

        function updateTeamGameList(games) {
            teamGamesCache = games;
            const container = document.getElementById('team-game-list');

            if (games.length === 0) {
                container.innerHTML = `
                    <div class="empty-state text-center py-10 text-slate-400">
                        <div class="text-5xl mb-3">&#128202;</div>
                        <p>No games yet</p>
                        <p class="text-sm mt-2">Start a game to see it here!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = games.map(game => {
                const homeTotalShots = game.home.onTarget + game.home.offTarget;
                const awayTotalShots = game.away.onTarget + game.away.offTarget;
                const homeAccuracy = homeTotalShots > 0 ? Math.round((game.home.onTarget / homeTotalShots) * 100) : 0;
                const awayAccuracy = awayTotalShots > 0 ? Math.round((game.away.onTarget / awayTotalShots) * 100) : 0;
                const homeColor = game.homeColor || '#10b981';
                const awayColor = game.awayColor || '#3b82f6';

                const formattedDate = new Date(game.date).toLocaleDateString('en-US', {
                    weekday: 'short',
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });

                const homeH1 = game.home.firstHalf || { goals: 0, onTarget: 0, offTarget: 0 };
                const homeH2 = game.home.secondHalf || { goals: 0, onTarget: 0, offTarget: 0 };
                const awayH1 = game.away.firstHalf || { goals: 0, onTarget: 0, offTarget: 0 };
                const awayH2 = game.away.secondHalf || { goals: 0, onTarget: 0, offTarget: 0 };
                const hasHalfData = game.home.firstHalf || game.home.secondHalf;

                const shotsWithPositions = (game.log || []).filter(shot => shot.position);
                const hasShotMap = shotsWithPositions.length > 0;

                const shotMarkersSvg = shotsWithPositions.map(shot => {
                    const color = shot.team === 'home' ? homeColor : awayColor;
                    const x = shot.half === 2 ? (105 - shot.position.x) : shot.position.x;
                    const y = shot.half === 2 ? (68 - shot.position.y) : shot.position.y;

                    if (shot.type === 'GOAL!') {
                        return `<circle cx="${x}" cy="${y}" r="2.5" fill="${color}" stroke="white" stroke-width="0.3" opacity="0.85"/><text x="${x}" y="${y + 0.8}" fill="white" font-size="2.5" text-anchor="middle">\u2605</text>`;
                    } else if (shot.type === 'Shot On Target') {
                        const size = 3;
                        return `<rect x="${x - size/2}" y="${y - size/2}" width="${size}" height="${size}" fill="${color}" stroke="white" stroke-width="0.3" opacity="0.85"/>`;
                    } else if (shot.type === 'Shot Off Target') {
                        const size = 2;
                        return `<polygon points="${x},${y - size} ${x - size},${y + size} ${x + size},${y + size}" fill="${color}" stroke="white" stroke-width="0.3" opacity="0.85"/>`;
                    }
                    return '';
                }).join('');

                // Goal timeline data
                const allGoals = [];
                (game.log || []).forEach((shot, idx) => {
                    if (shot.type === 'GOAL!') {
                        allGoals.push({ ...shot, _logIndex: idx });
                    }
                });

                const goalTimelineHtml = allGoals.length > 0 ? (() => {
                    const playerGoals = {};
                    allGoals.forEach(shot => {
                        if (shot.playerName) {
                            const key = shot.playerId || shot.playerName;
                            if (!playerGoals[key]) playerGoals[key] = { name: shot.playerName, goals: 0 };
                            playerGoals[key].goals++;
                        }
                    });
                    const playerStatsList = Object.values(playerGoals).sort((a, b) => b.goals - a.goals);

                    return `
                        <div class="mt-5 pt-5 border-t border-slate-200 dark:border-slate-600">
                            <div class="text-sm font-semibold text-slate-700 dark:text-slate-200 mb-3">Goal Timeline</div>
                            <div class="space-y-2">
                                ${allGoals.map(goal => {
                                    const teamColor = goal.team === 'home' ? homeColor : awayColor;
                                    const teamName = goal.team === 'home' ? game.homeTeam : game.awayTeam;
                                    return `
                                    <div class="flex items-center gap-3 p-3 bg-white dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-600">
                                        <div class="flex-shrink-0 w-14 text-center">
                                            <div class="text-sm font-bold text-slate-700 dark:text-slate-200">${goal.gameTime || '--:--'}</div>
                                            <div class="text-[10px] text-slate-400">${goal.half || ''}</div>
                                        </div>
                                        <div class="w-px h-8 bg-slate-200 dark:bg-slate-600"></div>
                                        <div class="flex items-center gap-2 flex-1">
                                            <div class="w-3 h-3 rounded-full flex-shrink-0" style="background: ${teamColor};"></div>
                                            <div class="flex-1 min-w-0">
                                                <div class="text-sm font-medium text-slate-800 dark:text-white truncate">
                                                    ${goal.playerName ? goal.playerName : '<span class="text-slate-400 italic">Unknown scorer</span>'}
                                                </div>
                                                <div class="text-xs text-slate-500 dark:text-slate-400">${teamName}</div>
                                            </div>
                                        </div>
                                        <div class="flex-shrink-0 text-lg">\u26BD</div>
                                    </div>`;
                                }).join('')}
                            </div>
                            ${playerStatsList.length > 0 ? `
                            <div class="mt-4 pt-4 border-t border-slate-100 dark:border-slate-700">
                                <div class="text-xs font-semibold text-slate-400 uppercase mb-2">Summary</div>
                                <div class="flex flex-wrap gap-2">
                                    ${playerStatsList.map(player => `
                                        <span class="inline-flex items-center gap-1 px-2 py-1 bg-emerald-50 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-400 rounded-full text-xs font-medium">
                                            ${player.name} <span class="font-bold">${player.goals}</span>
                                        </span>
                                    `).join('')}
                                </div>
                            </div>` : ''}
                        </div>`;
                })() : '';

                const notesHtml = (game.notes && game.notes.length > 0) ? `
                    <div class="mt-5 pt-5 border-t border-slate-200 dark:border-slate-600">
                        <div class="text-sm font-semibold text-slate-700 dark:text-slate-200 mb-3">Game Notes</div>
                        <div class="space-y-2">
                            ${game.notes.map(note => `
                                <div class="bg-white dark:bg-slate-800 rounded-lg p-3 border border-slate-200 dark:border-slate-600">
                                    <div class="flex items-start gap-2">
                                        <span class="text-xs font-mono text-slate-400 whitespace-nowrap">${note.gameTime || note.timestamp || ''}</span>
                                        <span class="text-sm text-slate-600 dark:text-slate-300">${note.content || note.text || ''}</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>` : '';

                return `
                    <div class="game-item bg-slate-50 dark:bg-slate-700 rounded-xl p-5 border border-slate-200 dark:border-slate-600 hover:border-emerald-300 hover:shadow-md transition-all duration-200" id="team-game-${game.id}">
                        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                            <div class="flex-1">
                                <div class="text-sm text-slate-400 mb-1">${formattedDate}</div>
                                <div class="font-semibold text-slate-800 dark:text-white">${game.homeTeam} vs ${game.awayTeam}</div>
                            </div>
                            <div class="text-2xl font-bold px-4">
                                <span style="color: ${homeColor};">${game.home.goals}</span>
                                <span class="text-slate-300 dark:text-slate-500 mx-1">-</span>
                                <span style="color: ${awayColor};">${game.away.goals}</span>
                            </div>
                            <div class="flex gap-4 text-sm text-slate-500 dark:text-slate-400">
                                <span>Shots: ${homeTotalShots + awayTotalShots}</span>
                                <span>On Target: ${game.home.onTarget + game.away.onTarget}</span>
                            </div>
                            <div class="flex gap-2">
                                <button class="px-4 py-2 border-2 border-slate-200 dark:border-slate-500 text-slate-500 dark:text-slate-300 rounded-xl text-sm font-semibold transition-all duration-200 hover:border-emerald-500 hover:text-emerald-500 hover:bg-emerald-50 dark:hover:bg-emerald-900/20" onclick="toggleTeamGameDetails('${game.id}')">Details</button>
                                <button class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-xl text-sm font-semibold transition-all duration-200" onclick="confirmDeleteTeamGame('${game.id}')">Delete</button>
                            </div>
                        </div>
                        <div class="team-expanded-stats hidden mt-5 pt-5 border-t border-slate-200 dark:border-slate-600">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                                <div class="team-stats-block home p-4 bg-white dark:bg-slate-800 rounded-xl border-t-4" style="border-color: ${homeColor};">
                                    <h4 class="font-semibold mb-3 pb-2 border-b-2" style="color: ${homeColor}; border-color: ${homeColor};">${game.homeTeam}</h4>
                                    <div class="space-y-1 text-sm">
                                        <div class="flex justify-between py-1"><span class="text-slate-500 dark:text-slate-400">Goals</span><span class="font-semibold dark:text-white">${game.home.goals}</span></div>
                                        <div class="flex justify-between py-1"><span class="text-slate-500 dark:text-slate-400">Shots On Target</span><span class="font-semibold dark:text-white">${game.home.onTarget}</span></div>
                                        <div class="flex justify-between py-1"><span class="text-slate-500 dark:text-slate-400">Shots Off Target</span><span class="font-semibold dark:text-white">${game.home.offTarget}</span></div>
                                        <div class="flex justify-between py-1"><span class="text-slate-500 dark:text-slate-400">Total Shots</span><span class="font-semibold dark:text-white">${homeTotalShots}</span></div>
                                        <div class="flex justify-between py-1"><span class="text-slate-500 dark:text-slate-400">Shot Accuracy</span><span class="font-semibold dark:text-white">${homeAccuracy}%</span></div>
                                    </div>
                                    ${hasHalfData ? `
                                    <div class="mt-3 pt-3 border-t border-slate-200 dark:border-slate-600">
                                        <div class="text-xs font-semibold text-slate-400 uppercase mb-2">By Half</div>
                                        <div class="grid grid-cols-2 gap-2 text-xs">
                                            <div class="bg-slate-50 dark:bg-slate-700 rounded-lg p-2">
                                                <div class="font-semibold text-slate-400 mb-1">1st</div>
                                                <div class="flex justify-between"><span class="dark:text-slate-400">Goals</span><span class="font-semibold dark:text-slate-200">${homeH1.goals}</span></div>
                                                <div class="flex justify-between"><span class="dark:text-slate-400">On Target</span><span class="font-semibold dark:text-slate-200">${homeH1.onTarget}</span></div>
                                                <div class="flex justify-between"><span class="dark:text-slate-400">Off Target</span><span class="font-semibold dark:text-slate-200">${homeH1.offTarget}</span></div>
                                            </div>
                                            <div class="bg-slate-50 dark:bg-slate-700 rounded-lg p-2">
                                                <div class="font-semibold text-slate-400 mb-1">2nd</div>
                                                <div class="flex justify-between"><span class="dark:text-slate-400">Goals</span><span class="font-semibold dark:text-slate-200">${homeH2.goals}</span></div>
                                                <div class="flex justify-between"><span class="dark:text-slate-400">On Target</span><span class="font-semibold dark:text-slate-200">${homeH2.onTarget}</span></div>
                                                <div class="flex justify-between"><span class="dark:text-slate-400">Off Target</span><span class="font-semibold dark:text-slate-200">${homeH2.offTarget}</span></div>
                                            </div>
                                        </div>
                                    </div>` : ''}
                                </div>
                                <div class="team-stats-block away p-4 bg-white dark:bg-slate-800 rounded-xl border-t-4" style="border-color: ${awayColor};">
                                    <h4 class="font-semibold mb-3 pb-2 border-b-2" style="color: ${awayColor}; border-color: ${awayColor};">${game.awayTeam}</h4>
                                    <div class="space-y-1 text-sm">
                                        <div class="flex justify-between py-1"><span class="text-slate-500 dark:text-slate-400">Goals</span><span class="font-semibold dark:text-white">${game.away.goals}</span></div>
                                        <div class="flex justify-between py-1"><span class="text-slate-500 dark:text-slate-400">Shots On Target</span><span class="font-semibold dark:text-white">${game.away.onTarget}</span></div>
                                        <div class="flex justify-between py-1"><span class="text-slate-500 dark:text-slate-400">Shots Off Target</span><span class="font-semibold dark:text-white">${game.away.offTarget}</span></div>
                                        <div class="flex justify-between py-1"><span class="text-slate-500 dark:text-slate-400">Total Shots</span><span class="font-semibold dark:text-white">${awayTotalShots}</span></div>
                                        <div class="flex justify-between py-1"><span class="text-slate-500 dark:text-slate-400">Shot Accuracy</span><span class="font-semibold dark:text-white">${awayAccuracy}%</span></div>
                                    </div>
                                    ${hasHalfData ? `
                                    <div class="mt-3 pt-3 border-t border-slate-200 dark:border-slate-600">
                                        <div class="text-xs font-semibold text-slate-400 uppercase mb-2">By Half</div>
                                        <div class="grid grid-cols-2 gap-2 text-xs">
                                            <div class="bg-slate-50 dark:bg-slate-700 rounded-lg p-2">
                                                <div class="font-semibold text-slate-400 mb-1">1st</div>
                                                <div class="flex justify-between"><span class="dark:text-slate-400">Goals</span><span class="font-semibold dark:text-slate-200">${awayH1.goals}</span></div>
                                                <div class="flex justify-between"><span class="dark:text-slate-400">On Target</span><span class="font-semibold dark:text-slate-200">${awayH1.onTarget}</span></div>
                                                <div class="flex justify-between"><span class="dark:text-slate-400">Off Target</span><span class="font-semibold dark:text-slate-200">${awayH1.offTarget}</span></div>
                                            </div>
                                            <div class="bg-slate-50 dark:bg-slate-700 rounded-lg p-2">
                                                <div class="font-semibold text-slate-400 mb-1">2nd</div>
                                                <div class="flex justify-between"><span class="dark:text-slate-400">Goals</span><span class="font-semibold dark:text-slate-200">${awayH2.goals}</span></div>
                                                <div class="flex justify-between"><span class="dark:text-slate-400">On Target</span><span class="font-semibold dark:text-slate-200">${awayH2.onTarget}</span></div>
                                                <div class="flex justify-between"><span class="dark:text-slate-400">Off Target</span><span class="font-semibold dark:text-slate-200">${awayH2.offTarget}</span></div>
                                            </div>
                                        </div>
                                    </div>` : ''}
                                </div>
                            </div>
                            ${hasShotMap ? `
                            <div class="mt-5 pt-5 border-t border-slate-200 dark:border-slate-600">
                                <div class="mb-3">
                                    <div class="flex items-center justify-between">
                                        <div class="text-sm font-semibold text-slate-700 dark:text-slate-200">Shot Map</div>
                                        ${shotsWithPositions.length >= 10 ? `
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <span class="text-xs text-slate-500 dark:text-slate-400">Heat Map</span>
                                            <input type="checkbox" class="sr-only peer history-heat-map-toggle" data-game-id="${game.id}" onchange="toggleHistoryHeatMap('${game.id}', this.checked)">
                                            <div class="w-8 h-4 bg-slate-300 dark:bg-slate-600 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-emerald-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:bg-orange-500 relative"></div>
                                        </label>
                                        ` : `<span class="text-xs text-slate-400">${shotsWithPositions.length}/10 shots for heat map</span>`}
                                    </div>
                                    <div class="flex items-center justify-center gap-1 mt-2" id="history-heat-map-filter-${game.id}" style="display: none;">
                                        <button type="button" id="history-filter-home-${game.id}" onclick="setHistoryHeatMapFilter('${game.id}', 'home')" class="px-3 py-1 text-xs font-medium rounded-lg transition-all duration-200 bg-orange-500 text-white">${game.homeTeam}</button>
                                        <button type="button" id="history-filter-away-${game.id}" onclick="setHistoryHeatMapFilter('${game.id}', 'away')" class="px-3 py-1 text-xs font-medium rounded-lg transition-all duration-200 bg-slate-200 dark:bg-slate-600 text-slate-600 dark:text-slate-300 hover:bg-slate-300 dark:hover:bg-slate-500">${game.awayTeam}</button>
                                    </div>
                                </div>
                                <div class="relative bg-emerald-600 rounded-xl overflow-hidden" id="history-field-${game.id}" style="aspect-ratio: 105/68;">
                                    <svg viewBox="0 0 105 68" class="w-full h-full">
                                        <rect x="0" y="0" width="105" height="68" fill="#2d8a4e"/>
                                        <g fill="#3d9a5e" opacity="0.5">
                                            <rect x="0" y="0" width="10.5" height="68"/>
                                            <rect x="21" y="0" width="10.5" height="68"/>
                                            <rect x="42" y="0" width="10.5" height="68"/>
                                            <rect x="63" y="0" width="10.5" height="68"/>
                                            <rect x="84" y="0" width="10.5" height="68"/>
                                        </g>
                                        <g fill="none" stroke="white" stroke-width="0.3">
                                            <rect x="0.5" y="0.5" width="104" height="67"/>
                                            <line x1="52.5" y1="0.5" x2="52.5" y2="67.5"/>
                                            <circle cx="52.5" cy="34" r="9.15"/>
                                            <circle cx="52.5" cy="34" r="0.5" fill="white"/>
                                            <rect x="0.5" y="13.84" width="16.5" height="40.32"/>
                                            <rect x="0.5" y="24.84" width="5.5" height="18.32"/>
                                            <circle cx="11" cy="34" r="0.5" fill="white"/>
                                            <path d="M 16.5 27.5 A 9.15 9.15 0 0 1 16.5 40.5"/>
                                            <rect x="88" y="13.84" width="16.5" height="40.32"/>
                                            <rect x="99" y="24.84" width="5.5" height="18.32"/>
                                            <circle cx="94" cy="34" r="0.5" fill="white"/>
                                            <path d="M 88 27.5 A 9.15 9.15 0 0 0 88 40.5"/>
                                        </g>
                                        <text x="2" y="5" fill="white" font-size="3" font-weight="bold" opacity="0.7" text-anchor="start">${game.homeTeam.toUpperCase()}</text>
                                        <text x="103" y="5" fill="white" font-size="3" font-weight="bold" opacity="0.7" text-anchor="end">${game.awayTeam.toUpperCase()}</text>
                                        ${shotMarkersSvg}
                                    </svg>
                                    <canvas id="history-heat-map-${game.id}" class="absolute inset-0 w-full h-full pointer-events-none" style="display: none;"></canvas>
                                </div>
                                <div class="flex flex-wrap items-center justify-center gap-4 mt-3 text-xs text-slate-500 dark:text-slate-400">
                                    <div class="flex items-center gap-1.5">
                                        <span class="w-3 h-3 rounded-full" style="background: ${homeColor};"></span>
                                        <span>${game.homeTeam}</span>
                                    </div>
                                    <div class="flex items-center gap-1.5">
                                        <span class="w-3 h-3 rounded-full" style="background: ${awayColor};"></span>
                                        <span>${game.awayTeam}</span>
                                    </div>
                                    <div class="flex items-center gap-1.5">
                                        <svg width="12" height="12" viewBox="0 0 14 14"><circle cx="7" cy="7" r="5" fill="#6b7280" stroke="white" stroke-width="1"/><text x="7" y="9" fill="white" font-size="6" text-anchor="middle">\u2605</text></svg>
                                        <span>Goal</span>
                                    </div>
                                    <div class="flex items-center gap-1.5">
                                        <svg width="12" height="12" viewBox="0 0 14 14"><rect x="3" y="3" width="8" height="8" fill="#6b7280" stroke="white" stroke-width="1"/></svg>
                                        <span>On Target</span>
                                    </div>
                                    <div class="flex items-center gap-1.5">
                                        <svg width="12" height="12" viewBox="0 0 14 14"><polygon points="7,2 2,12 12,12" fill="#6b7280" stroke="white" stroke-width="1"/></svg>
                                        <span>Off Target</span>
                                    </div>
                                </div>
                            </div>` : ''}
                            ${goalTimelineHtml}
                            ${notesHtml}
                        </div>
                    </div>
                `;
            }).join('');
        }

        window.toggleTeamGameDetails = function(gameId) {
            const gameItem = document.getElementById(`team-game-${gameId}`);
            if (!gameItem) return;
            const expandedStats = gameItem.querySelector('.team-expanded-stats');
            if (expandedStats) expandedStats.classList.toggle('hidden');
        }

        window.confirmDeleteTeamGame = function(gameId) {
            showModal(
                'Delete Game',
                'Are you sure you want to delete this game? This action cannot be undone.',
                () => deleteTeamGame(gameId)
            );
        }

        async function deleteTeamGame(gameId) {
            try {
                const { error } = await supabaseClient
                    .from('games')
                    .delete()
                    .eq('id', gameId)
                    .eq('user_id', currentUser.id);

                if (error) {
                    console.error('Delete error:', error);
                    closeModal();
                    showModal('Delete Failed', 'Failed to delete game: ' + error.message, null);
                    return;
                }

                closeModal();
                // Reload team games
                await loadTeamGames();

            } catch (err) {
                console.error('Delete error:', err);
                closeModal();
                showModal('Delete Failed', 'An unexpected error occurred while deleting.', null);
            }
        }

        // =====================================================
        // GAME SETUP FUNCTIONS
        // =====================================================

        window.toggleSetupShotMap = function() {
            gameSetupConfig.shotMapEnabled = !gameSetupConfig.shotMapEnabled;
            localStorage.setItem('setupShotMapEnabled', gameSetupConfig.shotMapEnabled);
            updateSetupToggles();
        }

        window.toggleSetupWakeLock = function() {
            gameSetupConfig.wakeLockEnabled = !gameSetupConfig.wakeLockEnabled;
            localStorage.setItem('setupWakeLockEnabled', gameSetupConfig.wakeLockEnabled);
            updateSetupToggles();
        }

        window.toggleSetupPlayerTracking = function() {
            gameSetupConfig.playerTrackingEnabled = !gameSetupConfig.playerTrackingEnabled;
            localStorage.setItem('setupPlayerTrackingEnabled', gameSetupConfig.playerTrackingEnabled);
            updateSetupToggles();
        }

        function updateSetupToggles() {
            // Shot Map toggle
            const smToggle = document.getElementById('setup-shot-map-toggle');
            const smDot = document.getElementById('setup-shot-map-toggle-dot');
            if (smToggle && smDot) {
                if (gameSetupConfig.shotMapEnabled) {
                    smToggle.classList.remove('bg-slate-300', 'dark:bg-slate-600');
                    smToggle.classList.add('bg-emerald-500');
                    smDot.style.transform = 'translateX(20px)';
                } else {
                    smToggle.classList.add('bg-slate-300', 'dark:bg-slate-600');
                    smToggle.classList.remove('bg-emerald-500');
                    smDot.style.transform = 'translateX(0)';
                }
            }

            // Wake Lock toggle
            const wlToggle = document.getElementById('setup-wake-lock-toggle');
            const wlDot = document.getElementById('setup-wake-lock-toggle-dot');
            if (wlToggle && wlDot) {
                if (gameSetupConfig.wakeLockEnabled) {
                    wlToggle.classList.remove('bg-slate-300', 'dark:bg-slate-600');
                    wlToggle.classList.add('bg-emerald-500');
                    wlDot.style.transform = 'translateX(20px)';
                } else {
                    wlToggle.classList.add('bg-slate-300', 'dark:bg-slate-600');
                    wlToggle.classList.remove('bg-emerald-500');
                    wlDot.style.transform = 'translateX(0)';
                }
            }

            // Player Tracking toggle
            const ptToggle = document.getElementById('setup-player-tracking-toggle');
            const ptDot = document.getElementById('setup-player-tracking-toggle-dot');
            if (ptToggle && ptDot) {
                if (gameSetupConfig.playerTrackingEnabled) {
                    ptToggle.classList.remove('bg-slate-300', 'dark:bg-slate-600');
                    ptToggle.classList.add('bg-emerald-500');
                    ptDot.style.transform = 'translateX(20px)';
                } else {
                    ptToggle.classList.add('bg-slate-300', 'dark:bg-slate-600');
                    ptToggle.classList.remove('bg-emerald-500');
                    ptDot.style.transform = 'translateX(0)';
                }
            }
        }

        window.startGameFromSetup = function() {
            const awayTeam = document.getElementById('setup-away-team').value.trim();
            if (!awayTeam) {
                const errorEl = document.getElementById('setup-error');
                errorEl.textContent = 'Please enter an away team name.';
                errorEl.classList.remove('hidden');
                return;
            }

            // Set the existing game view inputs
            document.getElementById('home-team-input').value = document.getElementById('setup-home-team').value;
            document.getElementById('away-team-input').value = awayTeam;
            document.getElementById('home-color').value = document.getElementById('setup-home-color').value;
            document.getElementById('away-color').value = document.getElementById('setup-away-color').value;
            document.getElementById('game-date').value = document.getElementById('setup-game-date').value;

            // Trigger the input events to update display names
            document.getElementById('home-team-input').dispatchEvent(new Event('input'));
            document.getElementById('away-team-input').dispatchEvent(new Event('input'));
            document.getElementById('home-color').dispatchEvent(new Event('input'));
            document.getElementById('away-color').dispatchEvent(new Event('input'));

            // Apply toggle states to global vars
            shotMapEnabled = gameSetupConfig.shotMapEnabled;
            // Update shot map toggle UI in game view
            const smToggleGame = document.getElementById('shot-map-toggle');
            const smDotGame = document.getElementById('shot-map-toggle-dot');
            if (smToggleGame && smDotGame) {
                if (shotMapEnabled) {
                    smToggleGame.classList.remove('bg-slate-300');
                    smToggleGame.classList.add('bg-emerald-500');
                    smDotGame.style.transform = 'translateX(20px)';
                } else {
                    smToggleGame.classList.add('bg-slate-300');
                    smToggleGame.classList.remove('bg-emerald-500');
                    smDotGame.style.transform = 'translateX(0)';
                }
            }

            wakeLockEnabled = gameSetupConfig.wakeLockEnabled;
            localStorage.setItem('wakeLockEnabled', wakeLockEnabled);
            updateWakeLockToggleUI();
            if (wakeLockEnabled) {
                requestWakeLock();
            }

            playerTrackingEnabled = gameSetupConfig.playerTrackingEnabled;
            localStorage.setItem('playerTrackingEnabled', playerTrackingEnabled);

            // Set roster for this game
            currentRosterId = teamRosterId;
            localStorage.setItem('currentRosterId', currentRosterId);
            roster = [...teamRoster];
            rosterTeam = 'home';
            localStorage.setItem('rosterTeam', 'home');

            // Update roster display in game view
            if (currentRosterId && roster.length > 0) {
                const rosterName = currentTeam ? currentTeam.name : 'Team';
                document.getElementById('selected-roster-display').innerHTML =
                    `<span class="text-emerald-600 dark:text-emerald-400 font-medium">${rosterName} Roster</span>
                     <span class="text-slate-400 ml-1">(${roster.length} players)</span>`;
                document.getElementById('player-tracking-section').style.display = 'flex';
                document.getElementById('roster-team-assignment').style.display = 'block';
            }

            // Update player tracking toggle UI in game view
            const ptToggleGame = document.getElementById('player-tracking-toggle');
            const ptDotGame = document.getElementById('player-tracking-toggle-dot');
            if (ptToggleGame && ptDotGame) {
                if (playerTrackingEnabled) {
                    ptToggleGame.classList.remove('bg-slate-300', 'dark:bg-slate-600');
                    ptToggleGame.classList.add('bg-emerald-500');
                    ptDotGame.style.transform = 'translateX(20px)';
                } else {
                    ptToggleGame.classList.add('bg-slate-300', 'dark:bg-slate-600');
                    ptToggleGame.classList.remove('bg-emerald-500');
                    ptDotGame.style.transform = 'translateX(0)';
                }
            }

            // Reset game state
            resetGameState();
            updateDisplay();

            // Update game summary bar
            const homeTeamName = document.getElementById('setup-home-team').value || 'Home Team';
            const gameDateVal = document.getElementById('setup-game-date').value;
            const formattedDate = gameDateVal ? new Date(gameDateVal + 'T12:00:00').toLocaleDateString('en-US', {
                weekday: 'short', month: 'short', day: 'numeric'
            }) : '';
            document.getElementById('game-date-display').textContent = formattedDate;
            document.getElementById('game-teams-display').textContent = `${homeTeamName} vs ${awayTeam}`;

            // Navigate to game
            navigateToGame();
        }

        // View switching
        window.switchView = function(view) {
            const navTabs = document.querySelectorAll('.nav-tab');
            const views = document.querySelectorAll('.view');

            navTabs.forEach(tab => {
                tab.classList.remove('bg-emerald-500', 'text-white', 'shadow-sm');
                tab.classList.add('text-slate-500');
            });
            views.forEach(v => v.classList.add('hidden'));

            if (view === 'game') {
                navTabs[0].classList.add('bg-emerald-500', 'text-white', 'shadow-sm');
                navTabs[0].classList.remove('text-slate-500');
                document.getElementById('game-view').classList.remove('hidden');
            } else {
                navTabs[1].classList.add('bg-emerald-500', 'text-white', 'shadow-sm');
                navTabs[1].classList.remove('text-slate-500');
                document.getElementById('history-view').classList.remove('hidden');
                loadHistoryView();
            }
        }

        // Shot recording
        window.recordShot = function(team, type) {
            const teamName = team === 'home'
                ? (document.getElementById('home-team-input').value || 'Home Team')
                : (document.getElementById('away-team-input').value || 'Away Team');

            const shotTypeLabel = type === 'goal' ? 'GOAL!' :
                                  type === 'on-target' ? 'Shot On Target' : 'Shot Off Target';

            // Store pending shot data
            pendingShot = {
                team: team,
                teamName: teamName,
                type: shotTypeLabel,
                rawType: type,
                half: gameState.currentHalf,
                gameTime: getGameTime(),
                clockSeconds: clockState.seconds,
                position: null,
                playerId: null,
                playerName: null
            };

            // Check if this is a goal and player tracking is enabled for this team
            if (type === 'goal' && playerTrackingEnabled && team === rosterTeam && roster.length > 0) {
                // Store pending goal data for player selection
                pendingGoalForPlayer = {
                    team: team,
                    teamName: teamName,
                    type: shotTypeLabel,
                    playerId: null,
                    playerName: null
                };
                showPlayerSelectionModal();
            } else if (shotMapEnabled) {
                // Show shot map modal
                showShotMapModal(team, teamName, shotTypeLabel);
            } else {
                // Complete shot recording immediately
                completeShotRecording();
            }
        }

        // Show the shot map modal
        function showShotMapModal(team, teamName, shotType) {
            const modal = document.getElementById('shot-map-modal');
            const teamDisplay = document.getElementById('shot-map-team');
            const typeDisplay = document.getElementById('shot-map-type');
            const homeLabel = document.getElementById('field-home-label');
            const awayLabel = document.getElementById('field-away-label');

            // Update labels with team names (swap if sides are flipped)
            const homeName = document.getElementById('home-team-input').value || 'HOME';
            const awayName = document.getElementById('away-team-input').value || 'AWAY';
            // homeLabel is on the left, awayLabel is on the right
            if (fieldSidesFlipped) {
                homeLabel.textContent = awayName.toUpperCase();
                awayLabel.textContent = homeName.toUpperCase();
            } else {
                homeLabel.textContent = homeName.toUpperCase();
                awayLabel.textContent = awayName.toUpperCase();
            }

            // Reset modal header text (in case it was in view mode)
            document.querySelector('#shot-map-modal h3').textContent = 'Mark Shot Location';
            document.querySelector('#shot-map-modal h3 + p').textContent = 'Tap on the field where the shot was taken';

            // Set shot info with team color
            const teamColor = team === 'home'
                ? document.getElementById('home-color').value
                : document.getElementById('away-color').value;
            teamDisplay.textContent = teamName;
            teamDisplay.style.color = teamColor;
            typeDisplay.textContent = shotType;

            // Reset state
            selectedShotPosition = null;
            document.getElementById('shot-marker').style.display = 'none';
            document.getElementById('confirm-shot-location-btn').disabled = true;
            document.getElementById('confirm-shot-location-btn').style.display = 'block';
            document.getElementById('shot-position-display').textContent = 'Click on the field to mark shot location';
            document.querySelector('#shot-map-modal button[onclick="skipShotLocation()"]').textContent = 'Skip';

            // Draw previous shots from this game
            drawPreviousShots();

            // Update heat map controls
            updateHeatMapControls();

            // Show modal
            modal.classList.remove('hidden');
            modal.classList.add('flex');

            // Set up click handler
            const clickArea = document.getElementById('shot-map-click-area');
            clickArea.onclick = handleFieldClick;
        }

        // Draw previous shots on the field
        function drawPreviousShots() {
            const container = document.getElementById('shot-map-previous-shots');
            container.innerHTML = '';

            const homeColor = document.getElementById('home-color').value;
            const awayColor = document.getElementById('away-color').value;

            gameState.log.forEach((shot, index) => {
                if (shot.position) {
                    const color = shot.team === 'home' ? homeColor : awayColor;
                    const isGoal = shot.type === 'GOAL!';
                    const isOnTarget = shot.type === 'Shot On Target';
                    const isOffTarget = shot.type === 'Shot Off Target';

                    // Transpose both coordinates if sides are flipped
                    // This maintains the shooter's perspective (their "right" stays "right")
                    const displayX = fieldSidesFlipped ? (105 - shot.position.x) : shot.position.x;
                    const displayY = fieldSidesFlipped ? (68 - shot.position.y) : shot.position.y;

                    if (isGoal) {
                        // Goal: Circle with star
                        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                        circle.setAttribute('cx', displayX);
                        circle.setAttribute('cy', displayY);
                        circle.setAttribute('r', '2');
                        circle.setAttribute('fill', color);
                        circle.setAttribute('opacity', '0.85');
                        circle.setAttribute('stroke', 'white');
                        circle.setAttribute('stroke-width', '0.3');
                        container.appendChild(circle);

                        const star = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                        star.setAttribute('x', displayX);
                        star.setAttribute('y', displayY + 0.8);
                        star.setAttribute('fill', 'white');
                        star.setAttribute('font-size', '2');
                        star.setAttribute('text-anchor', 'middle');
                        star.textContent = '';
                        container.appendChild(star);
                    } else if (isOnTarget) {
                        // Shot On Target: Square
                        const size = 2.5;
                        const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                        rect.setAttribute('x', displayX - size / 2);
                        rect.setAttribute('y', displayY - size / 2);
                        rect.setAttribute('width', size);
                        rect.setAttribute('height', size);
                        rect.setAttribute('fill', color);
                        rect.setAttribute('opacity', '0.85');
                        rect.setAttribute('stroke', 'white');
                        rect.setAttribute('stroke-width', '0.3');
                        container.appendChild(rect);
                    } else if (isOffTarget) {
                        // Shot Off Target: Triangle
                        const size = 1.5;
                        const points = `${displayX},${displayY - size} ${displayX - size},${displayY + size} ${displayX + size},${displayY + size}`;
                        const triangle = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
                        triangle.setAttribute('points', points);
                        triangle.setAttribute('fill', color);
                        triangle.setAttribute('opacity', '0.85');
                        triangle.setAttribute('stroke', 'white');
                        triangle.setAttribute('stroke-width', '0.3');
                        container.appendChild(triangle);
                    }
                }
            });
        }

        // Handle click on the field
        function handleFieldClick(event) {
            const field = document.getElementById('shot-map-field');
            const rect = field.getBoundingClientRect();

            // Calculate position as percentage (0-100) then convert to SVG coords (0-105 x 0-68)
            const xPercent = (event.clientX - rect.left) / rect.width;
            const yPercent = (event.clientY - rect.top) / rect.height;

            const svgX = xPercent * 105;
            const svgY = yPercent * 68;

            // Clamp to field boundaries
            selectedShotPosition = {
                x: Math.max(0.5, Math.min(104.5, svgX)),
                y: Math.max(0.5, Math.min(67.5, svgY))
            };

            // Update marker position
            const marker = document.getElementById('shot-marker');
            const markerCircle = document.getElementById('shot-marker-circle');

            // Set marker color based on team
            const teamColor = pendingShot.team === 'home'
                ? document.getElementById('home-color').value
                : document.getElementById('away-color').value;
            markerCircle.setAttribute('fill', teamColor);

            marker.setAttribute('transform', `translate(${selectedShotPosition.x}, ${selectedShotPosition.y})`);
            marker.style.display = 'block';

            // Determine zone description
            const zone = getFieldZone(selectedShotPosition.x, selectedShotPosition.y);
            document.getElementById('shot-position-display').textContent = `Shot from: ${zone}`;

            // Enable confirm button
            document.getElementById('confirm-shot-location-btn').disabled = false;
        }

        // Get descriptive zone name based on position
        function getFieldZone(x, y) {
            // Left side is home's attacking half, right side is away's
            const isLeftHalf = x < 52.5;
            const isMiddleY = y >= 20 && y <= 48;

            // Penalty box check (left: x < 17, right: x > 88)
            const inLeftPenaltyBox = x < 17 && y >= 13.84 && y <= 54.16;
            const inRightPenaltyBox = x > 88 && y >= 13.84 && y <= 54.16;

            // Goal area check
            const inLeftGoalArea = x < 6 && y >= 24.84 && y <= 43.16;
            const inRightGoalArea = x > 99 && y >= 24.84 && y <= 43.16;

            if (inLeftGoalArea) return 'Left 6-yard box';
            if (inRightGoalArea) return 'Right 6-yard box';
            if (inLeftPenaltyBox) return 'Left penalty area';
            if (inRightPenaltyBox) return 'Right penalty area';

            // Outside penalty boxes
            if (x < 17) return isMiddleY ? 'Left edge of box' : 'Left wing (deep)';
            if (x > 88) return isMiddleY ? 'Right edge of box' : 'Right wing (deep)';

            if (isLeftHalf) {
                if (isMiddleY) return 'Left center';
                return y < 34 ? 'Left wing' : 'Left wing';
            } else {
                if (isMiddleY) return 'Right center';
                return y < 34 ? 'Right wing' : 'Right wing';
            }
        }

        // Skip adding shot location
        window.skipShotLocation = function() {
            closeShotMapModal();
            completeShotRecording();
        }

        // Confirm shot location
        window.confirmShotLocation = function() {
            if (selectedShotPosition) {
                pendingShot.position = { ...selectedShotPosition };
            }
            closeShotMapModal();
            completeShotRecording();
        }

        // Close shot map modal
        function closeShotMapModal() {
            const modal = document.getElementById('shot-map-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            selectedShotPosition = null;
        }

        // Complete the shot recording
        function completeShotRecording() {
            if (!pendingShot) return;

            const teamState = gameState[pendingShot.team];
            const halfState = pendingShot.half === 1 ? teamState.firstHalf : teamState.secondHalf;

            switch(pendingShot.rawType) {
                case 'goal':
                    teamState.goals++;
                    teamState.onTarget++;
                    halfState.goals++;
                    halfState.onTarget++;
                    break;
                case 'on-target':
                    teamState.onTarget++;
                    halfState.onTarget++;
                    break;
                case 'off-target':
                    teamState.offTarget++;
                    halfState.offTarget++;
                    break;
            }

            gameState.log.unshift({
                team: pendingShot.team,
                teamName: pendingShot.teamName,
                type: pendingShot.type,
                half: pendingShot.half,
                gameTime: pendingShot.gameTime,
                clockSeconds: pendingShot.clockSeconds,
                position: pendingShot.position
            });

            pendingShot = null;
            updateDisplay();
        }

        // View shot map (read-only mode to see all recorded positions)
        window.viewShotMap = function() {
            const modal = document.getElementById('shot-map-modal');
            const teamDisplay = document.getElementById('shot-map-team');
            const typeDisplay = document.getElementById('shot-map-type');
            const homeLabel = document.getElementById('field-home-label');
            const awayLabel = document.getElementById('field-away-label');

            // Update labels with team names (swap if sides are flipped)
            const homeName = document.getElementById('home-team-input').value || 'HOME';
            const awayName = document.getElementById('away-team-input').value || 'AWAY';
            // homeLabel is on the left, awayLabel is on the right
            if (fieldSidesFlipped) {
                homeLabel.textContent = awayName.toUpperCase();
                awayLabel.textContent = homeName.toUpperCase();
            } else {
                homeLabel.textContent = homeName.toUpperCase();
                awayLabel.textContent = awayName.toUpperCase();
            }

            // Set header info for view mode
            teamDisplay.textContent = 'Shot Map';
            teamDisplay.style.color = '#334155';
            typeDisplay.textContent = `${gameState.log.filter(s => s.position).length} shots recorded`;

            // Update modal header text
            document.querySelector('#shot-map-modal h3').textContent = 'Shot Map';
            document.querySelector('#shot-map-modal h3 + p').textContent = 'All recorded shot positions for this game';

            // Reset marker (not needed in view mode)
            document.getElementById('shot-marker').style.display = 'none';

            // Draw all shots
            drawPreviousShots();

            // Update heat map controls
            updateHeatMapControls();

            // Show modal
            modal.classList.remove('hidden');
            modal.classList.add('flex');

            // Disable click handler in view mode (no shot to record)
            const clickArea = document.getElementById('shot-map-click-area');
            clickArea.onclick = null;

            // Update buttons for view mode
            document.getElementById('shot-position-display').innerHTML = `
                <div class="flex items-center gap-4 text-xs">
                    <div class="flex items-center gap-1.5">
                        <span class="w-3 h-3 rounded-full" style="background: ${document.getElementById('home-color').value};"></span>
                        <span>${homeName}</span>
                    </div>
                    <div class="flex items-center gap-1.5">
                        <span class="w-3 h-3 rounded-full" style="background: ${document.getElementById('away-color').value};"></span>
                        <span>${awayName}</span>
                    </div>
                    <div class="flex items-center gap-1.5">
                        <span></span>
                        <span>Goal</span>
                    </div>
                </div>
            `;
            document.getElementById('confirm-shot-location-btn').style.display = 'none';
            document.querySelector('#shot-map-modal button[onclick="skipShotLocation()"]').textContent = 'Close';
        }

        // Undo last shot
        window.undoLastShot = function() {
            if (gameState.log.length === 0) return;

            // Get the last entry
            const lastEntry = gameState.log.shift();
            const team = lastEntry.team;
            const teamState = gameState[team];
            const half = lastEntry.half;
            const halfState = half === 1 ? teamState.firstHalf : teamState.secondHalf;

            // Determine what type of shot it was and reverse it
            if (lastEntry.type === 'GOAL!') {
                teamState.goals--;
                teamState.onTarget--;
                halfState.goals--;
                halfState.onTarget--;
            } else if (lastEntry.type === 'Shot On Target') {
                teamState.onTarget--;
                halfState.onTarget--;
            } else if (lastEntry.type === 'Shot Off Target') {
                teamState.offTarget--;
                halfState.offTarget--;
            }

            updateDisplay();
        }

        // Delete a specific log entry
        window.deleteLogEntry = function(index) {
            if (index < 0 || index >= gameState.log.length) return;

            // Get the entry to delete
            const entry = gameState.log[index];
            const team = entry.team;
            const teamState = gameState[team];
            const half = entry.half;
            const halfState = half === 1 ? teamState.firstHalf : teamState.secondHalf;

            // Reverse the stats for this entry
            if (entry.type === 'GOAL!') {
                teamState.goals--;
                teamState.onTarget--;
                halfState.goals--;
                halfState.onTarget--;
            } else if (entry.type === 'Shot On Target') {
                teamState.onTarget--;
                halfState.onTarget--;
            } else if (entry.type === 'Shot Off Target') {
                teamState.offTarget--;
                halfState.offTarget--;
            }

            // Remove the entry from the log
            gameState.log.splice(index, 1);

            updateDisplay();
        }

        function updateDisplay() {
            // Update scores
            document.getElementById('home-score').textContent = gameState.home.goals;
            document.getElementById('away-score').textContent = gameState.away.goals;

            // Update home stats
            const homeTotalShots = gameState.home.onTarget + gameState.home.offTarget;
            const homeAccuracy = homeTotalShots > 0 ? Math.round((gameState.home.onTarget / homeTotalShots) * 100) : 0;

            document.getElementById('home-goals').textContent = gameState.home.goals;
            document.getElementById('home-on-target').textContent = gameState.home.onTarget;
            document.getElementById('home-off-target').textContent = gameState.home.offTarget;
            document.getElementById('home-total').textContent = homeTotalShots;
            document.getElementById('home-accuracy').textContent = homeAccuracy + '%';

            // Update away stats
            const awayTotalShots = gameState.away.onTarget + gameState.away.offTarget;
            const awayAccuracy = awayTotalShots > 0 ? Math.round((gameState.away.onTarget / awayTotalShots) * 100) : 0;

            document.getElementById('away-goals').textContent = gameState.away.goals;
            document.getElementById('away-on-target').textContent = gameState.away.onTarget;
            document.getElementById('away-off-target').textContent = gameState.away.offTarget;
            document.getElementById('away-total').textContent = awayTotalShots;
            document.getElementById('away-accuracy').textContent = awayAccuracy + '%';

            // Update home half breakdown
            document.getElementById('home-h1-goals').textContent = gameState.home.firstHalf.goals;
            document.getElementById('home-h1-on-target').textContent = gameState.home.firstHalf.onTarget;
            document.getElementById('home-h1-off-target').textContent = gameState.home.firstHalf.offTarget;
            document.getElementById('home-h2-goals').textContent = gameState.home.secondHalf.goals;
            document.getElementById('home-h2-on-target').textContent = gameState.home.secondHalf.onTarget;
            document.getElementById('home-h2-off-target').textContent = gameState.home.secondHalf.offTarget;

            // Update away half breakdown
            document.getElementById('away-h1-goals').textContent = gameState.away.firstHalf.goals;
            document.getElementById('away-h1-on-target').textContent = gameState.away.firstHalf.onTarget;
            document.getElementById('away-h1-off-target').textContent = gameState.away.firstHalf.offTarget;
            document.getElementById('away-h2-goals').textContent = gameState.away.secondHalf.goals;
            document.getElementById('away-h2-on-target').textContent = gameState.away.secondHalf.onTarget;
            document.getElementById('away-h2-off-target').textContent = gameState.away.secondHalf.offTarget;

            // Update log
            const logContainer = document.getElementById('log-entries');
            if (gameState.log.length === 0) {
                logContainer.innerHTML = `
                    <div class="empty-state text-center py-10 text-slate-400">
                        <div class="text-5xl mb-3">&#9917;</div>
                        <p>No shots recorded yet</p>
                    </div>
                `;
            } else {
                logContainer.innerHTML = gameState.log.map((entry, index) => {
                    const isGoal = entry.type === 'GOAL!';
                    const hasPlayer = entry.playerName;
                    const canEditPlayer = isGoal && entry.team === rosterTeam && roster.length > 0;

                    const playerDisplay = hasPlayer
                        ? `<span class="text-emerald-600 dark:text-emerald-400 font-medium ml-1">(${escapeHtml(entry.playerName)})</span>`
                        : (canEditPlayer ? `<button onclick="openEditGoalPlayerModal(${index})" class="text-slate-400 hover:text-emerald-500 ml-1 text-xs underline">+ add player</button>` : '');

                    const editPlayerBtn = hasPlayer && canEditPlayer
                        ? `<button class="text-slate-400 hover:text-emerald-500 hover:bg-emerald-50 dark:hover:bg-emerald-900/30 px-2 py-1 rounded text-xs transition-colors" onclick="openEditGoalPlayerModal(${index})">Edit</button>`
                        : '';

                    return `
                    <div class="log-entry ${entry.team} flex justify-between items-center p-3 rounded-xl mb-2 border-l-4" style="background: ${entry.team === 'home' ? hexToRgba(document.getElementById('home-color').value, 0.1) : hexToRgba(document.getElementById('away-color').value, 0.1)}; border-left-color: ${entry.team === 'home' ? document.getElementById('home-color').value : document.getElementById('away-color').value};">
                        <span class="flex-1"><span class="font-semibold">${entry.teamName}</span> <span class="text-slate-500 dark:text-slate-400">- ${entry.type}</span>${playerDisplay}</span>
                        <div class="flex items-center gap-2">
                            <span class="text-slate-400 text-sm">${entry.half ? (entry.half === 1 ? '1st' : '2nd') + '  ' : ''}${entry.gameTime || entry.time || ''}</span>
                            ${editPlayerBtn}
                            <button class="text-slate-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 px-2 py-1 rounded text-xs transition-colors" onclick="deleteLogEntry(${index})">Delete</button>
                        </div>
                    </div>
                `;
                }).join('');
            }

            // Update undo button state
            const undoBtn = document.getElementById('undo-btn');
            undoBtn.disabled = gameState.log.length === 0;

            // Update view shot map button state (enable if there are any shots with positions)
            const viewShotMapBtn = document.getElementById('view-shot-map-btn');
            const hasPositions = gameState.log.some(shot => shot.position);
            viewShotMapBtn.disabled = !hasPositions;

            // Update notes display
            updateNotesDisplay();
        }

        // Update notes display
        function updateNotesDisplay() {
            const notesContainer = document.getElementById('notes-entries');
            if (gameState.notes.length === 0) {
                notesContainer.innerHTML = `
                    <div class="empty-state text-center py-10 text-slate-400">
                        <div class="text-5xl mb-3">&#128221;</div>
                        <p>No notes yet</p>
                    </div>
                `;
            } else {
                notesContainer.innerHTML = gameState.notes.map(note => `
                    <div class="note-entry flex justify-between items-start p-3 rounded-xl mb-2 bg-amber-50 border-l-4 border-amber-400">
                        <span class="flex-1 text-slate-700">${note.content}</span>
                        <span class="text-slate-400 text-sm ml-3 whitespace-nowrap">${note.half ? (note.half === 1 ? '1st' : '2nd') + '  ' : ''}${note.gameTime}</span>
                    </div>
                `).join('');
            }
        }

        // Add a note
        window.addNote = function() {
            const noteInput = document.getElementById('note-input');
            const content = noteInput.value.trim();

            if (!content) return;

            gameState.notes.unshift({
                content: content,
                half: gameState.currentHalf,
                gameTime: getGameTime(),
                clockSeconds: clockState.seconds
            });

            noteInput.value = '';
            updateNotesDisplay();
        }

        // Save game to Supabase
        window.saveGame = async function() {
            // Check if user is logged in
            if (!currentUser) {
                showModal('Error', 'You must be logged in to save games.', null);
                return;
            }

            const homeTeam = document.getElementById('home-team-input').value || 'Home Team';
            const awayTeam = document.getElementById('away-team-input').value || 'Away Team';
            const gameDate = document.getElementById('game-date').value;

            if (gameState.home.onTarget + gameState.home.offTarget + gameState.away.onTarget + gameState.away.offTarget === 0) {
                showModal('No Data to Save', 'Please record at least one shot before saving the game.', null);
                return;
            }

            // Prepare game data for Supabase
            // The 'id' will be auto-generated by Supabase (UUID)
            const gameData = {
                user_id: currentUser.id,  // Link game to current user
                team_id: currentTeamId || null,  // Link game to team if in team context
                game_date: gameDate,
                home_team: homeTeam,
                away_team: awayTeam,
                home_color: document.getElementById('home-color').value,
                away_color: document.getElementById('away-color').value,
                home_stats: {
                    goals: gameState.home.goals,
                    onTarget: gameState.home.onTarget,
                    offTarget: gameState.home.offTarget,
                    firstHalf: { ...gameState.home.firstHalf },
                    secondHalf: { ...gameState.home.secondHalf }
                },
                away_stats: {
                    goals: gameState.away.goals,
                    onTarget: gameState.away.onTarget,
                    offTarget: gameState.away.offTarget,
                    firstHalf: { ...gameState.away.firstHalf },
                    secondHalf: { ...gameState.away.secondHalf }
                },
                shot_log: [...gameState.log],
                game_notes: [...gameState.notes],
                final_time: getGameTime(),
                final_clock_seconds: clockState.seconds
            };

            try {
                // Insert game into Supabase
                const { data, error } = await supabaseClient
                    .from('games')
                    .insert([gameData])
                    .select();

                if (error) {
                    console.error('Save error:', error);
                    showModal('Save Failed', 'Failed to save game: ' + error.message, null);
                    return;
                }

                // Reset after saving
                resetGameState();
                updateDisplay();

                // Refresh history view
                loadHistoryView();

                showModal('Game Saved!', `${homeTeam} ${gameData.home_stats.goals} - ${gameData.away_stats.goals} ${awayTeam} has been saved to your history.`, null);

                // If in team context, navigate back to team dashboard after a brief delay
                if (currentTeamId) {
                    const savedTeamId = currentTeamId;
                    setTimeout(() => {
                        closeModal();
                        navigateToTeamDashboard(savedTeamId);
                    }, 1500);
                }

            } catch (err) {
                console.error('Save error:', err);
                showModal('Save Failed', 'An unexpected error occurred while saving.', null);
            }
        }

        // Get saved games from Supabase
        // This is now an async function - callers need to await it
        async function getSavedGames(teamId) {
            if (!currentUser) {
                return [];
            }

            try {
                // Query games, filtered by team if provided, otherwise by user
                let query = supabaseClient
                    .from('games')
                    .select('*');

                if (teamId) {
                    query = query.eq('team_id', teamId);
                } else {
                    query = query.eq('user_id', currentUser.id);
                }

                const { data, error } = await query
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error('Load error:', error);
                    return [];
                }

                // Transform Supabase data back to the format expected by the UI
                return (data || []).map(game => ({
                    id: game.id,
                    date: game.game_date,
                    homeTeam: game.home_team,
                    awayTeam: game.away_team,
                    homeColor: game.home_color,
                    awayColor: game.away_color,
                    home: game.home_stats,
                    away: game.away_stats,
                    log: game.shot_log || [],
                    notes: game.game_notes || [],
                    finalTime: game.final_time,
                    finalClockSeconds: game.final_clock_seconds
                }));

            } catch (err) {
                console.error('Load error:', err);
                return [];
            }
        }

        // Load history view (async because getSavedGames is async)
        async function loadHistoryView() {
            const games = await getSavedGames(currentTeamId);
            updateStatsDisplay(games);
            updateGameList(games);
        }

        function updateStatsDisplay(games) {
            if (games.length === 0) {
                document.getElementById('total-games').textContent = '0';
                document.getElementById('avg-goals').textContent = '0';
                document.getElementById('total-shots').textContent = '0';
                document.getElementById('avg-accuracy').textContent = '0%';
                return;
            }

            let totalGoals = 0;
            let totalShots = 0;
            let totalOnTarget = 0;

            games.forEach(game => {
                totalGoals += game.home.goals + game.away.goals;
                totalShots += game.home.onTarget + game.home.offTarget + game.away.onTarget + game.away.offTarget;
                totalOnTarget += game.home.onTarget + game.away.onTarget;
            });

            const avgGoals = (totalGoals / games.length).toFixed(1);
            const avgAccuracy = totalShots > 0 ? Math.round((totalOnTarget / totalShots) * 100) : 0;

            document.getElementById('total-games').textContent = games.length;
            document.getElementById('avg-goals').textContent = avgGoals;
            document.getElementById('total-shots').textContent = totalShots;
            document.getElementById('avg-accuracy').textContent = avgAccuracy + '%';
        }

        function updateGameList(games) {
            historyGamesCache = games;
            const container = document.getElementById('game-list');

            if (games.length === 0) {
                container.innerHTML = `
                    <div class="empty-state text-center py-10 text-slate-400">
                        <div class="text-5xl mb-3">&#128202;</div>
                        <p>No saved games yet</p>
                        <p class="text-sm mt-2">Save your first game to see it here!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = games.map(game => {
                const homeTotalShots = game.home.onTarget + game.home.offTarget;
                const awayTotalShots = game.away.onTarget + game.away.offTarget;
                const homeAccuracy = homeTotalShots > 0 ? Math.round((game.home.onTarget / homeTotalShots) * 100) : 0;
                const awayAccuracy = awayTotalShots > 0 ? Math.round((game.away.onTarget / awayTotalShots) * 100) : 0;

                const formattedDate = new Date(game.date).toLocaleDateString('en-US', {
                    weekday: 'short',
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });

                // Use saved colors or fallback to defaults
                const homeColor = game.homeColor || '#10b981';
                const awayColor = game.awayColor || '#3b82f6';

                // Get half stats with fallback for older saved games
                const homeH1 = game.home.firstHalf || { goals: 0, onTarget: 0, offTarget: 0 };
                const homeH2 = game.home.secondHalf || { goals: 0, onTarget: 0, offTarget: 0 };
                const awayH1 = game.away.firstHalf || { goals: 0, onTarget: 0, offTarget: 0 };
                const awayH2 = game.away.secondHalf || { goals: 0, onTarget: 0, offTarget: 0 };

                // Check if we have half data
                const hasHalfData = game.home.firstHalf || game.home.secondHalf;

                // Check if we have any shots with positions
                const shotsWithPositions = (game.log || []).filter(shot => shot.position);
                const hasShotMap = shotsWithPositions.length > 0;

                // Generate shot markers SVG for the history view
                const shotMarkersSvg = shotsWithPositions.map(shot => {
                    const color = shot.team === 'home' ? homeColor : awayColor;
                    const isGoal = shot.type === 'GOAL!';
                    const isOnTarget = shot.type === 'Shot On Target';
                    const isOffTarget = shot.type === 'Shot Off Target';
                    // Normalize second-half shots to face the same goal as first-half shots
                    const x = shot.half === 2 ? (105 - shot.position.x) : shot.position.x;
                    const y = shot.half === 2 ? (68 - shot.position.y) : shot.position.y;

                    if (isGoal) {
                        return `
                            <circle cx="${x}" cy="${y}" r="2.5" fill="${color}" stroke="white" stroke-width="0.3" opacity="0.85"/>
                            <text x="${x}" y="${y + 0.8}" fill="white" font-size="2.5" text-anchor="middle"></text>
                        `;
                    } else if (isOnTarget) {
                        const size = 3;
                        return `<rect x="${x - size/2}" y="${y - size/2}" width="${size}" height="${size}" fill="${color}" stroke="white" stroke-width="0.3" opacity="0.85"/>`;
                    } else if (isOffTarget) {
                        const size = 2;
                        return `<polygon points="${x},${y - size} ${x - size},${y + size} ${x + size},${y + size}" fill="${color}" stroke="white" stroke-width="0.3" opacity="0.85"/>`;
                    }
                    return '';
                }).join('');

                return `
                    <div class="game-item bg-slate-50 dark:bg-slate-700 rounded-xl p-5 border border-slate-200 dark:border-slate-600 hover:border-emerald-300 hover:shadow-md transition-all duration-200" id="game-${game.id}">
                        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                            <div class="flex-1">
                                <div class="text-sm text-slate-400 mb-1">${formattedDate}</div>
                                <div class="font-semibold text-slate-800 dark:text-white">${game.homeTeam} vs ${game.awayTeam}</div>
                            </div>
                            <div class="text-2xl font-bold px-4">
                                <span style="color: ${homeColor};">${game.home.goals}</span>
                                <span class="text-slate-300 dark:text-slate-500 mx-1">-</span>
                                <span style="color: ${awayColor};">${game.away.goals}</span>
                            </div>
                            <div class="flex gap-4 text-sm text-slate-500 dark:text-slate-400">
                                <span>Shots: ${homeTotalShots + awayTotalShots}</span>
                                <span>On Target: ${game.home.onTarget + game.away.onTarget}</span>
                            </div>
                            <div class="flex gap-2">
                                <button class="px-4 py-2 border-2 border-slate-200 dark:border-slate-500 text-slate-500 dark:text-slate-300 rounded-xl text-sm font-semibold transition-all duration-200 hover:border-emerald-500 hover:text-emerald-500 hover:bg-emerald-50 dark:hover:bg-emerald-900/20" onclick="toggleGameDetails('${game.id}')">Details</button>
                                <button class="px-4 py-2 border-2 border-slate-200 dark:border-slate-500 text-slate-500 dark:text-slate-300 rounded-xl text-sm font-semibold transition-all duration-200 hover:border-blue-500 hover:text-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/20" onclick="exportGameToPDF('${game.id}')">Export</button>
                                <button class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-xl text-sm font-semibold transition-all duration-200" onclick="confirmDeleteGame('${game.id}')">Delete</button>
                            </div>
                        </div>
                        <div class="expanded-stats hidden mt-5 pt-5 border-t border-slate-200 dark:border-slate-600">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                                <div class="team-stats-block home p-4 bg-white dark:bg-slate-800 rounded-xl border-t-4" style="border-color: ${homeColor};">
                                    <h4 class="font-semibold mb-3 pb-2 border-b-2" style="color: ${homeColor}; border-color: ${homeColor};">${game.homeTeam}</h4>
                                    <div class="space-y-1 text-sm">
                                        <div class="flex justify-between py-1"><span class="text-slate-500 dark:text-slate-400">Goals</span><span class="font-semibold dark:text-white">${game.home.goals}</span></div>
                                        <div class="flex justify-between py-1"><span class="text-slate-500 dark:text-slate-400">Shots On Target</span><span class="font-semibold dark:text-white">${game.home.onTarget}</span></div>
                                        <div class="flex justify-between py-1"><span class="text-slate-500 dark:text-slate-400">Shots Off Target</span><span class="font-semibold dark:text-white">${game.home.offTarget}</span></div>
                                        <div class="flex justify-between py-1"><span class="text-slate-500 dark:text-slate-400">Total Shots</span><span class="font-semibold dark:text-white">${homeTotalShots}</span></div>
                                        <div class="flex justify-between py-1"><span class="text-slate-500 dark:text-slate-400">Shot Accuracy</span><span class="font-semibold dark:text-white">${homeAccuracy}%</span></div>
                                    </div>
                                    ${hasHalfData ? `
                                    <div class="mt-3 pt-3 border-t border-slate-200 dark:border-slate-600">
                                        <div class="text-xs font-semibold text-slate-400 uppercase mb-2">By Half</div>
                                        <div class="grid grid-cols-2 gap-2 text-xs">
                                            <div class="bg-slate-50 dark:bg-slate-700 rounded-lg p-2">
                                                <div class="font-semibold text-slate-400 mb-1">1st</div>
                                                <div class="flex justify-between"><span class="dark:text-slate-400">Goals</span><span class="font-semibold dark:text-slate-200">${homeH1.goals}</span></div>
                                                <div class="flex justify-between"><span class="dark:text-slate-400">On Target</span><span class="font-semibold dark:text-slate-200">${homeH1.onTarget}</span></div>
                                                <div class="flex justify-between"><span class="dark:text-slate-400">Off Target</span><span class="font-semibold dark:text-slate-200">${homeH1.offTarget}</span></div>
                                            </div>
                                            <div class="bg-slate-50 dark:bg-slate-700 rounded-lg p-2">
                                                <div class="font-semibold text-slate-400 mb-1">2nd</div>
                                                <div class="flex justify-between"><span class="dark:text-slate-400">Goals</span><span class="font-semibold dark:text-slate-200">${homeH2.goals}</span></div>
                                                <div class="flex justify-between"><span class="dark:text-slate-400">On Target</span><span class="font-semibold dark:text-slate-200">${homeH2.onTarget}</span></div>
                                                <div class="flex justify-between"><span class="dark:text-slate-400">Off Target</span><span class="font-semibold dark:text-slate-200">${homeH2.offTarget}</span></div>
                                            </div>
                                        </div>
                                    </div>
                                    ` : ''}
                                </div>
                                <div class="team-stats-block away p-4 bg-white dark:bg-slate-800 rounded-xl border-t-4" style="border-color: ${awayColor};">
                                    <h4 class="font-semibold mb-3 pb-2 border-b-2" style="color: ${awayColor}; border-color: ${awayColor};">${game.awayTeam}</h4>
                                    <div class="space-y-1 text-sm">
                                        <div class="flex justify-between py-1"><span class="text-slate-500 dark:text-slate-400">Goals</span><span class="font-semibold dark:text-white">${game.away.goals}</span></div>
                                        <div class="flex justify-between py-1"><span class="text-slate-500 dark:text-slate-400">Shots On Target</span><span class="font-semibold dark:text-white">${game.away.onTarget}</span></div>
                                        <div class="flex justify-between py-1"><span class="text-slate-500 dark:text-slate-400">Shots Off Target</span><span class="font-semibold dark:text-white">${game.away.offTarget}</span></div>
                                        <div class="flex justify-between py-1"><span class="text-slate-500 dark:text-slate-400">Total Shots</span><span class="font-semibold dark:text-white">${awayTotalShots}</span></div>
                                        <div class="flex justify-between py-1"><span class="text-slate-500 dark:text-slate-400">Shot Accuracy</span><span class="font-semibold dark:text-white">${awayAccuracy}%</span></div>
                                    </div>
                                    ${hasHalfData ? `
                                    <div class="mt-3 pt-3 border-t border-slate-200 dark:border-slate-600">
                                        <div class="text-xs font-semibold text-slate-400 uppercase mb-2">By Half</div>
                                        <div class="grid grid-cols-2 gap-2 text-xs">
                                            <div class="bg-slate-50 dark:bg-slate-700 rounded-lg p-2">
                                                <div class="font-semibold text-slate-400 mb-1">1st</div>
                                                <div class="flex justify-between"><span class="dark:text-slate-400">Goals</span><span class="font-semibold dark:text-slate-200">${awayH1.goals}</span></div>
                                                <div class="flex justify-between"><span class="dark:text-slate-400">On Target</span><span class="font-semibold dark:text-slate-200">${awayH1.onTarget}</span></div>
                                                <div class="flex justify-between"><span class="dark:text-slate-400">Off Target</span><span class="font-semibold dark:text-slate-200">${awayH1.offTarget}</span></div>
                                            </div>
                                            <div class="bg-slate-50 dark:bg-slate-700 rounded-lg p-2">
                                                <div class="font-semibold text-slate-400 mb-1">2nd</div>
                                                <div class="flex justify-between"><span class="dark:text-slate-400">Goals</span><span class="font-semibold dark:text-slate-200">${awayH2.goals}</span></div>
                                                <div class="flex justify-between"><span class="dark:text-slate-400">On Target</span><span class="font-semibold dark:text-slate-200">${awayH2.onTarget}</span></div>
                                                <div class="flex justify-between"><span class="dark:text-slate-400">Off Target</span><span class="font-semibold dark:text-slate-200">${awayH2.offTarget}</span></div>
                                            </div>
                                        </div>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                            ${hasShotMap ? `
                            <!-- Shot Map Visualization -->
                            <div class="mt-5 pt-5 border-t border-slate-200 dark:border-slate-600">
                                <div class="mb-3">
                                    <div class="flex items-center justify-between">
                                        <div class="text-sm font-semibold text-slate-700 dark:text-slate-200">Shot Map</div>
                                        ${shotsWithPositions.length >= 10 ? `
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <span class="text-xs text-slate-500 dark:text-slate-400">Heat Map</span>
                                            <input type="checkbox" class="sr-only peer history-heat-map-toggle" data-game-id="${game.id}" onchange="toggleHistoryHeatMap('${game.id}', this.checked)">
                                            <div class="w-8 h-4 bg-slate-300 dark:bg-slate-600 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-emerald-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:bg-orange-500 relative"></div>
                                        </label>
                                        ` : `<span class="text-xs text-slate-400">${shotsWithPositions.length}/10 shots for heat map</span>`}
                                    </div>
                                    <!-- Team Filter Buttons for History Heat Map -->
                                    <div class="flex items-center justify-center gap-1 mt-2" id="history-heat-map-filter-${game.id}" style="display: none;">
                                        <button type="button" id="history-filter-home-${game.id}" onclick="setHistoryHeatMapFilter('${game.id}', 'home')" class="px-3 py-1 text-xs font-medium rounded-lg transition-all duration-200 bg-orange-500 text-white">${game.homeTeam}</button>
                                        <button type="button" id="history-filter-away-${game.id}" onclick="setHistoryHeatMapFilter('${game.id}', 'away')" class="px-3 py-1 text-xs font-medium rounded-lg transition-all duration-200 bg-slate-200 dark:bg-slate-600 text-slate-600 dark:text-slate-300 hover:bg-slate-300 dark:hover:bg-slate-500">${game.awayTeam}</button>
                                    </div>
                                </div>
                                <div class="relative bg-emerald-600 rounded-xl overflow-hidden" id="history-field-${game.id}" style="aspect-ratio: 105/68;">
                                    <svg viewBox="0 0 105 68" class="w-full h-full">
                                        <!-- Field background -->
                                        <rect x="0" y="0" width="105" height="68" fill="#2d8a4e"/>
                                        <!-- Field stripes -->
                                        <g fill="#3d9a5e" opacity="0.5">
                                            <rect x="0" y="0" width="10.5" height="68"/>
                                            <rect x="21" y="0" width="10.5" height="68"/>
                                            <rect x="42" y="0" width="10.5" height="68"/>
                                            <rect x="63" y="0" width="10.5" height="68"/>
                                            <rect x="84" y="0" width="10.5" height="68"/>
                                        </g>
                                        <!-- Field lines -->
                                        <g fill="none" stroke="white" stroke-width="0.3">
                                            <rect x="0.5" y="0.5" width="104" height="67"/>
                                            <line x1="52.5" y1="0.5" x2="52.5" y2="67.5"/>
                                            <circle cx="52.5" cy="34" r="9.15"/>
                                            <circle cx="52.5" cy="34" r="0.5" fill="white"/>
                                            <rect x="0.5" y="13.84" width="16.5" height="40.32"/>
                                            <rect x="0.5" y="24.84" width="5.5" height="18.32"/>
                                            <circle cx="11" cy="34" r="0.5" fill="white"/>
                                            <path d="M 16.5 27.5 A 9.15 9.15 0 0 1 16.5 40.5"/>
                                            <rect x="88" y="13.84" width="16.5" height="40.32"/>
                                            <rect x="99" y="24.84" width="5.5" height="18.32"/>
                                            <circle cx="94" cy="34" r="0.5" fill="white"/>
                                            <path d="M 88 27.5 A 9.15 9.15 0 0 0 88 40.5"/>
                                        </g>
                                        <!-- Team labels -->
                                        <text x="2" y="5" fill="white" font-size="3" font-weight="bold" opacity="0.7" text-anchor="start">${game.homeTeam.toUpperCase()}</text>
                                        <text x="103" y="5" fill="white" font-size="3" font-weight="bold" opacity="0.7" text-anchor="end">${game.awayTeam.toUpperCase()}</text>
                                        <!-- Shot markers -->
                                        ${shotMarkersSvg}
                                    </svg>
                                    <!-- Heat map canvas for history view -->
                                    <canvas id="history-heat-map-${game.id}" class="absolute inset-0 w-full h-full pointer-events-none" style="display: none;"></canvas>
                                </div>
                                <div class="flex flex-wrap items-center justify-center gap-4 mt-3 text-xs text-slate-500 dark:text-slate-400">
                                    <div class="flex items-center gap-1.5">
                                        <span class="w-3 h-3 rounded-full" style="background: ${homeColor};"></span>
                                        <span>${game.homeTeam}</span>
                                    </div>
                                    <div class="flex items-center gap-1.5">
                                        <span class="w-3 h-3 rounded-full" style="background: ${awayColor};"></span>
                                        <span>${game.awayTeam}</span>
                                    </div>
                                    <div class="flex items-center gap-1.5">
                                        <svg width="12" height="12" viewBox="0 0 14 14">
                                            <circle cx="7" cy="7" r="5" fill="#6b7280" stroke="white" stroke-width="1"/>
                                            <text x="7" y="9" fill="white" font-size="6" text-anchor="middle"></text>
                                        </svg>
                                        <span>Goal</span>
                                    </div>
                                    <div class="flex items-center gap-1.5">
                                        <svg width="12" height="12" viewBox="0 0 14 14">
                                            <rect x="3" y="3" width="8" height="8" fill="#6b7280" stroke="white" stroke-width="1"/>
                                        </svg>
                                        <span>On Target</span>
                                    </div>
                                    <div class="flex items-center gap-1.5">
                                        <svg width="12" height="12" viewBox="0 0 14 14">
                                            <polygon points="7,2 2,12 12,12" fill="#6b7280" stroke="white" stroke-width="1"/>
                                        </svg>
                                        <span>Off Target</span>
                                    </div>
                                </div>
                            </div>
                            ` : ''}
                            ${(() => {
                                // Get all goals from the log with their original indices
                                const allGoals = [];
                                (game.log || []).forEach((shot, idx) => {
                                    if (shot.type === 'GOAL!') {
                                        allGoals.push({ ...shot, _logIndex: idx });
                                    }
                                });

                                if (allGoals.length === 0) return '';

                                // Calculate player stats for goals (only for attributed goals)
                                const playerGoals = {};
                                allGoals.forEach(shot => {
                                    if (shot.playerName) {
                                        const key = shot.playerId || shot.playerName;
                                        if (!playerGoals[key]) {
                                            playerGoals[key] = { name: shot.playerName, goals: 0 };
                                        }
                                        playerGoals[key].goals++;
                                    }
                                });
                                const playerStatsList = Object.values(playerGoals).sort((a, b) => b.goals - a.goals);
                                const hasPlayerStats = playerStatsList.length > 0;

                                return `
                            <!-- Goal Timeline -->
                            <div class="mt-5 pt-5 border-t border-slate-200 dark:border-slate-600">
                                <div class="flex items-center gap-2 mb-3">
                                    <div class="text-sm font-semibold text-slate-700 dark:text-slate-200">Goal Timeline</div>
                                    <span class="px-1.5 py-0.5 bg-amber-100 dark:bg-amber-900/50 text-amber-700 dark:text-amber-400 text-[10px] font-bold uppercase rounded">BETA</span>
                                </div>
                                ${rosters.length > 0 ? `
                                <div class="mb-3">
                                    <div class="text-xs text-slate-400 mb-1.5">Select roster to edit scorers:</div>
                                    <div class="flex flex-wrap gap-1.5" id="history-roster-selector-${game.id}">
                                        ${rosters.map(r => `
                                            <button data-roster-id="${r.id}" onclick="selectHistoryRoster('${r.id}', '${game.id}')" class="px-2.5 py-1 text-xs font-medium rounded-full transition-colors bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-emerald-50 dark:hover:bg-emerald-900/30">
                                                ${r.name}
                                            </button>
                                        `).join('')}
                                    </div>
                                </div>
                                ` : ''}
                                <div class="space-y-2">
                                    ${allGoals.map(goal => {
                                        const teamColor = goal.team === 'home' ? homeColor : awayColor;
                                        const teamName = goal.team === 'home' ? game.homeTeam : game.awayTeam;
                                        return `
                                        <div class="history-goal-row-${game.id} flex items-center gap-3 p-3 bg-white dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-600 transition-all"
                                            data-game-id="${game.id}" data-log-index="${goal._logIndex}" data-player-id="${goal.playerId || ''}"
                                            onclick="openHistoryEditGoalPlayerModal(this.dataset.gameId, parseInt(this.dataset.logIndex), this.dataset.playerId || null)"
                                        >
                                            <div class="flex-shrink-0 w-14 text-center">
                                                <div class="text-sm font-bold text-slate-700 dark:text-slate-200">${goal.gameTime || '--:--'}</div>
                                                <div class="text-[10px] text-slate-400">${goal.half || ''}</div>
                                            </div>
                                            <div class="w-px h-8 bg-slate-200 dark:bg-slate-600"></div>
                                            <div class="flex items-center gap-2 flex-1">
                                                <div class="w-3 h-3 rounded-full flex-shrink-0" style="background: ${teamColor};"></div>
                                                <div class="flex-1 min-w-0">
                                                    <div class="text-sm font-medium text-slate-800 dark:text-white truncate">
                                                        ${goal.playerName ? goal.playerName : '<span class="text-slate-400 italic">Unknown scorer</span>'}
                                                    </div>
                                                    <div class="text-xs text-slate-500 dark:text-slate-400">${teamName}</div>
                                                </div>
                                            </div>
                                            <div class="flex-shrink-0 text-lg"></div>
                                        </div>
                                        `;
                                    }).join('')}
                                </div>
                                ${hasPlayerStats ? `
                                <div class="mt-4 pt-4 border-t border-slate-100 dark:border-slate-700">
                                    <div class="text-xs font-semibold text-slate-400 uppercase mb-2">Summary</div>
                                    <div class="flex flex-wrap gap-2">
                                        ${playerStatsList.map(player => `
                                            <span class="inline-flex items-center gap-1 px-2 py-1 bg-emerald-50 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-400 rounded-full text-xs font-medium">
                                                ${player.name} <span class="font-bold">${player.goals}</span>
                                            </span>
                                        `).join('')}
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                                `;
                            })()}
                            ${(game.notes && game.notes.length > 0) ? `
                            <!-- Game Notes -->
                            <div class="mt-5 pt-5 border-t border-slate-200 dark:border-slate-600">
                                <div class="text-sm font-semibold text-slate-700 dark:text-slate-200 mb-3">Game Notes</div>
                                <div class="space-y-2">
                                    ${game.notes.map(note => `
                                        <div class="bg-white dark:bg-slate-800 rounded-lg p-3 border border-slate-200 dark:border-slate-600">
                                            <div class="flex items-start gap-2">
                                                <span class="text-xs font-mono text-slate-400 whitespace-nowrap">${note.gameTime || note.timestamp || ''}</span>
                                                <span class="text-sm text-slate-600 dark:text-slate-300">${note.content || note.text || ''}</span>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        window.toggleGameDetails = function(gameId) {
            const gameItem = document.getElementById(`game-${gameId}`);
            const expandedStats = gameItem.querySelector('.expanded-stats');
            expandedStats.classList.toggle('hidden');
        }

        // Delete game
        window.confirmDeleteGame = function(gameId) {
            showModal(
                'Delete Game',
                'Are you sure you want to delete this game? This action cannot be undone.',
                () => deleteGame(gameId)
            );
        }

        // Delete game from Supabase
        async function deleteGame(gameId) {
            try {
                const { error } = await supabaseClient
                    .from('games')
                    .delete()
                    .eq('id', gameId)
                    .eq('user_id', currentUser.id);  // Extra safety: only delete user's own games

                if (error) {
                    console.error('Delete error:', error);
                    showModal('Delete Failed', 'Failed to delete game: ' + error.message, null);
                    return;
                }

                loadHistoryView();
                closeModal();

            } catch (err) {
                console.error('Delete error:', err);
                showModal('Delete Failed', 'An unexpected error occurred while deleting.', null);
            }
        }

        // Reset game
        window.confirmReset = function() {
            showModal(
                'Reset Game',
                'Are you sure you want to reset? All current game data will be lost.',
                () => {
                    resetGameState();
                    updateDisplay();
                    closeModal();
                }
            );
        }

        function resetGameState() {
            gameState = {
                home: {
                    goals: 0, onTarget: 0, offTarget: 0,
                    firstHalf: { goals: 0, onTarget: 0, offTarget: 0 },
                    secondHalf: { goals: 0, onTarget: 0, offTarget: 0 }
                },
                away: {
                    goals: 0, onTarget: 0, offTarget: 0,
                    firstHalf: { goals: 0, onTarget: 0, offTarget: 0 },
                    secondHalf: { goals: 0, onTarget: 0, offTarget: 0 }
                },
                log: [],
                notes: [],
                currentHalf: 1
            };

            document.getElementById('home-team-input').value = '';
            document.getElementById('away-team-input').value = '';
            document.getElementById('home-name-display').textContent = 'Home Team';
            document.getElementById('away-name-display').textContent = 'Away Team';
            document.getElementById('home-panel-title').innerHTML = '<span class="w-3 h-3 rounded-full bg-emerald-500 inline-block mr-2"></span>Home Team';
            document.getElementById('away-panel-title').innerHTML = '<span class="w-3 h-3 rounded-full bg-blue-500 inline-block mr-2"></span>Away Team';
            document.getElementById('game-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('note-input').value = '';

            // Reset half selector
            setHalf(1);

            // Reset clock
            resetClock();

            // Reset colors to defaults
            document.getElementById('home-color').value = '#10b981';
            document.getElementById('away-color').value = '#3b82f6';
            applyTeamColors();

            // Reset shot map toggle
            shotMapEnabled = false;
            const toggle = document.getElementById('shot-map-toggle');
            const dot = document.getElementById('shot-map-toggle-dot');
            toggle.classList.add('bg-slate-300');
            toggle.classList.remove('bg-emerald-500');
            dot.style.transform = 'translateX(0)';

            // Reset field sides
            fieldSidesFlipped = false;
            updateFieldSidesLabel();

            // Reset notes display
            updateNotesDisplay();
        }

        // Export saved game to PDF
        window.exportGameToPDF = async function(gameId) {
            const games = await getSavedGames();
            const game = games.find(g => g.id === gameId);

            if (!game) {
                showModal('Error', 'Game not found.', null);
                return;
            }

            const homeTeam = game.homeTeam;
            const awayTeam = game.awayTeam;
            const homeColor = game.homeColor || '#10b981';
            const awayColor = game.awayColor || '#3b82f6';

            const formattedDate = new Date(game.date).toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            const homeTotalShots = game.home.onTarget + game.home.offTarget;
            const awayTotalShots = game.away.onTarget + game.away.offTarget;
            const homeAccuracy = homeTotalShots > 0 ? Math.round((game.home.onTarget / homeTotalShots) * 100) : 0;
            const awayAccuracy = awayTotalShots > 0 ? Math.round((game.away.onTarget / awayTotalShots) * 100) : 0;

            // Get half stats with fallback for older saved games
            const homeH1 = game.home.firstHalf || { goals: 0, onTarget: 0, offTarget: 0 };
            const homeH2 = game.home.secondHalf || { goals: 0, onTarget: 0, offTarget: 0 };
            const awayH1 = game.away.firstHalf || { goals: 0, onTarget: 0, offTarget: 0 };
            const awayH2 = game.away.secondHalf || { goals: 0, onTarget: 0, offTarget: 0 };
            const hasHalfData = game.home.firstHalf || game.home.secondHalf;

            // Check for shot map data
            const shotsWithPositions = (game.log || []).filter(shot => shot.position);
            const hasShotMap = shotsWithPositions.length > 0;

            // Generate shot markers for PDF
            const pdfShotMarkers = shotsWithPositions.map(shot => {
                const color = shot.team === 'home' ? homeColor : awayColor;
                const isGoal = shot.type === 'GOAL!';
                const isOnTarget = shot.type === 'Shot On Target';
                const isOffTarget = shot.type === 'Shot Off Target';
                // Normalize second-half shots to face the same goal as first-half shots
                const x = shot.half === 2 ? (105 - shot.position.x) : shot.position.x;
                const y = shot.half === 2 ? (68 - shot.position.y) : shot.position.y;

                if (isGoal) {
                    return `
                        <circle cx="${x}" cy="${y}" r="2.5" fill="${color}" stroke="white" stroke-width="0.3" opacity="0.9"/>
                        <text x="${x}" y="${y + 1}" fill="white" font-size="2.5" text-anchor="middle" font-family="Arial"></text>
                    `;
                } else if (isOnTarget) {
                    const size = 3;
                    return `<rect x="${x - size/2}" y="${y - size/2}" width="${size}" height="${size}" fill="${color}" stroke="white" stroke-width="0.3" opacity="0.9"/>`;
                } else if (isOffTarget) {
                    const size = 2;
                    return `<polygon points="${x},${y - size} ${x - size},${y + size} ${x + size},${y + size}" fill="${color}" stroke="white" stroke-width="0.3" opacity="0.9"/>`;
                }
                return '';
            }).join('');

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Game Report - ${homeTeam} vs ${awayTeam}</title>
                    <style>
                        @page {
                            size: letter;
                            margin: 0.5in;
                        }
                        * { box-sizing: border-box; margin: 0; padding: 0; }
                        body {
                            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                            padding: 20px;
                            color: #111827;
                            line-height: 1.4;
                            max-width: 100%;
                        }
                        .header {
                            text-align: center;
                            margin-bottom: 15px;
                            padding-bottom: 10px;
                            border-bottom: 2px solid #e5e7eb;
                        }
                        .header h1 { font-size: 1.25rem; color: #6b7280; margin-bottom: 5px; }
                        .header .date { color: #9ca3af; font-size: 0.85rem; }
                        .scoreboard {
                            display: flex;
                            justify-content: center;
                            align-items: center;
                            gap: 30px;
                            margin: 15px 0;
                            padding: 15px;
                            background: #f9fafb;
                            border-radius: 8px;
                        }
                        .team-score { text-align: center; }
                        .team-name { font-size: 1rem; font-weight: 600; margin-bottom: 5px; }
                        .score { font-size: 2rem; font-weight: 800; }
                        .vs { font-size: 1rem; color: #9ca3af; font-weight: 600; }
                        .stats-section { margin: 15px 0; }
                        .stats-section h2 {
                            font-size: 0.95rem;
                            margin-bottom: 10px;
                            padding-bottom: 5px;
                            border-bottom: 1px solid #e5e7eb;
                        }
                        .stats-grid {
                            display: grid;
                            grid-template-columns: 1fr 1fr;
                            gap: 15px;
                        }
                        .team-stats { padding: 12px; background: #f9fafb; border-radius: 6px; }
                        .team-stats h3 {
                            font-size: 0.9rem;
                            margin-bottom: 8px;
                            padding-bottom: 5px;
                            border-bottom: 2px solid;
                        }
                        .stat-row {
                            display: flex;
                            justify-content: space-between;
                            padding: 4px 0;
                            font-size: 0.8rem;
                            border-bottom: 1px solid #e5e7eb;
                        }
                        .stat-row:last-child { border-bottom: none; }
                        .stat-label { color: #6b7280; }
                        .stat-value { font-weight: 600; }
                        .half-stats { margin-top: 10px; padding-top: 10px; border-top: 1px dashed #e5e7eb; }
                        .half-stats h4 { font-size: 0.75rem; color: #6b7280; margin-bottom: 6px; }
                        .half-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
                        .half-column h5 { font-size: 0.7rem; color: #9ca3af; margin-bottom: 4px; }
                        .half-stat { display: flex; justify-content: space-between; font-size: 0.75rem; padding: 2px 0; }
                        .footer {
                            margin-top: 20px;
                            padding-top: 10px;
                            border-top: 1px solid #e5e7eb;
                            text-align: center;
                            color: #9ca3af;
                            font-size: 0.7rem;
                        }
                        .inspiration {
                            font-style: italic;
                            margin-top: 5px;
                        }
                        .shot-map-section {
                            margin: 15px 0;
                            page-break-inside: avoid;
                        }
                        .shot-map-section h2 {
                            font-size: 0.95rem;
                            margin-bottom: 10px;
                            padding-bottom: 5px;
                            border-bottom: 1px solid #e5e7eb;
                        }
                        .shot-map-container {
                            border-radius: 8px;
                            overflow: hidden;
                            background: #2d8a4e;
                        }
                        .shot-map-legend {
                            display: flex;
                            justify-content: center;
                            gap: 20px;
                            margin-top: 8px;
                            font-size: 0.7rem;
                            color: #6b7280;
                        }
                        .legend-item {
                            display: flex;
                            align-items: center;
                            gap: 4px;
                        }
                        .legend-dot {
                            width: 10px;
                            height: 10px;
                            border-radius: 50%;
                        }
                        .notes-section {
                            margin: 15px 0;
                            page-break-inside: avoid;
                        }
                        .notes-section h2 {
                            font-size: 0.95rem;
                            margin-bottom: 10px;
                            padding-bottom: 5px;
                            border-bottom: 1px solid #e5e7eb;
                        }
                        .note-item {
                            padding: 8px 10px;
                            background: #f9fafb;
                            border-radius: 6px;
                            margin-bottom: 6px;
                            font-size: 0.8rem;
                        }
                        .note-timestamp {
                            font-family: monospace;
                            color: #9ca3af;
                            font-size: 0.7rem;
                            margin-right: 8px;
                        }
                        .note-text {
                            color: #374151;
                        }
                        @media print {
                            body { padding: 0; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>Game Report</h1>
                        <div class="date">${formattedDate}</div>
                    </div>

                    <div class="scoreboard">
                        <div class="team-score">
                            <div class="team-name" style="color: ${homeColor}">${homeTeam}</div>
                            <div class="score" style="color: ${homeColor}">${game.home.goals}</div>
                        </div>
                        <div class="vs">VS</div>
                        <div class="team-score">
                            <div class="team-name" style="color: ${awayColor}">${awayTeam}</div>
                            <div class="score" style="color: ${awayColor}">${game.away.goals}</div>
                        </div>
                    </div>

                    <div class="stats-section">
                        <h2>Statistics</h2>
                        <div class="stats-grid">
                            <div class="team-stats">
                                <h3 style="border-color: ${homeColor}; color: ${homeColor}">${homeTeam}</h3>
                                <div class="stat-row">
                                    <span class="stat-label">Goals</span>
                                    <span class="stat-value">${game.home.goals}</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Shots On Target</span>
                                    <span class="stat-value">${game.home.onTarget}</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Shots Off Target</span>
                                    <span class="stat-value">${game.home.offTarget}</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Total Shots</span>
                                    <span class="stat-value">${homeTotalShots}</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Shot Accuracy</span>
                                    <span class="stat-value">${homeAccuracy}%</span>
                                </div>
                                ${hasHalfData ? `
                                <div class="half-stats">
                                    <h4>By Half</h4>
                                    <div class="half-grid">
                                        <div class="half-column">
                                            <h5>1st Half</h5>
                                            <div class="half-stat"><span>Goals</span><span>${homeH1.goals}</span></div>
                                            <div class="half-stat"><span>On Target</span><span>${homeH1.onTarget}</span></div>
                                            <div class="half-stat"><span>Off Target</span><span>${homeH1.offTarget}</span></div>
                                        </div>
                                        <div class="half-column">
                                            <h5>2nd Half</h5>
                                            <div class="half-stat"><span>Goals</span><span>${homeH2.goals}</span></div>
                                            <div class="half-stat"><span>On Target</span><span>${homeH2.onTarget}</span></div>
                                            <div class="half-stat"><span>Off Target</span><span>${homeH2.offTarget}</span></div>
                                        </div>
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                            <div class="team-stats">
                                <h3 style="border-color: ${awayColor}; color: ${awayColor}">${awayTeam}</h3>
                                <div class="stat-row">
                                    <span class="stat-label">Goals</span>
                                    <span class="stat-value">${game.away.goals}</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Shots On Target</span>
                                    <span class="stat-value">${game.away.onTarget}</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Shots Off Target</span>
                                    <span class="stat-value">${game.away.offTarget}</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Total Shots</span>
                                    <span class="stat-value">${awayTotalShots}</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Shot Accuracy</span>
                                    <span class="stat-value">${awayAccuracy}%</span>
                                </div>
                                ${hasHalfData ? `
                                <div class="half-stats">
                                    <h4>By Half</h4>
                                    <div class="half-grid">
                                        <div class="half-column">
                                            <h5>1st Half</h5>
                                            <div class="half-stat"><span>Goals</span><span>${awayH1.goals}</span></div>
                                            <div class="half-stat"><span>On Target</span><span>${awayH1.onTarget}</span></div>
                                            <div class="half-stat"><span>Off Target</span><span>${awayH1.offTarget}</span></div>
                                        </div>
                                        <div class="half-column">
                                            <h5>2nd Half</h5>
                                            <div class="half-stat"><span>Goals</span><span>${awayH2.goals}</span></div>
                                            <div class="half-stat"><span>On Target</span><span>${awayH2.onTarget}</span></div>
                                            <div class="half-stat"><span>Off Target</span><span>${awayH2.offTarget}</span></div>
                                        </div>
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>

                    ${hasShotMap ? `
                    <div class="shot-map-section">
                        <h2>Shot Map</h2>
                        <div class="shot-map-container">
                            <svg viewBox="0 0 105 68" style="width: 100%; height: auto; display: block;">
                                <!-- Field background -->
                                <rect x="0" y="0" width="105" height="68" fill="#2d8a4e"/>
                                <!-- Field stripes -->
                                <g fill="#3d9a5e" opacity="0.5">
                                    <rect x="0" y="0" width="10.5" height="68"/>
                                    <rect x="21" y="0" width="10.5" height="68"/>
                                    <rect x="42" y="0" width="10.5" height="68"/>
                                    <rect x="63" y="0" width="10.5" height="68"/>
                                    <rect x="84" y="0" width="10.5" height="68"/>
                                </g>
                                <!-- Field lines -->
                                <g fill="none" stroke="white" stroke-width="0.3">
                                    <rect x="0.5" y="0.5" width="104" height="67"/>
                                    <line x1="52.5" y1="0.5" x2="52.5" y2="67.5"/>
                                    <circle cx="52.5" cy="34" r="9.15"/>
                                    <circle cx="52.5" cy="34" r="0.5" fill="white"/>
                                    <rect x="0.5" y="13.84" width="16.5" height="40.32"/>
                                    <rect x="0.5" y="24.84" width="5.5" height="18.32"/>
                                    <circle cx="11" cy="34" r="0.5" fill="white"/>
                                    <path d="M 16.5 27.5 A 9.15 9.15 0 0 1 16.5 40.5"/>
                                    <rect x="88" y="13.84" width="16.5" height="40.32"/>
                                    <rect x="99" y="24.84" width="5.5" height="18.32"/>
                                    <circle cx="94" cy="34" r="0.5" fill="white"/>
                                    <path d="M 88 27.5 A 9.15 9.15 0 0 0 88 40.5"/>
                                </g>
                                <!-- Team labels -->
                                <text x="2" y="5" fill="white" font-size="3" font-weight="bold" opacity="0.7" text-anchor="start" font-family="Arial">${homeTeam.toUpperCase()}</text>
                                <text x="103" y="5" fill="white" font-size="3" font-weight="bold" opacity="0.7" text-anchor="end" font-family="Arial">${awayTeam.toUpperCase()}</text>
                                <!-- Shot markers -->
                                ${pdfShotMarkers}
                            </svg>
                        </div>
                        <div class="shot-map-legend">
                            <div class="legend-item">
                                <span class="legend-dot" style="background: ${homeColor};"></span>
                                <span>${homeTeam}</span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-dot" style="background: ${awayColor};"></span>
                                <span>${awayTeam}</span>
                            </div>
                            <div class="legend-item">
                                <svg width="14" height="14" viewBox="0 0 14 14" style="vertical-align: middle;">
                                    <circle cx="7" cy="7" r="5" fill="#6b7280" stroke="white" stroke-width="1"/>
                                    <text x="7" y="9.5" fill="white" font-size="6" text-anchor="middle" font-family="Arial"></text>
                                </svg>
                                <span>Goal</span>
                            </div>
                            <div class="legend-item">
                                <svg width="14" height="14" viewBox="0 0 14 14" style="vertical-align: middle;">
                                    <rect x="3" y="3" width="8" height="8" fill="#6b7280" stroke="white" stroke-width="1"/>
                                </svg>
                                <span>On Target</span>
                            </div>
                            <div class="legend-item">
                                <svg width="14" height="14" viewBox="0 0 14 14" style="vertical-align: middle;">
                                    <polygon points="7,2 2,12 12,12" fill="#6b7280" stroke="white" stroke-width="1"/>
                                </svg>
                                <span>Off Target</span>
                            </div>
                        </div>
                    </div>
                    ` : ''}

                    ${(game.notes && game.notes.length > 0) ? `
                    <div class="notes-section">
                        <h2>Game Notes</h2>
                        ${game.notes.map(note => `
                            <div class="note-item">
                                <span class="note-timestamp">${note.gameTime || note.timestamp || ''}</span>
                                <span class="note-text">${note.content || note.text || ''}</span>
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}

                    <div class="footer">
                        <div>Generated by Soccer Shot Tracker</div>
                        <div class="inspiration">This app inspired by Coach Adolpho</div>
                    </div>

                    <script>
                        window.onload = function() { window.print(); }
                    <\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        // Modal functions
        let modalCallback = null;

        function showModal(title, message, onConfirm) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            const overlay = document.getElementById('modal-overlay');
            overlay.classList.remove('hidden');
            overlay.classList.add('flex');

            const confirmBtn = document.getElementById('modal-confirm');
            if (onConfirm) {
                confirmBtn.style.display = 'block';
                modalCallback = onConfirm;
            } else {
                confirmBtn.style.display = 'none';
                modalCallback = null;
            }
        }

        window.closeModal = function() {
            const overlay = document.getElementById('modal-overlay');
            overlay.classList.add('hidden');
            overlay.classList.remove('flex');
            modalCallback = null;
        }

        document.getElementById('modal-confirm').addEventListener('click', function() {
            if (modalCallback) modalCallback();
        });

        document.getElementById('modal-overlay').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });
    </script>

    <script>
        // Fetch latest commit info from GitHub API
        fetch('https://api.github.com/repos/brookswest/soccer-shot-tracker/commits/main')
            .then(res => res.json())
            .then(data => {
                const version = data.sha.substring(0, 7); // Short hash
                const versionText = `v${version}`;
                const authVersion = document.getElementById('version-auth');
                const appVersion = document.getElementById('version-app');
                if (authVersion) authVersion.textContent = versionText;
                if (appVersion) appVersion.textContent = versionText;
            })
            .catch(() => {
                // Silently fail if GitHub API is unavailable
            });
    </script>
</body>
</html>
